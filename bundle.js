window.SOCKET_URL="ws://localhost:8080",window.INDEXEDDB_DATABASE_NAME="geneatree",window.INDEXEDDB_DATABASE_VERSION=1,function(e){"use strict";class t{constructor(e){this._observable=e}get observable(){return this._observable}}class i{constructor(e,t,i){this._observable=e,this._eventName=t,this._callback=i}remove(){this._observable.removeListener(this)}get eventName(){return this._eventName}get callback(){return this._callback}}class s{constructor(){this._listeners={}}listen(e,t,s=!1){Array.isArray(this._listeners[e])||(this._listeners[e]=[]);const n=new i(this,e,t);return s?this._listeners[e].unshift(n):this._listeners[e].push(n),n}removeListener(e){this._listeners[e.eventName]=this._listeners[e.eventName].filter((t=>t!==e))}emit(e,t){if(Array.isArray(this._listeners[e]))for(const i of this._listeners[e].slice())i.callback(t)}}class n{constructor(e,i=new t(new s)){this._identifier={},this._properties={...e},this._parent=null,this._root=null,this._model=null,this._children=[],this._listeners=[],this._eventListener=i}get identifier(){return this._identifier}get properties(){return this._properties}get root(){return this._root}get model(){return this._model}get eventListener(){return this._eventListener}listen(e,t,i,s=!1){const n=e.listen(t,i,s);return s?this._listeners.unshift(n):this._listeners.push(n),n}run(e,t){t.binding._parent=this,this._children.push(t.binding),t.binding._properties={...this.properties,...t.binding.properties},a.run(e,{parentNode:this.root,...t})}remove(){const e=this._listeners.slice();for(const t of e)t.remove();const t=this._children.slice();for(const e of t)e.remove();null!==this._parent&&(this._parent._children=this._parent._children.filter((e=>e!==this))),this.root.remove()}onCreated(){}async onRendered(){}}class r{static PROPERTIES=["tagName","children","identifier","model","binding","properties"];static METHOD={APPEND_CHILD:"APPEND_CHILD",INSERT_BEFORE:"INSERT_BEFORE",REPLACE_NODE:"REPLACE_NODE",WRAP_NODE:"WRAP_NODE",PREPEND:"PREPEND"};static run(e,{parentNode:t,binding:i=new n,method:s=r.METHOD.APPEND_CHILD}={}){const a=r.createNode(t,e,i);i._root=a,i._model=e;for(const e of Object.getOwnPropertyNames(Object.getPrototypeOf(i.eventListener)).filter((e=>"constructor"!==e&&"function"==typeof i.eventListener[e])))i.listen(i.eventListener.observable,e,i.eventListener[e].bind(i),!0);i.onCreated(),s===r.METHOD.APPEND_CHILD?t.appendChild(a):s===r.METHOD.INSERT_BEFORE?t.parentNode.insertBefore(a,t):s===r.METHOD.REPLACE_NODE?t.replaceWith(a):s===r.METHOD.WRAP_NODE?(a.appendChild(t.cloneNode(!0)),t.replaceWith(a)):s===r.METHOD.PREPEND&&t.prepend(a),i.onRendered()}static createNode(e,t,i){const{tagName:s,children:n=[]}=t,a=e.ownerDocument.createElement(s);Object.keys(t).filter((e=>!1===r.PROPERTIES.includes(e))).forEach((function(e){a[e]=t[e]}));for(const t of n)if(!0===Object.prototype.hasOwnProperty.call(t,"model")){let e;!0===Object.prototype.hasOwnProperty.call(t,"binding")&&(e=new t.binding({...i.properties,...t.properties}),!0===Object.prototype.hasOwnProperty.call(t,"identifier")&&(i.identifier[t.identifier]=e)),i.run(t.model,{parentNode:a,binding:e})}else{const s=r.createNode(e,t,i);a.appendChild(s)}return!0===Object.prototype.hasOwnProperty.call(t,"identifier")&&(i.identifier[t.identifier]=a),a}}var a=r;class d{constructor(e,t=n,i={}){this._definition=e,this._binding=t,this._properties=i}get definition(){return this._definition}get binding(){return this._binding}get properties(){return this._properties}}class o extends t{treeFilter(e){const{geneatree:t}=this.properties,i=t.trees.find(e);t.trees.list.filter((e=>!1===i.includes(e))).forEach((e=>e.emit("tabHide"))),i.forEach((e=>e.emit("tabShow"))),t.emit("treeFiltered",{trees:i,query:e}),1===i.length&&i[0]!==t.trees.selected?t.emit("treeSelect",i[0]):null!==t.trees.selected&&1!==i.length&&t.emit("treeUnselect",t.trees.selected)}treeFilterReset(){const{geneatree:e}=this.properties;this.identifier.input.value="",e.trees.forEach((e=>e.emit("tabShow")))}}var l=e=>({tagName:"div",className:"tree",tabIndex:0,children:[{tagName:"div",textContent:"🌲"},{tagName:"div",identifier:"name",style:"overflow: hidden",textContent:e.meta.name,title:e.meta.name},{tagName:"button",identifier:"editButton",className:"edit-icon",title:"Editer",textContent:"📝"}]});class c extends t{select(){this.root.classList.add("active")}unselect(){this.root.classList.remove("active")}update(){this.identifier.name.textContent=this.properties.tree.meta.name,this.identifier.name.title=this.properties.tree.meta.name}remove(){this.root.remove()}tabHide(){this.root.style.display="none"}tabShow(){this.root.style.display=""}}let h=class extends n{constructor(e){super(e,new c(e.tree))}onCreated(){const{geneatree:e,tree:t}=this.properties;this.root.addEventListener("focus",(()=>{e.trees.selected!==t&&e.trees.emit("select",t)})),this.identifier.editButton.addEventListener("click",(()=>e.router.emit("browse",{path:"/tree",properties:{tree:t}})))}};class p extends t{listAdd(e){const{geneatree:t}=this.properties;t.trees.list.length>1?this.run(l(e),{method:a.METHOD.PREPEND,parentNode:this.root,binding:new h({geneatree:t,tree:e})}):this.run(l(e),{parentNode:this.root,binding:new h({geneatree:t,tree:e})})}}var m={tagName:"div",id:"trees",children:[{tagName:"div",className:"logo",textContent:"geneatree"},{tagName:"div",identifier:"filterAdd",style:"display: grid; border-bottom: 1px solid #0000002b;",children:[{model:{tagName:"div",children:[{tagName:"input",className:"filter",identifier:"input",placeholder:"Filtrer trees"}]},binding:class extends n{constructor(e){super(e,new o(e.geneatree))}onCreated(){const{geneatree:e}=this.properties;this.identifier.input.addEventListener("input",(t=>{e.trees.list.length>=1&&e.emit("treeFilter",t.target.value)}))}}}]},{model:{tagName:"div",style:"overflow-y: auto; overflow-x: hidden;"},binding:class extends n{constructor(e){super(e,new p(e.geneatree.trees))}}}]};class u extends s{static TYPE={INFO:"info",WARNING:"warning",ERROR:"error",DEBUG:"debug"};constructor(e,t,i){super(),this._message=e,this._data=t,this._type=i,this._date=new Date}get message(){return this._message}get data(){return this._data}get type(){return this._type}get date(){return this._date}}class g extends t{add(e){const{geneatree:t}=this.properties;t.emit("log",{type:u.TYPE.DEBUG,message:"[ui] [tree] add",data:e});const i=t.trees.add(e[0].meta);"online"===e[0].type?i.networkId=e[0]._id:"offline"===e[0].type&&(i.offlineId=e[0].id);for(const[t,s]of e[1].entries()){const n=i.addIndividual({...s.meta,decujus:0===t});"online"===e[0].type?n.networkId=s._id:"offline"===e[0].type&&(n.offlineId=s.id),s.x&&(n.cellX=s.x),s.y&&(n.cellY=s.y),s.notes&&s.notes.forEach((t=>{const i=n.addNote(t.title,t.content,t.author,new Date(t.date));"online"===e[0].type?i.networkId=t._id:"offline"===e[0].type&&(i.offlineId=t.id)}))}t.trees.emit("listAdd",i),t.trees.emit("added",i)}update(e){const{geneatree:t}=this.properties;t.emit("log",{type:u.TYPE.DEBUG,message:"[ui] [tree] update",data:e});for(const t in e.form)e.tree.meta[t]=e.form[t];e.tree.emit("update"),t.trees.emit("updated",e)}remove(e){const{geneatree:t}=this.properties;t.emit("log",{type:u.TYPE.DEBUG,message:"[ui] [tree] remove",data:e}),t.trees.remove(e),e.emit("remove"),t.trees.emit("removed",e),t.router.emit("browse",{path:"/"})}select(e){const{geneatree:t}=this.properties;t.emit("log",{type:u.TYPE.DEBUG,message:"[ui] [tree] select",data:e}),null!==t.trees.selected&&t.trees.emit("unselect",t.trees.selected),t.trees.selected=e,e.emit("select"),t.trees.list.filter((t=>t!==e)).forEach((e=>e.emit("unselect"))),this.root.style.display="",t.trees.emit("selected",e),t.router.emit("browse",{path:"/viewer",properties:{tree:e}})}unselect(e){const{geneatree:t}=this.properties;t.emit("log",{type:u.TYPE.DEBUG,message:"[ui] [tree] unselect",data:e}),t.trees.selected.individuals.forEach((e=>e.emit("nodeRemove"))),t.trees.selected.selectedIndividual=null,t.trees.selected=null,e.emit("unselect"),e.individuals.forEach((e=>e.emit("nodeRemove"))),t.trees.emit("unselected",e)}toggle(e){const{geneatree:t}=this.properties;t.emit("log",{type:u.TYPE.DEBUG,message:"[ui] [tree] toggle",data:e}),!0===e.toggle?this.root.style.display="grid":this.root.style.display="none",t.trees.toggled=e.toggle}}var f=e=>({tagName:"button",identifier:"viewer",textContent:e.title});let v=class extends n{constructor(e){super(e)}onCreated(){const{path:e,geneatree:t}=this.properties;this.listen(t.router,"browse",(t=>{t.path===e?this.root.classList.add("active"):this.root.classList.remove("active")})),this.root.addEventListener("click",(()=>t.router.emit("browse",{path:e})))}};class N extends n{onCreated(){const{duration:e=3500}=this.properties;setTimeout((async()=>{let e=1;for(let t=0;t<10;t++)await new Promise((i=>{setTimeout((()=>{e-=.1,this.root.style.opacity=e,i()}),5*t)}));this.remove()}),e)}}var y={tagName:"div",id:"geneatree",children:[{model:m,binding:class extends n{constructor(e){super(e,new g(e.geneatree.trees))}onCreated(){this.properties}}},{tagName:"div",id:"router",identifier:"router",children:[{tagName:"button",title:"Afficher ou masquer la liste des trees",identifier:"treesToggle",id:"trees-toggle",textContent:"☰"},{model:{tagName:"nav",id:"navigation",children:[{tagName:"div",className:"items",identifier:"items"}]},identifier:"navigation",binding:class extends n{constructor(e){super(e)}browse(e){this.properties.geneatree.router.emit("browse",{path:e})}onCreated(){this.properties,this.run(f({title:"🏠 Home"}),{parentNode:this.identifier.items,binding:new v({path:"/"})}),this.run(f({title:"⚙️ Settings"}),{parentNode:this.identifier.items,binding:new v({path:"/settings"})}),this.run(f({title:"🪵 Logs"}),{parentNode:this.identifier.items,binding:new v({path:"/logs"})}),this.run(f({title:"ℹ️ About"}),{parentNode:this.identifier.items,binding:new v({path:"/about"})})}}}]},{model:{tagName:"div",id:"osd"},binding:class extends n{constructor(e){super(e)}onCreated(){const{geneatree:e}=this.properties;this.listen(e,"osdSet",(t=>{e.emit("log",{type:u.TYPE.DEBUG,message:"[ui] osdSet",data:t}),e.settings.osd&&this.run((e=>({tagName:"div",className:`message ${e.type}`,textContent:e.text}))(t),{method:a.METHOD.PREPEND,binding:new N({duration:t.duration})})}))}}}]};class w extends t{settingsSaved(){const e=`theme-${this.properties.geneatree.settings.theme}`;this.root.classList.contains(e)||(this.root.classList.remove(...x.map((e=>`theme-${e}`))),this.root.classList.add(e))}}const x=["white","pattern","dark"],b=["geneatree","GEDCOM","PNG"],E=["json"];class _ extends n{constructor(e){super(e,new w(e.geneatree))}onCreated(){const{geneatree:t}=this.properties;this.root.classList.add(`theme-${t.settings.theme}`),this.identifier.treesToggle.addEventListener("click",(()=>t.trees.emit("toggle",{toggle:!t.trees.toggled}))),this.listen(t.trees,"toggle",(e=>{!0===e.toggle?this.identifier.router.style.gridColumn="":this.identifier.router.style.gridColumn="span 2"})),this.listen(t.router,"browse",(e=>{"/viewer"===e.path?this.identifier.router.classList.add("viewer"):(t.trees.selected&&t.trees.emit("unselect",t.trees.selected),this.identifier.router.classList.remove("viewer"))})),this.listen(t.explorer,"dragStarted",(()=>{this.root.style.userSelect="none"})),this.listen(t.explorer,"dragEnded",(()=>{this.root.style.userSelect=""})),this.run(e.RouterModel,{method:a.METHOD.INSERT_BEFORE,parentNode:this.identifier.navigation.root,binding:new e.RouterBinding({router:t.router})})}}const I="SOCKET_STATE_CONNECTING",C="SOCKET_STATE_CONNECTED";function S(e){const{geneatree:t}=e;t.emit("osdSet",{text:"Connecting to remote...",type:"info"}),t.emit("log",{type:u.TYPE.INFO,message:"Connecting to remote..."}),t.emit("log",{type:u.TYPE.DEBUG,message:"[persistence:socket] Connecting..."}),t.socketState=I;const i=new WebSocket(window.SOCKET_URL),s=[],n={...e,socket:i,listeners:s};return(e=>{const{geneatree:t,socket:i,listeners:s}=e;s.push({query:"treeAdded",callback:e=>{const s=t.trees.list.find((t=>t.id===e.id));s.networkId=e.networkId,1===i.readyState&&i.send(JSON.stringify({query:"individualAdd",data:{id:s.individuals[0].id,tree:s.networkId,meta:s.individuals[0].meta,cellX:s.individuals[0].cellX,cellY:s.individuals[0].cellY}}))}}),t.trees.listen("added",(e=>{1===i.readyState&&-1===e.networkId&&-1===e.offlineId&&i.send(JSON.stringify({query:"treeAdd",data:{meta:e.meta,id:e.id}}))})),t.trees.listen("updated",(e=>{1===i.readyState&&i.send(JSON.stringify({query:"treeUpdate",data:{networkId:e.tree.networkId,form:e.form}}))})),t.trees.listen("removed",(e=>{1===i.readyState&&i.send(JSON.stringify({query:"treeRemove",data:{networkId:e.networkId}}))}))})(n),(e=>{const{geneatree:t,socket:i,listeners:s}=e;s.push({query:"individualAdded",callback:e=>{t.trees.list.find((t=>t.networkId===e.tree)).individuals.find((t=>t.id===e.id)).networkId=e.networkId}}),t.individuals.listen("added",(e=>{1===i.readyState&&-1===e.networkId&&-1===e.offlineId&&i.send(JSON.stringify({query:"individualAdd",data:{id:e.id,tree:e.tree.networkId,meta:e.meta,cellX:e.cellX,cellY:e.cellY}}))})),t.individuals.listen("updated",(e=>{1===i.readyState&&-1!==e.networkId&&i.send(JSON.stringify({query:"individualUpdate",data:{networkId:e.individual.networkId,form:e.form,tree:e.individual.tree.networkId}}))})),t.individuals.listen("removed",(e=>{1===i.readyState&&-1!==e.networkId&&i.send(JSON.stringify({query:"individualRemove",data:{networkId:e.networkId,tree:e.tree.networkId}}))}))})(n),(e=>{const{geneatree:t,socket:i,listeners:s}=e;s.push({query:"individualNotesAdded",callback:e=>{t.trees.list.find((t=>t.individuals.find((t=>t.networkId===e.individual)))).individuals.find((t=>t.networkId===e.individual)).notes.find((t=>t.id===e.id)).networkId=e.networkId}}),t.individuals.listen("notesAdded",(e=>{1===i.readyState&&-1===e.networkId&&-1===e.offlineId&&i.send(JSON.stringify({query:"individualNotesAdd",data:{id:e.id,individual:e.individual.networkId,title:e.title,content:e.content,author:e.author,date:e.date}}))})),t.individuals.listen("notesUpdated",(e=>{1===i.readyState&&-1!==e.networkId&&i.send(JSON.stringify({query:"individualNotesUpdate",data:{networkId:e.note.networkId,form:e.form}}))})),t.individuals.listen("notesRemoved",(e=>{1===i.readyState&&-1!==e.networkId&&i.send(JSON.stringify({query:"individualNotesRemove",data:{networkId:e.networkId}}))}))})(n),s.push({query:"load",callback:e=>{t.emit("osdSet",{text:"Connected to remote",type:"valid"});const i=s.findIndex((e=>"initialized"===e.query));s.splice(i,1);const n=e.trees.map((t=>(t.individuals=e.individuals.filter((e=>e.tree.toString()===t._id.toString())),t.individuals=t.individuals.map((t=>(t.notes=e.notes.filter((e=>e.individual.toString()===t._id.toString())),t))),t)));for(const e of n)e.individuals[0].networkId=e.individuals[0]._id,t.trees.emit("add",[{type:"online",_id:e._id,meta:e.meta},e.individuals]);t.emit("socketTLoaded")}}),i.addEventListener("message",(e=>{const{query:i,data:n}=JSON.parse(e.data);t.emit("log",{type:u.TYPE.DEBUG,message:`[persistence:socket] Received query: ${i}`,data:n});const r=s.filter((e=>e.query===i));r.length>=1?r.forEach((e=>e.callback(n))):t.emit("log",{type:u.TYPE.DEBUG,message:`[persistence:socket] Unrecognized query: ${i}`})})),i.addEventListener("open",(()=>{t.socketState=C,t.emit("log",{type:u.TYPE.INFO,message:"Connected to remote"}),t.emit("log",{type:u.TYPE.DEBUG,message:"[persistence:socket] Connected"})})),i.addEventListener("error",(e=>{t.emit("log",{type:u.TYPE.DEBUG,message:"[persistence:socket] An error occured",data:e}),t.socketState===C?(t.emit("log",{type:u.TYPE.ERROR,message:"Disconnected from remote"}),t.emit("osdSet",{text:"Disconnected from remote",type:"info"})):t.socketState===I&&(t.emit("log",{type:u.TYPE.ERROR,message:"Failed to connect to remote"}),t.emit("osdSet",{text:"Failed to connect to remote",type:"error"}))})),i.addEventListener("close",(()=>{t.socketState===C&&(t.emit("log",{type:u.TYPE.INFO,message:"Disconnected from remote"}),t.emit("log",{type:u.TYPE.DEBUG,message:"[persistence:socket] Disconnected"}),t.emit("osdSet",{text:"Connection to the server was terminated",type:"info"})),t.socketState="SOCKET_STATE_DISCONNECTED"})),i}var R=e=>({tagName:"div",id:"view-about",style:"display: grid; grid-gap: 10px",children:[{tagName:"div",className:"title",style:"display: grid; grid-template-columns: auto 1fr;grid-auto-columns: max-content;",children:[{tagName:"h3",identifier:"title",textContent:"geneatree v0.0.8"}]}]}),L=e=>({tagName:"div",id:"view-settings",children:[{tagName:"h3",identifier:"title",textContent:"Settings"},{tagName:"div",identifier:"tabs"}]}),T={tagName:"div",className:"steps",children:[{tagName:"div",className:"indicators",identifier:"indicators"},{tagName:"div",className:"steps",identifier:"steps"}]},A={tagName:"div",className:"step"},O=e=>({tagName:"div",className:"indicator",textContent:e.name});class k extends t{set(){this.root.classList.add("active")}unset(){this.root.classList.remove("active")}}class D extends n{constructor(e){super(e,new k(e.step))}onCreated(){const{step:e,steps:t}=this.properties;this.run(e.model,{binding:new e.binding(e.properties)})}}class P extends s{static STATE={INITIAL:"INITIAL",DRAFT:"DRAFT",COMPLETED:"COMPLETED"};constructor(e,t,i,s={}){super(),this._name=e,this._model=t,this._binding=i,this._properties=s,this._state=P.STATE.INITIAL,this._active=!1,this._data=null}get name(){return this._name}get model(){return this._model}get binding(){return this._binding}get properties(){return this._properties}get state(){return this._state}set state(e){this._state=e}get active(){return this._active}set active(e){this._active=e}get data(){return this._data}set data(e){this._data=e}}let B=class extends n{constructor(e){super(e)}onCreated(){const{step:e,steps:t}=this.properties;this.listen(e,"reset",(()=>{this.root.classList.remove("completed"),this.root.classList.remove("active"),this.root.classList.remove("draft")})),this.listen(e,"completed",(()=>{this.root.classList.add("completed"),this.root.classList.remove("draft")})),this.listen(e,"set",(()=>{this.root.classList.add("active"),e.state!==P.STATE.COMPLETED&&this.root.classList.add("draft")})),this.listen(e,"unset",(()=>{this.root.classList.remove("active")})),this.root.addEventListener("click",(()=>{e.state!==P.STATE.INITIAL&&t.emit("stepSet",e.name)}))}};class M extends t{reset(){const{steps:e}=this.properties;for(const t of e.steps)e.emit("stepReset",t.name);e.emit("stepSet",e.steps[0].name)}stepReset(e){const{steps:t}=this.properties,i=t.getStepByName(e);t.step===i&&t.emit("stepUnset",i.name),i.state=P.STATE.INITIAL,i.data=null,i.emit("reset")}stepSet(e){const{steps:t}=this.properties;t.step&&t.emit("stepUnset",t.step.name);const i=t.getStepByName(e);t.step=i,i.active=!0,t.step.state=P.STATE.DRAFT,i.emit("set"),t.emit("stepChanged",i)}stepUnset(e){const{steps:t}=this.properties,i=t.getStepByName(e);i.active=!1,i.emit("unset")}stepPrevious(){const{steps:e}=this.properties,t=e.getPreviousStep();t&&e.emit("stepSet",t.name)}stepNext(e){const{steps:t}=this.properties;t.step.data=e,t.step.state=P.STATE.COMPLETED,t.step.emit("completed");const i=t.getNextStep();i?t.emit("stepSet",i.name):t.emit("done")}}class U extends n{constructor(e){super(e,new M(e.steps))}onCreated(){const{steps:e}=this.properties;for(const t of e.steps)this.run(O(t),{parentNode:this.identifier.indicators,binding:new B({step:t})}),this.run(A,{parentNode:this.identifier.steps,binding:new D({step:t})})}}class q extends s{constructor(e){super(),this._steps=e,this._step=null}getStepByName(e){return this.steps.find((t=>t.name===e))}getPreviousStep(){if(null!==this.step){const e=this.steps.indexOf(this.step);if(e>=1)return this.steps[e-1]}return null}getNextStep(){if(null===this.step)return this.steps[0];{const e=this.steps.indexOf(this.step);if(e<this.steps.length-1)return this.steps[e+1]}return null}get steps(){return this._steps}get step(){return this._step}set step(e){this._step=e}}var Y=e=>({tagName:"form",className:"form",children:[e,{tagName:"div",className:"form-footer",children:[{tagName:"input",type:"reset"},{tagName:"input",type:"submit"}]}]});class F extends t{focus(){this.identifier[this.keys[0]].focus()}load(e){for(const t in e)if(t in this.identifier)if("INPUT"===this.identifier[t].tagName&&"checkbox"===this.identifier[t].type)this.identifier[t].checked=e[t]||!1;else if("INPUT"===this.identifier[t].tagName&&"radio"===this.identifier[t].type)[...this.root.querySelectorAll(`input[name=${this.identifier[t].name}]`)].find((i=>i.value==e[t])).checked=!0;else if("INPUT"===this.identifier[t].tagName&&"date"===this.identifier[t].type&&e[t]instanceof Date)this.identifier[t].valueAsDate=e[t];else if("SELECT"===this.identifier[t].tagName){let i;i="string"!=typeof e[t]?`${e[t]}`:e[t];for(const e of this.identifier[t].options)if(e.value===i){e.selected=!0;break}}else this.identifier[t].value=e[t]}clear(){for(const e in this.identifier)"INPUT"!==this.identifier[e].tagName||"checkbox"!==this.identifier[e].type&&"radio"!==this.identifier[e].type?"SELECT"===this.identifier[e].tagName?this.identifier[e].selectedIndex=0:(this.identifier[e].tagName,this.identifier[e].value=""):this.identifier[e].checked=!1}submit(){const{form:e}=this.properties,t={};for(const e of this.keys)if("INPUT"===this.identifier[e].tagName&&"checkbox"===this.identifier[e].type)t[e]=this.identifier[e].checked;else if("INPUT"===this.identifier[e].tagName&&"radio"===this.identifier[e].type){const i=this.root.querySelector(`input[name=${this.identifier[e].name}]:checked`);t[e]=i?i.value:null}else"INPUT"===this.identifier[e].tagName&&"file"===this.identifier[e].type?t[e]=this.identifier[e].files:t[e]=this.identifier[e].value;for(const e in t)if("false"===t[e])t[e]=!1;else if("true"===t[e])t[e]=!0;else{const i=parseFloat(t[e]);isNaN(i)||(t[e]=i)}e.emit("submitted",t)}}class G extends n{constructor(e){super(e,new F(e.form))}onCreated(){const{form:e}=this.properties;this.keys=Object.keys(this.identifier),this.root.addEventListener("submit",(t=>{t.preventDefault(),e.emit("submit")}))}}class j extends s{constructor(e){super(),this._initialData=e,this._data={}}get initialData(){return this._initialData}get data(){return this._data}}var $=e=>({tagName:"div",style:"display: contents",children:[{tagName:"h3",className:"title",textContent:e.title},{tagName:"div",children:[{tagName:"label",textContent:"Name:",children:[{tagName:"div",children:[{tagName:"input",required:!0,className:"width-100",identifier:"name"}]}]}]}]}),X=Y($({title:"Tree"}));class H extends G{constructor(e){super({...e,form:new j})}onCreated(){super.onCreated(),this.listen(this.properties.step,"set",(e=>{this.properties.form.emit("focus")})),this.listen(this.properties.form,"submitted",(e=>this.properties.steps.emit("stepNext",e)))}}var W=e=>({tagName:"div",style:"display: contents",children:[{tagName:"h3",className:"title",textContent:e.title},{tagName:"div",children:[{tagName:"label",textContent:"Birth name:",children:[{tagName:"div",children:[{identifier:"birthName",className:"width-100",tagName:"input"}]}]}]},{tagName:"div",children:[{tagName:"label",textContent:"First name:",children:[{tagName:"div",children:[{identifier:"firstName",className:"width-100",tagName:"input"}]}]}]},{tagName:"div",children:[{tagName:"label",textContent:"Last name:",children:[{tagName:"div",children:[{identifier:"lastName",className:"width-100",tagName:"input"}]}]}]},{tagName:"div",children:[{tagName:"label",textContent:"Gender:",children:[{tagName:"div",children:[{tagName:"select",className:"width-100",identifier:"gender",children:[{tagName:"option",textContent:"Inconnu",value:"unknown"},{tagName:"option",value:"man",style:"background-color: lightblue",textContent:"Homme"},{tagName:"option",value:"woman",style:"background-color: pink",textContent:"Femme"},{tagName:"option",value:"other",textContent:"Autre"}]}]}]}]},{tagName:"div",children:[{tagName:"label",textContent:"Birth date:",children:[{tagName:"div",children:[{tagName:"input",identifier:"birthDate",className:"width-100",type:"date"}]}]}]},{tagName:"div",children:[{tagName:"label",textContent:"Birth place:",children:[{tagName:"div",children:[{identifier:"birthPlace",className:"width-100",tagName:"input"}]}]}]},{tagName:"div",children:[{tagName:"label",textContent:"Death date",children:[{tagName:"div",children:[{tagName:"input",identifier:"deathDate",className:"width-100",type:"date"}]}]}]},{tagName:"div",children:[{tagName:"label",textContent:"Death place:",children:[{tagName:"div",children:[{identifier:"deathPlace",className:"width-100",tagName:"input"}]}]}]},{tagName:"div",children:[{tagName:"label",textContent:"Address:",children:[{tagName:"div",children:[{identifier:"address",className:"width-100",tagName:"input"}]}]}]},{tagName:"div",children:[{tagName:"label",textContent:"Work:",children:[{tagName:"div",children:[{identifier:"work",className:"width-100",tagName:"input"}]}]}]}]}),V=Y(W({title:"Decujus"}));class z extends G{constructor(e){super({...e,form:new j})}onCreated(){super.onCreated(),this.listen(this.properties.step,"set",(e=>{this.properties.form.emit("focus")})),this.listen(this.properties.form,"submitted",(e=>this.properties.steps.emit("stepNext",e)))}}class J extends n{onCreated(){const{geneatree:e}=this.properties,t=new q([new P("Tree",X,H),new P("Decujus",V,z)]);this.listen(t,"done",(()=>{e.trees.emit("add",[{meta:t.getStepByName("Tree").data},[{meta:t.getStepByName("Decujus").data}]]),e.trees.emit("select",e.trees.list[e.trees.list.length-1]),e.router.emit("browse",{path:"/"}),e.emit("osdSet",{text:"Tree created",type:"valid"})})),this.run(T,{binding:new U({steps:t})}),t.emit("stepSet","Tree")}}var K=e=>({tagName:"div",id:"view-add-tree"}),Z=e=>({tagName:"div",id:"view-new-tree",children:[{tagName:"h3",className:"title",identifier:"title",textContent:"Add tree"},{tagName:"div",style:"display: grid; grid-gap: 5px",children:[{tagName:"button",identifier:"createButton",tabIndex:1,textContent:"Create a new tree"},{tagName:"button",identifier:"importButton",tabIndex:2,textContent:"Import existing tree"}]}]});class Q extends n{onCreated(){const{geneatree:e}=this.properties;this.identifier.createButton.addEventListener("click",(()=>{e.router.emit("browse",{path:"/tree/add"})})),this.identifier.importButton.addEventListener("click",(()=>{e.router.emit("browse",{path:"/tree/import"})}))}}class ee{static NAME_LEVEL="level";static NAME_SEPARATOR="separator";static NAME_IDENTIFIER="identifier";static NAME_REFERENCE="reference";static NAME_INFORMATION="information";static NAME_LINE_FEED="line feed";constructor(e,t,i){this._name=e,this._buffer=t,this._index=i}get name(){return this._name}get buffer(){return this._buffer}get index(){return this._index}}const te="CURSOR_INITIAL",ie="CURSOR_LEVEL",se="CURSOR_TOKEN_SEPARATOR",ne="CURSOR_IDENTIFIER",re="CURSOR_REFERENCE",ae="CURSOR_INFORMATION",de="CURSOR_LINE_FEED",oe=" ",le=["\r","\n","\r\n","\n\r"],ce=[..."0123456789"];class he{constructor(e){this._name=e,this._value=null,this._parentRecord=null,this._records=[]}appendChild(e){e._parentRecord=this,this._records.push(e)}get name(){return this._name}get value(){return this._value}set value(e){this._value=e}get records(){return this._records}get parentRecord(){return this._parentRecord}}function pe(e){const t=function(e){const t=[...e],i=[];let s=te,n=null;const r=[];let a="",d=null;for(const[e,o]of t.entries()){a+=o,null!==n&&(s=n);let l=null;if(e+1<=t.length-1&&(l=t[e+1]),null===l)n=null;else if(l!==oe||s===ae||s===se&&r.find((e=>e.name===ee.NAME_IDENTIFIER)))if(le.includes(l))n=de;else if(s===te||s===se&&!r.find((e=>e.name===ee.NAME_LEVEL)))n=ie;else if(s===se){let i="";for(const s of t.slice(e+1)){if(s===oe||le.includes(s))break;i+=s}n="@"===i.slice(0,1)&&"@"===i.slice(-1)?re:r.find((e=>e.name===ee.NAME_IDENTIFIER))?ae:ne}else s===ne||s===re?l===oe&&(n=se):s===de&&(n=ie);else n=se;if((s===te||s===ie)&&a.trim().length>=1&&n===se){let i="";for(const s of t.slice(e+1)){if(le.includes(s))break;s!==oe&&(i+=s)}[...a.trimStart()].filter((e=>ce.includes(e))).length===a.trimStart().length&&i.length>=1?d=new ee(ee.NAME_LEVEL,a.trimStart(),e-a.trimStart().length+1):a=""}else s===se&&a===oe?r.length>=1&&(0===i.length||i[i.length-1].name!==ee.NAME_SEPARATOR)&&r.length<5&&null!==l&&!le.includes(l)?d=new ee(ee.NAME_SEPARATOR,o,e):a="":s===ne&&n!==ne?r.length>=2&&r.length<5?d=new ee(ee.NAME_IDENTIFIER,a.trim(),e-a.length+1):a="":s===re&&n!==re?r.length>=2&&r.length<5&&"@"===a.slice(0,1)&&"@"===a.slice(-1)?d=new ee(ee.NAME_REFERENCE,a.trim(),e-a.length+1):a="":s!==ae||n===ae&&null!==l?s===de&&(!le.includes(a)||0!==i.length&&i[i.length-1].name===ee.NAME_LINE_FEED?a="":d=new ee(ee.NAME_LINE_FEED,a,e)):r.length>=3&&r.length<5?d=new ee(ee.NAME_INFORMATION,a,e-a.length+1):a="";null!==d&&(i.push(d),r.push(d),d=null,a=""),s===de&&r.splice(0,r.length)}return i}(e),i=[],s=[];for(const[e,n]of t.entries())"separator"!==n.name&&"line feed"!==n.name&&s.push(n),"line feed"!==n.name&&e!==t.length-1||(i.push([...s]),s.splice(0,s.length));return i}var me=Y({tagName:"div",style:"display: contents",children:[{tagName:"h3",textContent:"Import a file",className:"title"},{tagName:"div",children:[{tagName:"label",textContent:"Format:",children:[{tagName:"div",children:[{tagName:"select",style:"width: 100%",identifier:"format",required:!0,children:["geneatree","GEDCOM"].map((e=>({tagName:"option",textContent:e,value:e})))}]}]}]},{tagName:"div",children:[{tagName:"label",textContent:"File:",children:[{tagName:"div",children:[{tagName:"input",required:!0,accept:".GED",type:"file",style:"width: 100%",identifier:"file"}]}]}]}]});class ue extends G{constructor(e){super({...e,form:new j})}onCreated(){super.onCreated(),this.listen(this.properties.step,"set",(e=>{this.properties.form.emit("focus")})),this.listen(this.properties.form,"submitted",(e=>this.properties.steps.emit("stepNext",e))),this.identifier.format.addEventListener("change",(e=>{"GEDCOM"===e.target.value?this.identifier.file.accept=".GED":"geneatree"===e.target.value&&(this.identifier.file.accept=".json")}))}}var ge=Y($({title:"Tree"}));class fe extends G{constructor(e){super({...e,form:new j})}onCreated(){super.onCreated(),this.listen(this.properties.step,"set",(e=>{this.properties.form.emit("focus")})),this.listen(this.properties.form,"submitted",(e=>this.properties.steps.emit("stepNext",e)))}}class ve extends n{onCreated(){this.properties;const e=new q([new P("Fichier",me,ue),new P("Tree",ge,fe)]);this.listen(e,"done",(()=>{console.log(e.getStepByName("Fichier").data),console.log(function(e){const t=pe(e),i=[],s=[];for(const e of t){const t=parseInt(e[0].buffer),i=new he(e[1].buffer);3===e.length&&(i.value=e[2].buffer),s.push({level:t,record:i})}for(const[e,t]of s.entries())if(0===t.level)i.push(t.record);else{const i=s.slice(0,e);i.reverse();const n=i.find((e=>e.level===t.level-1));n&&n.record.appendChild(t.record)}return i}(e.getStepByName("Fichier").data))})),this.run(T,{binding:new U({steps:e})}),e.emit("stepSet","Fichier")}}var Ne=e=>({tagName:"div",id:"view-import-tree"}),ye={tagName:"div",className:"tabs",children:[{tagName:"div",className:"indicators",identifier:"indicators"},{tagName:"div",className:"tabs",identifier:"tabs"}]},we=e=>({tagName:"div",className:"indicator",textContent:e.name}),xe={tagName:"div",className:"tab"};class be extends n{constructor(e){super(e)}onCreated(){const{tab:e,tabs:t}=this.properties;this.listen(e,"set",(()=>{this.root.classList.add("active")})),this.listen(e,"unset",(()=>{this.root.classList.remove("active")})),this.root.addEventListener("click",(()=>{t.emit("tabSet",e.name)}))}}class Ee extends t{set(){this.root.classList.add("active")}unset(){this.root.classList.remove("active")}}class _e extends n{constructor(e){super(e,new Ee(e.tab))}onCreated(){const{tab:e}=this.properties;this.run(e.model,{binding:new e.binding(e.properties)})}}class Ie extends s{constructor(e,t,i,s={}){super(),this._name=e,this._model=t,this._binding=i,this._properties=s,this._active=!1}get name(){return this._name}get model(){return this._model}get binding(){return this._binding}get properties(){return this._properties}get active(){return this._active}set active(e){this._active=e}}class Ce extends t{tabSet(e){const{tabs:t}=this.properties;t.tab&&t.emit("tabUnset",t.tab.name);const i=t.getTabByName(e);t.tab=i,i.active=!0,i.emit("set"),t.emit("tabChanged",i)}tabUnset(e){const{tabs:t}=this.properties,i=t.getTabByName(e);i.active=!1,t.tab=null,i.emit("unset")}}class Se extends n{constructor(e){super(e,new Ce(e.tabs))}onCreated(){const{tabs:e}=this.properties;for(const t of e.tabs)this.run(we(t),{parentNode:this.identifier.indicators,binding:new be({tab:t})}),this.run(xe,{parentNode:this.identifier.tabs,binding:new _e({tab:t})})}}class Re extends s{constructor(e){super(),this._tabs=e,this._tab=null}getTabByName(e){return this.tabs.find((t=>t.name===e))}get tabs(){return this._tabs}get tab(){return this._tab}set tab(e){this._tab=e}}var Le=Y($({title:"Modifier un arbre"})),Te={tagName:"div",style:"display: grid; grid-gap: 20px",children:[{tagName:"div",className:"title",style:"display: grid;grid-template-columns: auto 1fr;grid-auto-columns: max-content;",children:[{tagName:"h3",identifier:"title",textContent:"Actions"}]},{tagName:"div",identifier:"body"}]},Ae={tagName:"div",className:"tab-individuals",style:"display: grid; grid-gap: 20px",children:[{tagName:"h3",className:"title",identifier:"title",textContent:"Liste des individus"},{tagName:"div",style:"display: grid; grid-gap: 20px;",children:[{tagName:"input",identifier:"searchInput",placeholder:"Filtrer les individus"},{tagName:"div",style:"display: none; text-align: center;",identifier:"placeholder",textContent:"Aucun résultats."},{tagName:"div",className:"grid-gap",style:"display: none;",identifier:"list"}]}]};class Oe extends G{constructor(e){super({...e,form:new j})}onCreated(){const{geneatree:e,tree:t}=this.properties;super.onCreated(),this.listen(this.properties.tab,"set",(e=>{this.properties.form.emit("load",this.properties.tree.meta),this.properties.form.emit("focus")})),this.listen(this.properties.form,"submitted",(i=>{e.trees.emit("update",{tree:t,form:i}),e.emit("osdSet",{text:"Tree updated",type:"valid"})}))}}var ke=e=>({tagName:"div",style:"display: grid; grid-gap: 5px; background-color: #b29e9e; padding: 10px;",children:[{tagName:"button",identifier:"export",textContent:"Exporter"},{tagName:"button",className:"button-danger",identifier:"delete",textContent:"Supprimer"}]});class De extends n{onCreated(){const{geneatree:e,router:t,tree:i}=this.properties;this.identifier.export.addEventListener("click",(()=>{t.emit("browse",{path:"/export"})})),this.identifier.delete.addEventListener("click",(()=>{e.trees.emit("remove",i),e.emit("osdSet",{text:"Tree removed",type:"valid"})}))}}var Pe=e=>Y({tagName:"div",style:"display: contents",children:[{tagName:"label",textContent:"Format",children:[{tagName:"div",children:[{tagName:"select",style:"width: 100%",identifier:"format",children:b.map((e=>({tagName:"option",textContent:e})))}]}]}]});class Be extends G{constructor(e){super({...e,form:new j})}onCreated(){super.onCreated(),this.properties,this.listen(this.properties.form,"submitted",(e=>{console.log(e)}))}}class Me extends n{onCreated(){const{geneatree:t,tab:i}=this.properties,s=new e.Router({routes:[new e.Route({match:"/",model:new d(ke,De)}),new e.Route({match:"/export",model:new d(Pe,Be)})]});this.listen(i,"set",(()=>{s.emit("browse",{path:"/"})})),this.run(e.RouterModel,{binding:new e.RouterBinding({router:s}),parentNode:this.identifier.body})}}class Ue extends t{previous(){const{paginator:e}=this.properties;e.emit("offsetSet",e.getPreviousOffset())}next(){const{paginator:e}=this.properties;e.emit("offsetSet",e.getNextOffset())}}var qe={tagName:"div",className:"paginator",children:[{tagName:"div",className:"pagination-content",identifier:"content"},{model:{tagName:"div",className:"pagination-controls",children:[{tagName:"button",className:"pagination-previous",textContent:"←",disabled:!0,identifier:"previous"},{tagName:"div",className:"pagination-indicator",children:[{tagName:"input",type:"number",min:1,value:1,identifier:"jump",className:"pagination-jump"},{tagName:"span",identifier:"totalPages"}]},{tagName:"button",className:"pagination-next",textContent:"→",disabled:!0,identifier:"next"}]},binding:class extends n{constructor(e){super(e,new Ue(e.paginator.controls))}onCreated(){const{paginator:e}=this.properties;this.listen(e,"itemsChanged",(()=>{e.getMaximumOffset();const t=e.getMaximumPage();this.identifier.totalPages.textContent=`/ ${t}`})),this.listen(e,"offsetChanged",(()=>{const t=e.getMaximumOffset();0===e.offset?this.identifier.previous.disabled=!0:e.offset>0&&(this.identifier.previous.disabled=!1),e.offset===t?this.identifier.next.disabled=!0:t>0&&(this.identifier.next.disabled=!1);const i=e.getCurrentPage();this.identifier.jump.value!==i&&(this.identifier.jump.value=i)})),this.identifier.previous.addEventListener("click",(()=>e.controls.emit("previous"))),this.identifier.next.addEventListener("click",(()=>e.controls.emit("next"))),this.identifier.jump.addEventListener("input",(t=>{const i=e.getMaximumPage();t.target.value<=0?this.identifier.jump.value=1:t.target.value>i&&(this.identifier.jump.value=i);const s=e.getOffsetByPage(parseInt(this.identifier.jump.value));e.emit("offsetSet",s)}))}},identifier:"controls"}]};class Ye extends s{}class Fe extends t{itemsSet(e){const{paginator:t}=this.properties;t._items=e.slice(),t.emit("offsetReset"),t.emit("itemsChanged")}offsetSet(e){const{paginator:t}=this.properties;null!==t.page&&t.page.emit("clear"),e<t.limit?e=0:e>t.items.length-1?e=t.getMaximumOffset():e%t.limit!=0&&(e=t.getNearestOffset(e)),t.offset=e;const i=new Ye;for(const e of t.getCurrentItems())this.run(e.model(e.properties),{parentNode:this.identifier.content,binding:new e.binding({...e.properties,item:e,page:i})});t.page=i,t.emit("offsetChanged",e)}offsetReset(){const{paginator:e}=this.properties;e.emit("offsetSet",0)}}class Ge extends n{constructor(e){super(e,new Fe(e.paginator))}}class je extends n{constructor(e){super(e)}onCreated(){const{page:e}=this.properties;this.listen(e,"clear",(()=>{this.remove()}))}}class $e extends s{constructor(e){super(),this._items=[],this._limit=e,this._offset=0,this._page=null,this._controls=new s}getCurrentItems(){return this.items.slice(this.offset,Math.min(this.items.length,this.offset+this.limit))}getNextItems(){const e=this.getNextOffset();return this.items.slice(e,Math.min(this.items.length,e+this.limit))}getPreviousItems(){const e=this.getPreviousOffset();return this.items.slice(e,Math.min(this.items.length,e+this.limit))}getItemsByOffset(e){return this.items.slice(e,Math.min(this.items.length,e+this.limit))}getMaximumOffset(){const e=Math.max(0,this.items.length-this.limit);return this.getNearestOffset(e)}getMaximumPage(){return Math.ceil(this.items.length/this.limit)}getCurrentPage(){return Math.floor((this.offset+this.limit)/this.limit)}getPageByOffset(e){return Math.ceil((e+this.limit)/this.limit)}getOffsetByPage(e){return e*this.limit-this.limit}getPreviousOffset(){return Math.max(0,this.offset-this.limit)}getNextOffset(){const e=this.getMaximumOffset();return Math.min(e,this.offset+this.limit)}getNearestOffset(e){return this.limit*Math.ceil(e/this.limit)}get controls(){return this._controls}get items(){return this._items}get limit(){return this._limit}get offset(){return this._offset}set offset(e){this._offset=e}get page(){return this._page}set page(e){this._page=e}}var Xe=e=>({tagName:"div",className:`individual ${e.individual.meta.gender} ${e.individual.meta.decujus?"decujus":""}`,style:"display: grid",title:"Selectionner cet individu",children:[{tagName:"h4",textContent:e.individual.meta.birthName},{tagName:"div",children:[{tagName:"div",textContent:[e.individual.meta.firstName,e.individual.meta.lastName].join(" ")}]}]});let He=class extends je{onCreated(){super.onCreated(this.properties),this.properties}};class We extends n{onCreated(){this.paginator=new $e(3),this.identifier.searchInput.addEventListener("input",(()=>this.render())),this.run(qe,{parentNode:this.identifier.list,binding:new Ge({paginator:this.paginator,maxShownPages:3})}),this.render()}render(){const e=this.properties.tree.findIndividuals({query:this.identifier.searchInput.value});0===e.length?(this.identifier.placeholder.style.display="",this.identifier.list.style.display="none"):(this.identifier.placeholder.style.display="none",this.identifier.list.style.display="grid",this.paginator.emit("itemsSet",e.map((e=>({model:Xe,binding:He,properties:{individual:e}})))))}}class Ve extends n{onCreated(){this.properties,this.individualForm=new j;const e=new Re([new Ie("Editer",Le,Oe),new Ie("Individus",Ae,We),new Ie("Actions",Te,Me)]);this.run(ye,{binding:new Se({tabs:e})}),e.emit("tabSet","Editer")}}var ze=e=>({tagName:"div",id:"view-tree"}),Je=e=>({tagName:"div",id:"view-logs",children:[{tagName:"h3",identifier:"title",textContent:"Logs"},{tagName:"div",identifier:"router"}]}),Ke={tagName:"div",id:"tree-viewer-explorer"};var Ze={tagName:"div"};class Qe extends n{onCreated(){this.properties}}var et={tagName:"div",title:"Cliquer pour naviguer",className:"map",children:[{model:{tagName:"div",className:"individuals"},binding:class extends n{constructor(e){super(e)}onCreated(){const{geneatree:e}=this.properties;this.listen(e,"treeViewerMinimapCoordinatesUpdated",(e=>{this.root.style.left=e.cursorX+"px",this.root.style.top=e.cursorY+"px"})),this.run(Ze,{parentNode:this.root,binding:new Qe({})})}}},{model:{tagName:"div",identifier:"cursor",className:"cursor"},binding:class extends n{constructor(e){super(e)}onCreated(){const{geneatree:e}=this.properties;this.listen(e,"treeViewerCoordinatesUpdated",(t=>{const i=t.x/this.root.parentNode.parentNode.parentNode.offsetWidth*100,s=t.y/this.root.parentNode.parentNode.parentNode.offsetHeight*100,n=1*i,r=.5*s;this.root.style.left=n+"px",this.root.style.top=r+"px",e.emit("treeViewerMinimapCoordinatesUpdated",{xPercent:i,yPercent:s,cursorY:r,cursorX:n})}))}}}]};var tt={tagName:"div",id:"tree-viewer-minimap",children:[{model:et,binding:class extends n{constructor(e){super(e)}getViewerPosition(e,t){const i=this.root.getBoundingClientRect(),s=(e-i.x)/100*100,n=(t-i.y)/50*100;return{x:this.root.parentNode.parentNode.offsetWidth/100*s,y:this.root.parentNode.parentNode.offsetHeight/100*n}}onCreated(){const{geneatree:e}=this.properties;let t=!1;this.root.addEventListener("click",(t=>{const i=this.getViewerPosition(t.clientX,t.clientY);e.explorer.emit("dragUpdate",{x:i.x,y:i.y})})),this.root.addEventListener("mousedown",(()=>{this.root.style.cursor="grabbing",t=!0})),this.root.addEventListener("mouseup",(()=>{this.root.style.cursor="",t=!1})),this.root.addEventListener("mousemove",(i=>{if(t){const t=this.getViewerPosition(i.clientX,i.clientY);e.explorer.emit("dragUpdate",{x:t.x,y:t.y})}}))}}},{model:{tagName:"div",className:"information",children:[{tagName:"div",identifier:"scale"},{tagName:"div",identifier:"coordinates"}]},binding:class extends n{constructor(e){super(e)}onCreated(){const{geneatree:e}=this.properties;this.listen(e,"treeViewerCoordinatesUpdated",(e=>{this.identifier.coordinates.textContent=`${parseInt(e.x)}, ${parseInt(e.y)}`})),this.listen(e,"treeViewerScaleUpdated",(e=>{this.identifier.scale.textContent=`x${parseFloat(e).toFixed(2)}`}))}}}]};class it extends t{select(){this.root.classList.add("selected")}unselect(){this.root.classList.remove("selected")}update(){for(const e in individual.meta)"gender"===e?(this.identifier.self.classList.remove("unknown","man","woman","other"),this.identifier.self.classList.add(individual.meta[e])):e in this.identifier&&(this.identifier[e].textContent=individual.meta[e]);this.identifier.name.textContent=[individual.meta.firstName,individual.meta.lastName].join(" "),this.identifier.birth.textContent=(individual.meta.birthDate||individual.meta.birthPlace)&&`° ${individual.meta.birthDate||"???"} (${individual.meta.birthPlace||"???"}`,this.identifier.death.textContent=(individual.meta.deathDate||individual.meta.deathPlace)&&`+ ${individual.meta.deathDate||"???"} (${individual.meta.deathPlace||"???"}`}remove(){this.properties.tree.selectedIndividual===individual&&this.properties.tree.individuals.filter((e=>e!==individual)).forEach((e=>e.emit("nodeShow"))),this.root.remove()}nodeRemove(){this.root.remove()}nodeShow(){this.root.style.visibility=""}nodeHide(){this.root.style.visibility="hidden"}nodeFocus(){this.identifier.self.focus()}nodeAnimate(){let e=100;this.root.style.filter=`sepia(${e}%)`;for(let t=0;t<40;t++)setTimeout((()=>{e-=2.5,this.root.style.filter=`sepia(${e}%)`}),50*t)}}let st=class extends n{constructor(e){super(e,new it(e.individual))}onCreated(){const{geneatree:e,individual:t,tree:i}=this.properties;this.identifier.self.addEventListener("click",(()=>{i.selectedIndividual===t?e.router.emit("browse",{path:"/tree/individual",properties:{individual:t}}):e.individuals.emit("select",t)})),this.identifier.addParent.addEventListener("click",(()=>e.router.emit("browse",{path:"/tree/add-parent",properties:{individual:i.selectedIndividual}}))),this.identifier.addSpouse.addEventListener("click",(()=>e.router.emit("browse",{path:"/tree/add-spouse",properties:{individual:i.selectedIndividual}}))),this.identifier.addChild.addEventListener("click",(()=>e.router.emit("browse",{path:"/tree/add-child",properties:{individual:i.selectedIndividual}})))}async onRendered(){const{geneatree:e,individual:t,tree:i}=this.properties;this.listen(t,"nodeCenter",(()=>{const t=this.root.getBoundingClientRect(),s=Math.abs(i.viewer.x-t.x),n=Math.abs(i.viewer.y-t.y);e.emit("treeViewerFocus",{x:s,y:n})}))}};var nt={tagName:"div",id:"tree-viewer-individuals",style:"position: absolute",children:[{tagName:"div",identifier:"focusOne",tabIndex:0},{model:{tagName:"div"},binding:class extends n{onCreated(){const{tree:e}=this.properties;for(const i of e.individuals)this.run({tagName:"div",className:"individual",children:[{tagName:"div",identifier:"self",style:"width: 160px; height: 80px;",className:`self ${(t=i).meta.gender} ${t.meta.decujus?"decujus":""}`,tabIndex:0,children:[{identifier:"birthName",tagName:"h3",style:"font-variant: all-small-caps;",textContent:t.meta.birthName},{tagName:"div",className:"name",identifier:"name",textContent:[t.meta.firstName,t.meta.lastName].join(" ")},{tagName:"div",identifier:"birth",className:"birth",textContent:(t.meta.birthDate||t.meta.birthPlace)&&`° ${t.meta.birthDate||"???"} (${t.meta.birthPlace||"???"})`},{tagName:"div",identifier:"death",className:"death",textContent:(t.meta.deathDate||t.meta.deathPlace)&&`+ ${t.meta.deathDate||"???"} (${t.meta.deathPlace||"???"})`}]},{tagName:"div",identifier:"addParent",className:"placeholder",style:" width: 160px; height: 80px; grid-row: 1;",textContent:"Add father"},{tagName:"div",identifier:"addSpouse",className:"placeholder",style:" width: 160px; height: 80px;",textContent:"Add spouse"},{tagName:"div",identifier:"addChild",className:"placeholder",style:" width: 160px; height: 80px;",textContent:"Add child"}]},{binding:new st({individual:i})});var t;e.individuals[0].emit("nodeCenter")}}},{tagName:"div",identifier:"focusTwo",tabIndex:0}]};class rt extends n{constructor(e){super(e)}}class at extends t{dragStart(e){const{geneatree:t,tree:i}=this.properties;t.emit("log",{type:u.TYPE.DEBUG,message:"[ui] [viewer] [explorer] drag start"}),i.viewer.dragging.clientX=e.clientX,i.viewer.dragging.clientY=e.clientY,i.viewer.dragging.started=!0}dragUpdate(e){const{geneatree:t}=this.properties;t.emit("log",{type:u.TYPE.DEBUG,message:"[ui] [viewer] [explorer] drag update"}),t.explorer.emit("coordinatesSet",{x:e.x,y:e.y})}dragEnd(){const{geneatree:e,tree:t}=this.properties;e.emit("log",{type:u.TYPE.DEBUG,message:"[ui] [viewer] [explorer] drag end"}),t.viewer.dragging.clientX=null,t.viewer.dragging.clientY=null,t.viewer.dragging.moved=!1,t.viewer.dragging.started=!1}dragReset(){const{geneatree:e,tree:t}=this.properties;e.emit("log",{type:u.TYPE.DEBUG,message:"[ui] [viewer] [explorer] drag reset"}),t.viewer.dragging.clientX=null,t.viewer.dragging.clientY=null,t.viewer.dragging.moved=!1,t.viewer.dragging.started=!1,e.explorer.emit("coordinatesSet",{x:this.root.parentNode.offsetWidth/2,y:this.root.parentNode.offsetHeight/2})}dragToggle(e){const{tree:t}=this.properties;t.viewer.dragging.toggled=e}coordinatesSet(e){const{geneatree:t,tree:i}=this.properties;t.emit("log",{type:u.TYPE.DEBUG,message:"[ui] [viewer] [explorer] coordinatesSet"}),null!==i&&(i.viewer.x=e.x,i.viewer.y=e.y)}zoom(e){const{geneatree:t}=this.properties;t.emit("log",{type:u.TYPE.DEBUG,message:"[ui] [viewer] [explorer] zoom"}),t.explorer.emit("scale set",e)}scaleSet(e){const{geneatree:t,tree:i}=this.properties;t.emit("log",{type:u.TYPE.DEBUG,message:"[ui] [viewer] [explorer] scale set"}),i.viewer.scale=e}scaleReset(){const{geneatree:e}=this.properties;e.emit("log",{type:u.TYPE.DEBUG,message:"[ui] [viewer] [explorer] scale reset"}),e.explorer.emit("scale set",1)}focus(e){const{geneatree:t}=this.properties;t.emit("log",{type:u.TYPE.DEBUG,message:"[ui] [viewer] [explorer] focus"});const i=this.root.getBoundingClientRect();let s=e.x-i.x,n=e.y-i.y;const r=this.root.parentNode.offsetWidth/2-s,a=this.root.parentNode.offsetHeight/2-n;t.explorer.emit("coordinatesSet",{x:r,y:a})}resized(e){const{geneatree:t,tree:i}=this.properties;i.viewer.x=e.width/2,i.viewer.y=e.height/2,t.explorer.emit("coordinatesSet",{x:i.viewer.x,y:i.viewer.y})}boot(){const{geneatree:e,tree:t}=this.properties;e.explorer.emit("coordinatesSet",{x:t.viewer.x,y:t.viewer.y}),e.explorer.emit("scaleSet",t.viewer.scale),e.explorer.emit("booted")}}class dt extends n{constructor(e){super(e,new at(e.geneatree.explorer))}onCreated(){const{geneatree:e,tree:t}=this.properties;this.root.addEventListener("mousemove",(i=>{if(t.viewer.dragging.started){const{clientX:s,clientY:n}=i,r=Math.abs(s-t.viewer.dragging.clientX),a=Math.abs(n-t.viewer.dragging.clientY);let d=parseInt(t.viewer.x)||0,o=parseInt(t.viewer.y)||0;s>t.viewer.dragging.clientX?d+=r:s<t.viewer.dragging.clientX&&(d-=r),n>t.viewer.dragging.clientY?o+=a:n<t.viewer.dragging.clientY&&(o-=a),t.viewer.dragging.clientX=i.clientX,t.viewer.dragging.clientY=i.clientY,t.viewer.dragging.moved=!0,e.explorer.emit("dragUpdate",{x:d,y:o})}})),this.root.addEventListener("resize",(()=>{t.individuals.length>=1&&e.explorer.emit("dragReset")})),this.root.addEventListener("mouseup",(i=>{null!==t&&(1===i.button?(e.explorer.emit("dragReset"),e.explorer.emit("scaleReset")):0!==i.button||t.viewer.dragging.moved||null===t.selectedIndividual||i.target!==this.root||e.individuals.emit("unselect",t.selectedIndividual)),t.viewer.dragging.started&&e.explorer.emit("dragEnd")})),this.root.addEventListener("mousedown",(i=>{0===i.button&&t.individuals.length>=1&&(i.target.contains(this.root)||i.target.contains(this.root))&&t.viewer.dragging.toggled&&e.explorer.emit("dragStart",{clientX:i.clientX,clientY:i.clientY})})),this.root.addEventListener("wheel",(i=>{const s=Math.sign(i.deltaY);if(t.individuals.length>=1){let i=t.viewer.scale+-.05*s;i=Math.min(Math.max(.125,i),4),e.explorer.emit("zoom",i)}}))}}class ot extends t{select(e){this.properties.geneatree.emit("log",{type:u.TYPE.DEBUG,message:"[ui] individualSelect",data:e}),null!==this.properties.tree.selectedIndividual&&this.properties.geneatree.individuals.emit("unselect",this.properties.tree.selectedIndividual),this.properties.tree.selectedIndividual=e,e.emit("select"),this.properties.tree.individuals.filter((t=>t!==e)).forEach((e=>e.emit("nodeHide"))),this.properties.geneatree.explorer.emit("dragToggle",!1),this.properties.geneatree.individuals.emit("selected",e)}unselect(e){this.properties.geneatree.emit("log",{type:u.TYPE.DEBUG,message:"[ui] unselect",data:e}),e.tree.selectedIndividual=null,e.emit("unselect"),e.tree.individuals.filter((t=>t!==e)).forEach((e=>e.emit("nodeShow"))),this.properties.geneatree.explorer.emit("dragToggle",!0),this.properties.geneatree.individuals.emit("unselected",e)}update(e){this.properties.geneatree.emit("log",{type:u.TYPE.DEBUG,message:"[ui] individualUpdate",data:e}),e.individual.update(e.form),e.individual.emit("update"),this.properties.geneatree.individuals.emit("updated",e)}remove(e){this.properties.geneatree.emit("log",{type:u.TYPE.DEBUG,message:"[ui] individualRemove",data:e}),e.tree.removeIndividual(e),e.emit("remove"),0===e.tree.individuals.length&&(this.root.style.cursor="",this.properties.geneatree.explorer.emit("dragReset")),this.properties.geneatree.individuals.emit("removed",e)}notesAdd(e){console.log(e),this.properties.geneatree.emit("log",{type:u.TYPE.DEBUG,message:"[ui] individualNotesAdd",data:e});const{title:t,content:i,author:s}=e.form,n=e.individual.addNote(t,i,s,new Date);this.properties.geneatree.individuals.emit("notesAdded",n)}notesUpdate(e){this.properties.geneatree.emit("log",{type:u.TYPE.DEBUG,message:"[ui] individualNotesUpdate",data:e}),e.note.update(e.form),e.note.emit("update"),this.properties.geneatree.individuals.emit("notesUpdated",e)}notesRemove(e){this.properties.geneatree.emit("log",{type:u.TYPE.DEBUG,message:"[ui] individualNotesRemove ",data:e}),e.individual.removeNote(e),e.emit("remove"),this.properties.geneatree.individuals.emit("notesRemoved",e)}}class lt extends n{constructor(e){super(e,new ot(e.geneatree.individuals))}onCreated(){const{geneatree:e,tree:t}=this.properties;this.listen(e.explorer,"booted",(e=>{t.individuals[0].emit("nodeAnimate")})),this.listen(e.explorer,"coordinatesSet",(e=>{this.root.style.left=e.x+"px",this.root.style.top=e.y+"px"})),this.listen(e.explorer,"scaleSet",(e=>{this.root.style.transform=`scale(${e})`})),this.identifier.focusOne.addEventListener("focus",(()=>{null!==t&&t.individuals.length>=1&&t.individuals[t.individuals.length-1].emit("nodeFocus")})),this.identifier.focusTwo.addEventListener("focus",(()=>{null!==t&&t.individuals.length>=1&&t.individuals[0].emit("nodeFocus")}))}}var ct=e=>({tagName:"div",style:"height: 100%",id:"tree-viewer",children:[{model:Ke,binding:dt},{model:nt,binding:lt},...[e.geneatree.settings.minimap&&{model:tt,binding:rt}].filter(Boolean)]}),ht=e=>({tagName:"div",id:"tree-viewer-placeholder",children:[{tagName:"div",className:"body",children:[{tagName:"div",style:"display: grid; grid-gap: 5px",children:[{tagName:"p",style:"text-align: center; color: white; padding: 15px 0;",innerHTML:"Welcome to <b>geneatree</b>"},{tagName:"button",identifier:"createButton",tabIndex:1,textContent:"Create a new tree"},{tagName:"button",identifier:"importButton",tabIndex:2,textContent:"Import existing tree"}]}]}]});class pt extends n{}var mt={tagName:"div",style:"display: grid; grid-gap: 5px; background-color: #b29e9e; padding: 10px;",children:[{tagName:"button",type:"button",className:"button-danger",identifier:"deleteOfflineData",textContent:"🗑️ Vider la base de donnée locale"}]};const ut=["offline","minimap","osd"];class gt extends n{onCreated(){const{geneatree:e}=this.properties;this.identifier.deleteOfflineData.addEventListener("click",(()=>{e.emit("persistenceIndexeddbClear")}))}}class ft extends G{constructor(e){super({...e,form:new j})}onCreated(){super.onCreated();const{geneatree:e}=this.properties;this.listen(this.properties.form,"submitted",(t=>{e.emit("settingsSet",t),e.emit("osdSet",{text:"Settings updated",type:"valid"})})),this.properties.form.emit("load",e.settings)}}class vt extends n{onCreated(){this.properties;const e=new Re([new Ie("General",Y({tagName:"div",style:"display: contents",children:[...Object.keys(xi.SETTINGS).filter((e=>ut.includes(e))).map((e=>({tagName:"label",textContent:`${e}:`,children:[{tagName:"div",children:[{tagName:"select",style:"width: 100%",identifier:e,children:[{tagName:"option",value:!0,textContent:"Activée"},{tagName:"option",value:!1,textContent:"Désactivée"}]}]}]}))),{tagName:"label",textContent:"theme:",children:[{tagName:"div",children:[{tagName:"select",style:"width: 100%",identifier:"theme",children:x.map((e=>({tagName:"option",value:e,textContent:e})))}]}]}]}),ft),new Ie("Actions",mt,gt)]);this.run(ye,{binding:new Se({tabs:e}),parentNode:this.identifier.tabs}),e.emit("tabSet","General")}}var Nt=Y(W({title:"Enfant"}));class yt extends G{constructor(e){super({...e,form:new j})}onCreated(){super.onCreated(),this.listen(this.properties.step,"set",(e=>{this.properties.form.emit("focus")})),this.listen(this.properties.form,"submitted",(e=>this.properties.steps.emit("stepNext",e)))}}var wt=Y({tagName:"div",style:"display: contents",children:[{tagName:"h3",textContent:"Relationship",className:"title"},{tagName:"div",children:[{tagName:"label",children:[{tagName:"input",identifier:"recognized",type:"checkbox",checked:!0},{tagName:"span",textContent:"Cet enfant est reconnu"}]}]},{tagName:"div",children:[{tagName:"label",identifier:"check_adoption",children:[{tagName:"input",identifier:"adopted",type:"checkbox"},{tagName:"span",textContent:"Cet enfant est adopté"}]}]},{tagName:"div",style:"display: none",identifier:"radios_adopted",children:[{tagName:"label",children:[{tagName:"input",type:"radio",identifier:"adopted_simple",name:"adoption",checked:!0},{tagName:"span",textContent:"Adoption simple"}]},{tagName:"label",children:[{tagName:"input",type:"radio",identifier:"adopted_full",name:"adoption"},{tagName:"span",textContent:"Adoption plénière"}]}]}]});class xt extends G{constructor(e){super({...e,form:new j})}onCreated(){super.onCreated(),this.listen(this.properties.step,"set",(e=>{this.properties.form.emit("focus")})),this.listen(this.properties.form,"submitted",(e=>this.properties.steps.emit("stepNext",e))),this.identifier.adopted.addEventListener("change",(e=>{e.target.checked?this.identifier.radios_adopted.style.display="block":this.identifier.radios_adopted.style.display="none"}))}}class bt extends s{constructor(e){super(),this._id=e,this._networkId=-1,this._offlineId=-1}get id(){return this._id}get networkId(){return this._networkId}set networkId(e){this._networkId=e}get offlineId(){return this._offlineId}set offlineId(e){this._offlineId=e}}class Et extends bt{static TYPES={BIOLOGICAL:"BIOLOGICAL",MARRIAGE:"MARRIAGE",PACS:"PACS",CONCUBINAGE:"CONCUBINAGE",DIVORCE:"DIVORCE",VEUVAGE:"VEUVAGE"};constructor(e,t,i,s){super(e),this._type=t,this._relationshipIndividual1=i,this._relationshipIndividual2=s,this._meta={startDate:null,endDate:null,place:""}}get type(){return this._type}get relationshipIndividual1(){return this._relationshipIndividual1}get relationshipIndividual2(){return this._relationshipIndividual2}get meta(){return this._meta}}class _t extends bt{static ROLES={PARENT:"PARENT",CHILD:"CHILD",SPOUSE:"SPOUSE"};constructor(e,t){super(-1),this._individual=e,this._role=t}get individual(){return this._individual}get role(){return this._role}}class It extends n{onCreated(){const{geneatree:e,individual:t,tree:i}=this.properties,s=new q([new P("Individu",Nt,yt),new P("Relationship",wt,xt)]);this.listen(s,"done",(()=>{const e=i.addIndividual(s.getStepByName("Individu").data),n=new _t(t,_t.ROLES.PARENT),r=new _t(e,_t.ROLES.CHILD),a=i.addRelationship(Et.TYPES.BIOLOGICAL,n,r);a.meta.recognised=s.getStepByName("Relationship").data.recognised,s.getStepByName("Relationship").data.adopted&&(a.meta.adoptedType=s.getStepByName("Relationship").data.adopted_simple?"simple":"full")})),this.run(T,{binding:new U({steps:s})}),s.emit("stepSet","Individu")}}var Ct=e=>({tagName:"div",id:"view-add-child"}),St=Y(W({title:"Parent"}));class Rt extends G{constructor(e){super({...e,form:new j})}onCreated(){super.onCreated(),this.listen(this.properties.step,"set",(e=>{this.properties.form.emit("focus")})),this.listen(this.properties.form,"submitted",(e=>this.properties.steps.emit("stepNext",e)))}}var Lt=Y({tagName:"div",style:"display: contents",children:[{tagName:"h3",textContent:"Relationship",className:"title"},{tagName:"div",children:[{tagName:"label",children:[{tagName:"input",identifier:"recognised",type:"checkbox",checked:!0},{tagName:"span",textContent:"Cet enfant reconnu"}]}]},{tagName:"div",children:[{tagName:"label",identifier:"check_adoption",children:[{tagName:"input",identifier:"adopted",type:"checkbox"},{tagName:"span",textContent:"Cet enfant adopté"}]}]},{tagName:"div",style:"display: none; grid-template-columns: auto auto; grid-gap: var(--SIZE_MEDIUM);",identifier:"radios_adopted",children:[{tagName:"label",children:[{tagName:"input",type:"radio",identifier:"adopted_simple",name:"adoption",checked:!0},{tagName:"span",textContent:"Adoption simple"}]},{tagName:"label",children:[{tagName:"input",type:"radio",identifier:"adopted_full",name:"adoption"},{tagName:"span",textContent:"Adoption plénière"}]}]}]});class Tt extends G{constructor(e){super({...e,form:new j})}onCreated(){super.onCreated(),this.listen(this.properties.step,"set",(e=>{this.properties.form.emit("focus")})),this.listen(this.properties.form,"submitted",(e=>this.properties.steps.emit("stepNext",e))),this.identifier.adopted.addEventListener("change",(e=>{e.target.checked?this.identifier.radios_adopted.style.display="grid":this.identifier.radios_adopted.style.display="none"}))}}class At extends n{onCreated(){const{geneatree:e,individual:t,tree:i}=this.properties,s=new q([new P("Individu",St,Rt),new P("Relationship",Lt,Tt)]);this.listen(s,"done",(()=>{const e=i.addIndividual(s.getStepByName("Individu").data),n=new _t(t,_t.ROLES.SPOUSE),r=new _t(e,_t.ROLES.SPOUSE),a=i.addRelationship(Et.TYPES.UNION.MARRIAGE,n,r);a.meta.startDate=s.getStepByName("Relationship").data.relationDate,a.meta.place=s.getStepByName("Relationship").data.relationPlace})),this.run(T,{binding:new U({steps:s})}),s.emit("stepSet","Individu")}}var Ot=e=>({tagName:"div",id:"view-add-child"});class kt extends n{onCreated(){const{geneatree:e,individual:t,tree:i}=this.properties,s=new q([new P("Individu",St,Rt),new P("Relationship",Lt,Tt)]);this.listen(s,"done",(()=>{const e=i.addIndividual(s.getStepByName("Individu").data),n=new _t(t,_t.ROLES.CHILD),r=new _t(e,_t.ROLES.PARENT),a=i.addRelationship(Et.TYPES.BIOLOGICAL,n,r);a.meta.recognised=s.getStepByName("Relationship").data.recognised,s.getStepByName("Relationship").data.adopted&&(a.meta.adoptedType=s.getStepByName("Relationship").data.adopted_simple?"simple":"full")})),this.run(T,{binding:new U({steps:s})}),s.emit("stepSet","Individu")}}var Dt=e=>({tagName:"div",id:"view-add-parent"}),Pt=Y(W({title:"Modifier un individu"})),Bt={tagName:"div",className:"tab-notes",style:"display: grid; grid-gap: 20px",children:[{tagName:"h3",identifier:"title",textContent:"Liste des notes"},{tagName:"div",identifier:"body",style:"display: contents"}]},Mt={tagName:"div",className:"tab-relationships",style:"display: grid; grid-gap: 20px",children:[{tagName:"h3",identifier:"title",textContent:"Relationships"},{tagName:"div",identifier:"body"}]};class Ut extends G{constructor(e){super({...e,form:new j})}onCreated(){const{geneatree:e,individual:t}=this.properties;super.onCreated(),this.listen(this.properties.tab,"set",(e=>{this.properties.form.emit("load",this.properties.individual.meta),this.properties.form.emit("focus")})),this.listen(this.properties.form,"submitted",(i=>{t.update(i),e.individuals.emit("updated",{individual:t,form:i}),e.emit("osdSet",{text:"Individual updated",type:"valid"})}))}}var qt=e=>({tagName:"div",children:[{tagName:"div",style:"display: grid; grid-gap: 20px;",children:[{tagName:"input",identifier:"searchInput",placeholder:"Filter notes"},{tagName:"div",style:"display: none",identifier:"placeholder",textContent:"No notes were found."},{tagName:"div",className:"grid-gap",style:"display: none",identifier:"list"},{tagName:"button",identifier:"addNote",className:"button4",textContent:"Add note"}]}]}),Yt=e=>({tagName:"div",className:"note",children:[{tagName:"h3",identifier:"title",textContent:e.note.title},{tagName:"div",identifier:"content",textContent:e.note.content},{tagName:"div",identifier:"author",textContent:`${e.note.author}`},{tagName:"div",textContent:` ${e.note.date.toLocaleDateString("fr-FR",{weekday:"long",year:"numeric",month:"long",day:"numeric"})}`},{tagName:"div",className:"actions",children:[{tagName:"button",textContent:"Editer",className:"button4",identifier:"edit"},{tagName:"button",textContent:"X",className:"button-danger",identifier:"remove"}]}]});class Ft extends je{onCreated(){super.onCreated(this.properties);const{geneatree:e,individual:t,note:i,page:s,router:n}=this.properties;this.identifier.edit.addEventListener("click",(()=>n.emit("browse",{path:"/edit",properties:{note:i}}))),this.identifier.remove.addEventListener("click",(()=>{t.removeNote(i),i.emit("remove"),this.properties.geneatree.individuals.emit("notesRemoved",i),e.emit("osdSet",{text:"Note removed",type:"valid"})}))}}class Gt extends n{onCreated(){this.paginator=new $e(3),this.identifier.searchInput.addEventListener("input",(()=>this.render())),this.identifier.addNote.addEventListener("click",(()=>{this.properties.router.emit("browse",{path:"/add"})})),this.listen(this.properties.geneatree.individuals,"notesRemoved",(()=>this.render())),this.run(qe,{parentNode:this.identifier.list,binding:new Ge({paginator:this.paginator,maxShownPages:3})}),this.render()}render(){const e=this.properties.individual.findNotes(this.identifier.searchInput.value);0===e.length?(this.identifier.placeholder.style.display="",this.identifier.list.style.display="none"):(this.identifier.placeholder.style.display="none",this.identifier.list.style.display="grid",this.paginator.emit("itemsSet",e.map((e=>({model:Yt,binding:Ft,properties:{note:e}})))))}}var jt=e=>Y({tagName:"div",style:"display: contents",children:[{tagName:"div",children:[{tagName:"label",textContent:"Title:",children:[{tagName:"div",children:[{tagName:"input",className:"width-100",identifier:"title"}]}]}]},{tagName:"div",children:[{tagName:"label",textContent:"Content:",children:[{tagName:"div",children:[{tagName:"textarea",className:"width-100",identifier:"content"}]}]}]},{tagName:"div",children:[{tagName:"label",textContent:"Auteur:",children:[{tagName:"div",children:[{tagName:"input",className:"width-100",identifier:"author"}]}]}]}]});class $t extends G{constructor(e){super({...e,form:new j})}onCreated(){super.onCreated();const{geneatree:e,form:t,router:i,individual:s}=this.properties;this.listen(t,"submitted",(t=>{const n=s.addNote(t.title,t.content,t.author,new Date);e.individuals.emit("notesAdded",n),i.emit("browse",{path:"/"}),e.emit("osdSet",{text:"Note added",type:"valid"})}))}}var Xt=e=>Y({tagName:"div",style:"display: contents",children:[{tagName:"div",children:[{tagName:"label",textContent:"Title:",children:[{tagName:"div",children:[{tagName:"input",className:"width-100",identifier:"title",value:e.note.title}]}]}]},{tagName:"div",children:[{tagName:"label",textContent:"Content:",children:[{tagName:"div",children:[{tagName:"textarea",className:"width-100",identifier:"content",value:e.note.content}]}]}]},{tagName:"div",children:[{tagName:"label",textContent:"Auteur:",children:[{tagName:"div",children:[{tagName:"input",className:"width-100",identifier:"author",value:e.note.author}]}]}]}]});class Ht extends G{constructor(e){super({...e,form:new j})}onCreated(){super.onCreated();const{geneatree:e,form:t,router:i}=this.properties;this.listen(t,"submitted",(t=>{this.properties.note.update(t),e.individuals.emit("notesUpdated",{note:this.properties.note,form:t}),i.emit("browse",{path:"/"}),e.emit("osdSet",{text:"Note updated",type:"valid"})}))}}class Wt extends n{onCreated(){const{geneatree:t,tab:i}=this.properties,s=new e.Router({routes:[new e.Route({match:"/",model:new d(qt,Gt)}),new e.Route({match:"/add",model:new d(jt,$t)}),new e.Route({match:"/edit",model:new d(Xt,Ht)})]});this.listen(i,"set",(()=>{s.emit("browse",{path:"/"})})),this.run(e.RouterModel,{binding:new e.RouterBinding({router:s}),parentNode:this.identifier.body})}}class Vt extends n{onCreated(){const{geneatree:e,tab:t,individual:i}=this.properties,s=new j;this.listen(s,"submitted",(e=>{console.log(e)})),this.listen(e.individuals,"selected",(e=>{this.identifier.delete.disabled=e.meta.decujus})),this.identifier.delete.addEventListener("click",(()=>e.individuals.emit("remove",i)))}}var zt=e=>({tagName:"div",identifier:"view-list",children:[{tagName:"div",style:"display: grid; grid-gap: 20px;",children:[{tagName:"input",identifier:"searchInput",placeholder:"Filter relationships"},{tagName:"div",style:"display: none",identifier:"placeholder",textContent:"No relationships were found."},{tagName:"div",className:"grid-gap",style:"display: none",identifier:"list"}]}]});class Jt extends n{onCreated(){this.paginator=new $e(3),this.identifier.searchInput.addEventListener("input",(()=>this.render())),this.listen(this.properties.geneatree.individuals,"relationshipsRemoved",(()=>this.render())),this.run(qe,{parentNode:this.identifier.list,binding:new Ge({paginator:this.paginator,maxShownPages:3})}),this.render()}render(){this.identifier.placeholder.style.display=""}}class Kt extends n{onCreated(){const{geneatree:t,tab:i}=this.properties,s=new e.Router({routes:[new e.Route({match:"/",model:new d(zt,Jt)})]});this.listen(i,"set",(()=>{s.emit("browse",{path:"/"})})),this.run(e.RouterModel,{binding:new e.RouterBinding({router:s}),parentNode:this.identifier.body})}}class Zt extends n{remove(){this.properties.tree.selectedIndividual=null,super.remove()}onCreated(){const{geneatree:e}=this.properties,t=new Re([new Ie("Editer",Pt,Ut),new Ie("Notes",Bt,Wt),new Ie("Relations",Mt,Kt),new Ie("Actions",(i=this.properties.individual,{tagName:"div",className:"tab-actions",style:"display: grid; grid-gap: 20px",children:[{tagName:"div",className:"title",style:"display: grid; grid-template-columns: auto 1fr; grid-auto-columns: max-content;",children:[{tagName:"h3",identifier:"title",textContent:"Actions"}]},{tagName:"div",style:"display: grid; grid-gap: 5px; background-color: #b29e9e; padding: 10px;",children:[{tagName:"button",className:"button-danger",identifier:"delete",disabled:i.meta.decujus,textContent:"Supprimer"}]}]}),Vt)]);var i;this.listen(e.individuals,"removed",(t=>{e.individuals.emit("unselect",t)})),this.run(ye,{binding:new Se({tabs:t})}),t.emit("tabSet","Editer")}}var Qt=e=>({tagName:"div",id:"view-individual"}),ei=e=>({tagName:"div",identifier:"view-list",children:[{tagName:"div",style:"display: grid; grid-gap: 10px;",children:[{tagName:"input",identifier:"searchInput",placeholder:"Filtrer les logs"},{tagName:"div",style:"display: grid;grid-template-columns: 1fr auto auto; grid-gap: 10px; padding: 10px 0;",children:[{tagName:"div",style:"justify-content: center;display: grid;grid-auto-flow: column; grid-gap: 15px;",identifier:"types",children:[...Object.keys(u.TYPE).map((e=>({tagName:"label",children:[{tagName:"input",type:"checkbox",identifier:`type-${u.TYPE[e].toLowerCase()}`,name:"type",checked:u.TYPE[e]!==u.TYPE.DEBUG},{tagName:"span",textContent:u.TYPE[e]}]})))]},{tagName:"button",identifier:"clearButton",className:"button-danger",textContent:"Vider"},{tagName:"button",identifier:"exportButton",className:"button4",textContent:"Exporter"}]}]},{tagName:"div",style:"display: none",identifier:"placeholder",textContent:"Aucun log n'a pu être trouvé."},{tagName:"div",className:"grid-gap",style:"display: none",identifier:"list"}]}),ti=e=>Y({tagName:"div",style:"display: contents",children:[{tagName:"label",textContent:"Depuis",children:[{tagName:"div",children:[{tagName:"input",type:"date",style:"width: 100%",identifier:"from"}]}]},{tagName:"label",textContent:"Jusqu'a",children:[{tagName:"div",children:[{tagName:"input",type:"date",style:"width: 100%",identifier:"to"}]}]},{tagName:"label",textContent:"Format",children:[{tagName:"div",children:[{tagName:"select",style:"width: 100%",identifier:"format",children:E.map((e=>({tagName:"option",textContent:e})))}]}]}]}),ii=e=>({tagName:"div",className:"log",children:[{tagName:"span",style:"text-decoration: underline",textContent:e.log.type},{tagName:"span",title:e.log.date,textContent:`${e.log.date.toLocaleTimeString("fr-FR")}:${e.log.date.getMilliseconds()} ${e.log.date.toLocaleDateString("fr-FR",{day:"numeric",month:"numeric"})}`},{tagName:"span",style:"word-break: break-all;",textContent:e.log.message}]});class si extends je{onCreated(){super.onCreated(this.properties),this.properties}}let ni=class extends n{render(e){if(e.length>=1){this.identifier.list.style.display="",this.identifier.placeholder.style.display="none";const t=e.slice().sort(((e,t)=>e.date-t.date));t.reverse();const i=t.map((e=>({properties:{log:e},model:ii,binding:si})));this.paginator.emit("itemsSet",i)}else this.identifier.list.style.display="none",this.identifier.placeholder.style.display=""}onCreated(){const{geneatree:e,router:t}=this.properties,i={};this.paginator=new $e(8),this.identifier.exportButton.addEventListener("click",(()=>{t.emit("browse",{path:"/export"})})),this.identifier.clearButton.addEventListener("click",(()=>{e.emit("logs clear");const t=e.findLogs({query:event.target.value,types:i});this.render(t)})),this.identifier.searchInput.addEventListener("input",(t=>{const s=e.findLogs({query:t.target.value,types:i});this.render(s)})),this.identifier.types.addEventListener("change",(()=>{for(const e of Object.keys(u.TYPE))i[u.TYPE[e]]=this.identifier[`type-${u.TYPE[e].toLowerCase()}`].checked;const t=e.findLogs({query:this.identifier.searchInput.value,types:i});this.render(t)})),this.run(qe,{parentNode:this.identifier.list,binding:new Ge({paginator:this.paginator,maxShownPages:5})});for(const e of Object.keys(u.TYPE))i[u.TYPE[e]]=this.identifier[`type-${u.TYPE[e].toLowerCase()}`].checked;const s=e.findLogs({query:this.identifier.searchInput.value,types:i});this.render(s)}};class ri extends G{constructor(e){super({...e,form:new j})}onCreated(){super.onCreated();const{geneatree:e}=this.properties;this.listen(this.properties.form,"submitted",(t=>{const i=e.logs.map((e=>({message:e.message,data:e.data,type:e.type,date:e.date}))),s=new Blob([JSON.stringify(i)],{type:"application/json"}),n=new FileReader,r=document.createElement("a"),a=new Date;r.download=`geneatree-logs-${a.getDate()}-${a.getMonth()+1}-${a.getFullYear()}-${a.getHours()}-${a.getMinutes()}-${a.getSeconds()}.json`,n.onload=function(e){r.href=e.target.result,r.click()},n.onerror=t=>{e.emit("log",{message:"Failed to read logs Blob",type:u.TYPE.ERROR,data:t})},n.readAsDataURL(s)}))}}class ai extends n{onCreated(){this.properties;const t=new e.Router({routes:[new e.Route({match:"/",model:new d(ei,ni)}),new e.Route({match:"/export",model:new d(ti,ri)})]});this.run(e.RouterModel,{binding:new e.RouterBinding({router:t}),parentNode:this.identifier.router})}}class di extends n{async onRendered(){const e=new ResizeObserver((()=>{const{width:e,height:s}=this.root.getBoundingClientRect();t.viewer.width=e,t.viewer.height=s,i.explorer.emit("resized",{width:e,height:s})}));e.observe(this.root);const{tree:t,geneatree:i}=this.properties,{width:s,height:n}=this.root.getBoundingClientRect();this.properties.tree.viewer.width=s,this.properties.tree.viewer.height=n,0!==t.viewer.x&&0!==t.viewer.y||(t.viewer.x=t.viewer.width/2,t.viewer.y=t.viewer.height/2),i.explorer.emit("boot")}}class oi extends n{constructor(e){super(e)}onCreated(){const{geneatree:e}=this.properties;this.identifier.createButton.addEventListener("click",(()=>{e.router.emit("browse",{path:"/tree/add"})})),this.identifier.importButton.addEventListener("click",(()=>{e.router.emit("browse",{path:"/tree/import"})}))}}class li extends s{constructor(){super()}}class ci{static AXIS={VERTICAL:"AXIS_VERTICAL",HORIZONTAL:"AXIS_HORIZONTAL",DIAGONAL_LEFT:"AXIS_DIAGONAL_LEFT",DIAGONAL_RIGHT:"AXIS_DIAGONAL_RIGHT"};static DIRECTION={FORWARD:"DIRECTION_FORWARD",BACKWARD:"DIRECTION_BACKWARD"};constructor(e,t){this._axis=e,this._direction=t}get axis(){return this._axis}get direction(){return this._direction}}class hi{constructor(e,t){this._x=e,this._y=t,this._row=null,this._neighbors=[],this._data=null}getRelativePosition(e){return this.x===e.x&&this.y-1===e.y?new ci(ci.AXIS.VERTICAL,ci.DIRECTION.BACKWARD):this.x===e.x&&this.y+1===e.y?new ci(ci.AXIS.VERTICAL,ci.DIRECTION.FORWARD):this.x-1===e.x&&this.y===e.y?new ci(ci.AXIS.HORIZONTAL,ci.DIRECTION.BACKWARD):this.x+1===e.x&&this.y===e.y?new ci(ci.AXIS.HORIZONTAL,ci.DIRECTION.FORWARD):this.x-1===e.x&&this.y-1===e.y?new ci(ci.AXIS.DIAGONAL_RIGHT,ci.DIRECTION.BACKWARD):this.x+1===e.x&&this.y+1===e.y?new ci(ci.AXIS.DIAGONAL_RIGHT,ci.DIRECTION.FORWARD):this.x-1===e.x&&this.y+1===e.y?new ci(ci.AXIS.DIAGONAL_LEFT,ci.DIRECTION.BACKWARD):this.x+1===e.x&&this.y-1===e.y?new ci(ci.AXIS.DIAGONAL_LEFT,ci.DIRECTION.FORWARD):null}getAxisCells(e,t=[],i=[]){return 0===i.length&&i.push(this),t.push(this),this.neighbors.filter((i=>i.relativePosition.axis===e&&!1===t.includes(i.cell))).forEach((s=>{i.push(s.cell),i.concat(s.cell.getAxisCells(e,t,i))})),i.sort(((e,t)=>e.y<t.y?-1:e.y>t.y?1:e.x<t.x?-1:e.x>t.x?1:0)),i}getNeighborByCell(e){return this.neighbors.find((t=>t.cell===e))}get x(){return this._x}get y(){return this._y}get neighbors(){return this._neighbors}get row(){return this._row}get data(){return this._data}set data(e){this._data=e}}class pi{constructor(e,t){this._cell=e,this._relativePosition=t}get cell(){return this._cell}get relativePosition(){return this._relativePosition}}class mi{constructor(e){this._x=e,this._cells={}}get x(){return this._x}get cells(){return this._cells}}class ui{constructor(){this._rows={}}addCell(e,t){const i=new hi(e,t);for(const e of this.getCells()){const t=i.getRelativePosition(e);if(t){const s=new pi(e,t);i.neighbors.push(s);const n=e.getRelativePosition(i),r=new pi(i,n);e.neighbors.push(r)}}return this.rows[i.x]||(this.rows[i.x]=new mi(i.x)),i._row=this.rows[i.x],this.rows[i.x].cells[i.y]=i,i}build(e){for(let t=0;t<e;t++)for(let i=0;i<e;i++)this.addCell(t,i)}getCell(e,t){return this.rows[e].cells[t]}getCells(){return Object.values(this.rows).map((e=>Object.values(e.cells))).flat()}get rows(){return this._rows}}class gi extends s{constructor(){super(),this._list=[],this._grid=new ui}get list(){return this._list}}class fi extends bt{constructor(e,t,i,s,n,r){super(e),this._individual=t,this._title=i,this._content=s,this._author=n,this._date=r}update(e){for(const t in e)this[t]=e[t]}get individual(){return this._individual}get title(){return this._title}set title(e){this._title=e}get content(){return this._content}set content(e){this._content=e}get author(){return this._author}set author(e){this._author=e}get date(){return this._date}set date(e){this._date=e}}class vi extends bt{constructor(e,t,i){super(e),this._tree=t,this._meta={address:"",birthDate:"",birthName:"",birthPlace:"",cellPhone:"",deathDate:"",deathPlace:"",decujus:!1,firstName:"",gender:"unknown",heir:!1,homePhone:"",lastName:"",mail:"",quota_denominator:"",quota_numerator:"",seisin:!1,...i},this._cell=null,this._notes=[],this._nextNoteId=0}addNote(e,t,i,s){const n=new fi(this._nextNoteId++,this,e,t,i,s);return this.notes.push(n),n}removeNote(e){this.notes.splice(this.notes.indexOf(e),1)}findNotes(e){const t=e.toLowerCase();return this.notes.filter((e=>e.title.toLowerCase().includes(t)||e.author.toLowerCase().includes(t)||e.content.toLowerCase().includes(t)||new Intl.DateTimeFormat("fr-FR").format(e.date).includes(t)))}update(e){for(const t in e)this.meta[t]=e[t]}get tree(){return this._tree}get notes(){return this._notes}get meta(){return this._meta}get cell(){return this._cell}set cell(e){this._cell=e}}class Ni extends s{constructor(){super(),this._width=0,this._height=0,this._x=0,this._y=0,this._scale=1,this._dragging={clientX:0,toggled:!0,clientY:0,moved:!1,started:!1}}get width(){return this._width}set width(e){this._width=e}get height(){return this._height}set height(e){this._height=e}get x(){return this._x}set x(e){this._x=e}get y(){return this._y}set y(e){this._y=e}get scale(){return this._scale}set scale(e){this._scale=e}get dragging(){return this._dragging}}class yi extends bt{constructor(e,t){super(e),this._meta=t,this._individuals=[],this._relationships=[],this._viewer=new Ni,this._selectedIndividual=null,this._nextIndividualId=0,this._nextRelationshipId=0}addIndividual(e){const t=new vi(this._nextIndividualId++,this,e);return this.individuals.push(t),t}removeIndividual(e){e===this.selectedIndividual&&(this.selectedIndividual=null),this.individuals.splice(this.individuals.indexOf(e),1)}findIndividuals(e){const t=e.query.toLowerCase();return this.individuals.filter((i=>(i.meta.birthName.toLowerCase().includes(t)||i.meta.firstName.toLowerCase().concat(i.meta.lastName.toLowerCase()).includes(t)||i.meta.firstName.toLowerCase().includes(t)||i.meta.lastName.toLowerCase().includes(t))&&(!e.alive||""===i.meta.deathDate)))}addRelationship(e,t,i){const s=new Et(this._nextRelationshipId++,e,t,i);return this.relationships.push(s),s}findRelationships(e){return this.relationships.filter((t=>t.relationshipIndividual1.individual===e.individual||t.relationshipIndividual2.individual===e.individual))}get meta(){return this._meta}get individuals(){return this._individuals}get relationships(){return this._relationships}get viewer(){return this._viewer}get selectedIndividual(){return this._selectedIndividual}set selectedIndividual(e){this._selectedIndividual=e}}class wi extends s{constructor(){super(),this._list=[],this._selected=null,this._toggled=!0,this._nextTreeId=0}add(e){const t=new yi(this._nextTreeId++,e);return this.list.push(t),t}remove(e){e===this.selected&&(this.selected=null,e.selectedIndividual=null),this.list.splice(this.list.indexOf(e),1)}find(e){const t=e.toLowerCase(),i=this.list.filter((e=>Object.values(e.meta).map((e=>e.toLowerCase())).filter((e=>e.includes(t))).length>=1)),s=this.list.map((t=>({tree:t,results:t.findIndividuals({query:e,alive:!0})}))).filter((e=>e.results.length>=1)).map((e=>e.tree));return i.concat(s).filter(((e,t,i)=>i.indexOf(e)===t))}get list(){return this._list}get selected(){return this._selected}set selected(e){this._selected=e}get toggled(){return this._toggled}set toggled(e){this._toggled=e}}class xi extends s{static SETTINGS={offline:!1,minimap:!0,osd:!0,theme:"white"};constructor(){super(),this._logs=[],this._socketState="SOCKET_STATE_INITIAL",this._settings={...xi.SETTINGS},this._explorer=new li,this._individuals=new gi,this._trees=new wi,this._router=new e.Router({routes:[new e.Route({match:"/",model:new d(ht,oi)}),new e.Route({match:"/viewer",model:new d(ct,di)}),new e.Route({match:"/logs",model:new d(Je,ai)}),new e.Route({match:"/about",model:new d(R,pt)}),new e.Route({match:"/settings",model:new d(L,vt)}),new e.Route({match:"/tree/new",model:new d(Z,Q)}),new e.Route({match:"/tree/add",model:new d(K,J)}),new e.Route({match:"/tree/import",model:new d(Ne,ve)}),new e.Route({match:"/tree",model:new d(ze,Ve)}),new e.Route({match:"/tree/add-child",model:new d(Ct,It)}),new e.Route({match:"/tree/add-parent",model:new d(Dt,kt)}),new e.Route({match:"/tree/add-spouse",model:new d(Ot,At)}),new e.Route({match:"/tree/individual",model:new d(Qt,Zt)})]})}log(e,t,i){const s=new u(e,t,i);return this._logs.push(s),s}findLogs(e){const t=e.query.toLowerCase();return this._logs.filter((i=>i.message.toLowerCase().includes(t)&&(null===e.type&&i.type!==u.TYPE.DEBUG||!0===e.types[i.type])))}get logs(){return this._logs}get trees(){return this._trees}get settings(){return this._settings}set settings(e){this._settings=e}get socketState(){return this._socketState}set socketState(e){this._socketState=e}get grid(){return this._grid}get explorer(){return this._explorer}get individuals(){return this._individuals}get router(){return this._router}}const bi=function(e,t){const i=e.postMessage;if(e.postMessage=function(e,t){return i.call(this,{data:e},t)},e instanceof t)e.addEventListener=e.on,e.removeEventListener=e.off;else{const t={addEventListener:e.addEventListener},i=function(s,n,r){e.addEventListener=t.addEventListener;const a=e.on(s,n);return e.addEventListener=i,a};e.addEventListener=i}return e},Ei=new Function("req",'return req("worker_threads").Worker;'),_i=new Function("req",'return req("events").EventEmitter;');var Ii=Object.freeze({__proto__:null,factory:function(e){return function(){const t=new(Ei(require))(e,{eval:!0});return t.on("error",(function(e){throw e})),bi(t,_i(require))}},transform:function(e){return`const nodeWorkerPolyfill = ${bi.toString()};\nglobal.self = nodeWorkerPolyfill(require("worker_threads").parentPort, require("events").EventEmitter);\n`+e}});const Ci=function(e){return e.on=e.addEventListener,e.off=e.removeEventListener,e};var Si=Object.freeze({__proto__:null,factory:function(e){return function(){const t=function(e){try{return URL.createObjectURL(new Blob([e],{type:"application/javascript"}))}catch(t){const i=new BlobBuilder;return i.append(e),URL.createObjectURL(i.getBlob())}}(e),i=Ci(new Worker(t));i.objURL=t;const s=i.terminate;return i.on=i.addEventListener,i.off=i.removeEventListener,i.terminate=function(){return URL.revokeObjectURL(t),s.call(this)},i}},transform:function(e){return`var browserWorkerPolyFill = ${Ci.toString()};\nbrowserWorkerPolyFill(self);\n`+e}});class Ri{constructor(){this.listeners_=[],this.onmessage=null,this.remote_=null}addEventListener(e,t){"message"===e&&this.listeners_.push(t)}removeEventListener(e,t){if("message"!==e)return;const i=this.listeners_.indexOf(t);-1!==i&&this.listeners_.splice(i,1)}dispatchEvent(e){e&&"message"===e.type&&(this.onmessage&&this.onmessage(e),this.listeners_.forEach((function(t){t(e)})))}postMessage(e){this.remote_&&this.remote_.recv_(e)}recv_(e){const t={data:e};this.onmessage&&this.onmessage(t),this.listeners_.forEach((function(e){e(t)}))}terminate(){this.remote_&&(this.remote_.remote_=null,this.remote_.terminate(),this.remote_=null),this.onmessage=null,this.listeners_.length=0}}Ri.prototype.on=Ri.prototype.addEventListener,Ri.prototype.off=Ri.prototype.removeEventListener;var Li=Object.freeze({__proto__:null,factory:function(e){return function(){const t=new Ri,i=new Ri;return t.type_="window api",t.remote_=i,i.remote_=t,i.type_="web worker",e(i),t}},transform:function(e){return e}});const Ti=function(){try{if(void 0!==require("worker_threads"))return!0}catch(e){return!1}}(),Ai=function(){try{if(void 0!==(window&&window.Worker))return!0}catch(e){return!1}}();let Oi=Li;Ti?Oi=Ii:Ai&&(Oi=Si);const ki=Oi.transform;var Di=(0,Oi.factory)(ki(function(){const e=[];self.addEventListener("message",(t=>{const{query:i,data:s}=t.data;self.postMessage({query:"log",data:{type:"debug",message:`[persistence:indexeddb-remote] Received query: ${i}`,data:s}});const n=e.filter((e=>e.query===i));n.length>=1?n.forEach((e=>e.callback(s))):self.postMessage({query:"log",data:{type:"debug",message:`[persistence:indexeddb-remote] Unrecognized query: ${i}`}})})),e.push({query:"load",callback:t=>{const i=e.findIndex((e=>"load"===e.query));e.splice(i,1);const s=indexedDB.open(t.databaseName,t.databaseVersion);s.addEventListener("success",(async()=>{const t=s.result;t.addEventListener("versionchange",(e=>{self.postMessage({query:"log",data:{type:"debug",message:"[persistence:indexeddb-remote] database version changed: closing database.."}}),t.close()})),t.addEventListener("close",(e=>{self.postMessage({query:"log",data:{type:"debug",message:"[persistence:indexeddb-remote] connection closed"}})})),(e=>{const{listeners:t,database:i}=e;t.push({query:"clear",callback:()=>{const e=indexedDB.deleteDatabase(i.name);e.addEventListener("success",(e=>{self.postMessage({query:"clearSuccess"})})),e.addEventListener("error",(e=>{self.postMessage({query:"clearError"})}))}})})({worker:self,listeners:e,database:t}),(e=>{const{listeners:t,database:i}=e;t.push({query:"treeAdd",callback:e=>{const{id:t,...s}=e;i.transaction(["trees"],"readwrite").objectStore("trees").add(s).addEventListener("success",(e=>{self.postMessage({query:"treeAdded",data:{id:t,offlineId:e.target.result}})}))}}),t.push({query:"treeUpdate",callback:e=>{i.transaction(["trees"],"readwrite").objectStore("trees").put(e)}}),t.push({query:"treeRemove",callback:e=>{i.transaction(["trees"],"readwrite").objectStore("trees").delete(e.offlineId)}})})({worker:self,listeners:e,database:t}),(e=>{const{listeners:t,database:i}=e;t.push({query:"individualAdd",callback:e=>{const{id:t,...s}=e;i.transaction(["individuals"],"readwrite").objectStore("individuals").add(s).addEventListener("success",(i=>{self.postMessage({query:"individualAdded",data:{id:t,offlineId:i.target.result,tree:e.tree}})}))}}),t.push({query:"individualUpdate",callback:e=>{i.transaction(["individuals"],"readwrite").objectStore("individuals").put(e)}}),t.push({query:"individualRemove",callback:e=>{i.transaction(["individuals"],"readwrite").objectStore("individuals").delete(e.offlineId)}})})({worker:self,listeners:e,database:t}),(e=>{const{listeners:t,database:i}=e;t.push({query:"individualNotesAdd",callback:e=>{i.transaction(["notes"],"readwrite").objectStore("notes").add({individual:e.individual,title:e.title,content:e.content,author:e.author,date:e.date}).addEventListener("success",(t=>{self.postMessage({query:"individualNotesAdded",data:{id:e.id,offlineId:t.target.result,individual:e.individual}})}))}}),t.push({query:"individualNotesUpdate",callback:e=>{i.transaction(["notes"],"readwrite").objectStore("notes").put(e)}}),t.push({query:"individualNotesRemove",callback:e=>{i.transaction(["notes"],"readwrite").objectStore("notes").delete(e.offlineId)}})})({worker:self,listeners:e,database:t});const i=t.transaction(["trees","individuals","notes"],"readwrite"),n=new Promise(((e,t)=>{const s={},n=Object.values(i.objectStoreNames);for(const[r,a]of n.entries()){const d=i.objectStore(a).getAll();d.addEventListener("success",(t=>{s[t.target.source.name]=t.target.result,r===n.length-1&&e(s)})),d.addEventListener("error",(e=>{t("[persistence:indexeddb-remote] error while retrieving store results",e)}))}})),r=await n;self.postMessage({query:"log",data:{type:"debug",message:"[persistence:indexeddb-remote] stores data retrieved..."}}),self.postMessage({query:"load",data:r})})),s.addEventListener("upgradeneeded",(e=>{self.postMessage({query:"log",data:{type:"debug",message:"[persistence:indexeddb-remote] upgradeneeded"}});const t=e.target.result;t.objectStoreNames.contains("trees")||t.createObjectStore("trees",{autoIncrement:!0,keyPath:"id"}),t.objectStoreNames.contains("individuals")||t.createObjectStore("individuals",{autoIncrement:!0,keyPath:"id"}),t.objectStoreNames.contains("notes")||t.createObjectStore("notes",{autoIncrement:!0,keyPath:"id"})})),s.addEventListener("error",(e=>{self.postMessage({query:"log",data:{type:"debug",message:"[persistence:indexeddb-remote] An error occured while trying to open the database."}})}))}}),self.postMessage({query:"log",data:{type:"debug",message:"[persistence:indexeddb-remote] Loaded"}})}.toString().replace(/^function.+?{/,"").slice(0,-1)));function Pi(e){const t=new xi,i=new _({geneatree:t});t.listen("log",(e=>{const{message:i=null,type:s=u.TYPE.INFO}=e,n=t.log(i,e.data,s);t.emit("log added",n)})),t.listen("logs clear",(()=>{const e=t.logs.slice();for(const i of e)t.emit("log remove",i)})),t.listen("log remove",(e=>{t.logs.splice(t.logs.indexOf(e)),t.emit("log removed",e)})),t.listen("reboot",(e=>{i.remove(),Pi(e)})),t.emit("log",{message:"Application started"}),a.run(y,{binding:i,parentNode:document.body}),e&&t.emit("osdSet",e),(e=>{const{geneatree:t}=e;t.emit("log",{type:u.TYPE.DEBUG,message:"[persistence:localStorage] Module loaded"}),null!==localStorage.getItem("settings")&&(t.settings=JSON.parse(localStorage.getItem("settings"))),t.listen("settingsSet",(e=>{t.emit("log",{type:u.TYPE.DEBUG,message:"[ui] settingsSet",data:e}),t.settings={...t.settings,...e},localStorage.setItem("settings",JSON.stringify(t.settings)),t.emit("settingsSaved")}))})({geneatree:t}),(e=>{const{geneatree:t}=e;let i=null;t.emit("log",{type:u.TYPE.DEBUG,message:"[persistence:socket] Loaded"});let s=t.settings.offline;s?(t.emit("log",{type:u.TYPE.INFO,message:"Offline mode enabled"}),t.emit("log",{type:u.TYPE.DEBUG,message:"[persistence:socket] Offline mode: Skipping socket"})):i=S(e),t.listen("settingsSaved",(()=>{s&&!t.settings.offline?(t.emit("log",{type:u.TYPE.INFO,message:"Offline mode set to disabled"}),t.emit("log",{type:u.TYPE.DEBUG,message:"[persistence:socket] Offline mode disabled: Connecting..."}),i=S(e)):!s&&t.settings.offline&&(t.emit("log",{type:u.TYPE.INFO,message:"Offline mode set to enabled"}),t.socketState!==C&&t.socketState!==I||(t.emit("log",{type:u.TYPE.DEBUG,message:"[persistence:socket] Offline mode enabled: Closing socket..."}),i.close(1e3))),s=t.settings.offline}))})({geneatree:t}),(e=>{const{geneatree:t}=e,i=new Di;t.emit("osdSet",{text:"Connecting to local...",type:"info"}),t.emit("log",{type:u.TYPE.DEBUG,message:"[persistence:indexeddb-local] Module Loaded"});const s=[],n={...e,worker:i,listeners:s};let r=!1;s.push({query:"log",callback:e=>{t.emit("log",e)}}),s.push({query:"load",callback:e=>{const i=s.findIndex((e=>"load"===e.query));s.splice(i,1),r=!0,(e=>{const{geneatree:t,worker:i,listeners:s}=e;t.listen("persistenceIndexeddbClear",(e=>{i.postMessage({query:"clear"})})),s.push({query:"clearSuccess",callback:e=>{t.emit("reboot",{text:"IndexedDB cleared",type:"info"})}}),s.push({query:"clearError",callback:e=>{t.emit("osdSet",{text:"Could not clear IndexedDB",type:"info"})}})})(n),(e=>{const{geneatree:t,worker:i,listeners:s}=e;s.push({query:"treeAdded",callback:e=>{const s=t.trees.list.find((t=>t.id===e.id));s.offlineId=e.offlineId,i.postMessage({query:"individualAdd",data:{id:s.individuals[0].id,tree:s.offlineId,meta:s.individuals[0].meta,cellX:s.individuals[0].cellX,cellY:s.individuals[0].cellY}})}}),t.trees.listen("added",(e=>{-1===e.offlineId&&-1===e.networkId&&i.postMessage({query:"treeAdd",data:{meta:e.meta,id:e.id}})})),t.trees.listen("updated",(e=>{-1!==e.offlineId&&i.postMessage({query:"treeUpdate",data:{id:e.tree.offlineId,meta:e.form}})})),t.trees.listen("removed",(e=>{-1!==e.offlineId&&i.postMessage({query:"treeRemove",data:{offlineId:e.offlineId}})}))})(n),(e=>{const{geneatree:t,worker:i,listeners:s}=e;s.push({query:"individualAdded",callback:e=>{t.trees.list.find((t=>t.offlineId===e.tree)).individuals.find((t=>t.id===e.id)).offlineId=e.offlineId}}),t.individuals.listen("added",(e=>{-1===e.offlineId&&-1===e.networkId&&i.postMessage({query:"individualAdd",data:{id:e.id,tree:e.tree.offlineId,meta:e.meta,cellX:e.cellX,cellY:e.cellY}})})),t.individuals.listen("updated",(e=>{-1!==e.offlineId&&i.postMessage({query:"individualUpdate",data:{id:e.individual.offlineId,tree:e.individual.tree.offlineId,meta:e.form,x:e.individual.cellX,y:e.individual.cellY}})})),t.individuals.listen("removed",(e=>{-1!==e.offlineId&&i.postMessage({query:"individualRemove",data:{offlineId:e.offlineId,tree:e.tree.offlineId}})}))})(n),(e=>{const{geneatree:t,worker:i,listeners:s}=e;s.push({query:"individualNotesAdded",callback:e=>{t.trees.list.find((t=>t.individuals.find((t=>t.offlineId===e.individual)))).individuals.find((t=>t.offlineId===e.individual)).notes.find((t=>t.id===e.id)).offlineId=e.offlineId}}),t.individuals.listen("notesAdded",(e=>{-1===e.offlineId&&-1===e.networkId&&i.postMessage({query:"individualNotesAdd",data:{id:e.id,individual:e.individual.offlineId,title:e.title,content:e.content,author:e.author,date:e.date}})})),t.individuals.listen("notesUpdated",(e=>{-1!==e.offlineId&&i.postMessage({query:"individualNotesUpdate",data:{id:e.note.offlineId,...e.form,individual:e.note.individual.offlineId,date:e.note.date}})})),t.individuals.listen("notesRemoved",(e=>{-1!==e.offlineId&&i.postMessage({query:"individualNotesRemove",data:{offlineId:e.offlineId}})}))})(n),t.emit("osdSet",{text:"Connected to local",type:"valid"}),t.emit("log",{type:u.TYPE.DEBUG,message:"[persistence:indexeddb-local] data retrieved..."});const a=e.trees.map((t=>(t.individuals=e.individuals.filter((e=>e.tree.toString()===t.id.toString())),t.individuals=t.individuals.map((t=>(t.notes=e.notes.filter((e=>e.individual.toString()===t.id.toString())),t))),t)));for(const e of a)e.individuals[0].offlineId=e.individuals[0].id,t.trees.emit("add",[{id:e.id,type:"offline",meta:e.meta},e.individuals]);t.emit("indexedbdbLoaded")}}),i.addEventListener("message",(e=>{const{query:i,data:n}=e.data;t.emit("log",{type:u.TYPE.DEBUG,message:`[persistence:indexeddb-local] Received query: ${i}`,data:n});const r=s.filter((e=>e.query===i));r.length>=1?r.forEach((e=>e.callback(n))):t.emit("log",{type:u.TYPE.DEBUG,message:`[persistence:indexeddb-local] Unrecognized query: ${i}`})})),i.addEventListener("error",(e=>{t.emit("log",{type:u.TYPE.DEBUG,message:"[persistence:indexeddb-local] An error occured",event:e}),r||t.emit("osdSet",{type:"error",text:"[persistence:indexeddb-local] Unable to retrieve local data"})})),i.postMessage({query:"load",data:{databaseName:window.INDEXEDDB_DATABASE_NAME,databaseVersion:window.INDEXEDDB_DATABASE_VERSION}}),t.emit("log",{type:u.TYPE.DEBUG,message:"[persistence:indexeddb-local] waiting for remote to load..."})})({geneatree:t})}window.addEventListener("load",(function(){Pi()}))}(router);
