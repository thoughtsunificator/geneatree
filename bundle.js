window.SOCKET_URL="ws://localhost:8080",window.INDEXEDDB_DATABASE_NAME="geneatree",window.INDEXEDDB_DATABASE_VERSION=1,function(){"use strict";class e{constructor(e){this._observable=e}get observable(){return this._observable}}class t{constructor(e,t,i){this._observable=e,this._eventName=t,this._callback=i}remove(){this._observable.removeListener(this)}get eventName(){return this._eventName}get callback(){return this._callback}}class i{constructor(){this._listeners={}}listen(e,i,s=!1){Array.isArray(this._listeners[e])||(this._listeners[e]=[]);const n=new t(this,e,i);return s?this._listeners[e].unshift(n):this._listeners[e].push(n),n}removeListener(e){this._listeners[e.eventName]=this._listeners[e.eventName].filter((t=>t!==e))}emit(e,t){if(Array.isArray(this._listeners[e]))for(const i of this._listeners[e].slice())i.callback(t)}}class s{constructor(t,s=new e(new i)){this._identifier={},this._properties={...t},this._parent=null,this._root=null,this._model=null,this._children=[],this._listeners=[],this._eventListener=s}get identifier(){return this._identifier}get properties(){return this._properties}get root(){return this._root}get model(){return this._model}get eventListener(){return this._eventListener}listen(e,t,i,s=!1){const n=e.listen(t,i,s);return s?this._listeners.unshift(n):this._listeners.push(n),n}run(e,t){t.binding._parent=this,this._children.push(t.binding),t.binding._properties={...this.properties,...t.binding.properties},r.run(e,{parentNode:this.root,...t})}remove(){const e=this._listeners.slice();for(const t of e)t.remove();const t=this._children.slice();for(const e of t)e.remove();null!==this._parent&&(this._parent._children=this._parent._children.filter((e=>e!==this))),this.root.remove()}onCreated(){}async onRendered(){}}class n{static PROPERTIES=["tagName","children","identifier","model","binding","properties"];static METHOD={APPEND_CHILD:"APPEND_CHILD",INSERT_BEFORE:"INSERT_BEFORE",REPLACE_NODE:"REPLACE_NODE",WRAP_NODE:"WRAP_NODE",PREPEND:"PREPEND"};static run(e,{parentNode:t,binding:i=new s,method:r=n.METHOD.APPEND_CHILD}={}){const a=n.createNode(t,e,i);i._root=a,i._model=e;for(const e of Object.getOwnPropertyNames(Object.getPrototypeOf(i.eventListener)).filter((e=>"constructor"!==e&&"function"==typeof i.eventListener[e])))i.listen(i.eventListener.observable,e,i.eventListener[e].bind(i),!0);i.onCreated(),r===n.METHOD.APPEND_CHILD?t.appendChild(a):r===n.METHOD.INSERT_BEFORE?t.parentNode.insertBefore(a,t):r===n.METHOD.REPLACE_NODE?t.replaceWith(a):r===n.METHOD.WRAP_NODE?(a.appendChild(t.cloneNode(!0)),t.replaceWith(a)):r===n.METHOD.PREPEND&&t.prepend(a),i.onRendered()}static createNode(e,t,i){const{tagName:s,children:r=[]}=t,a=e.ownerDocument.createElement(s);Object.keys(t).filter((e=>!1===n.PROPERTIES.includes(e))).forEach((function(e){a[e]=t[e]}));for(const t of r)if(!0===Object.prototype.hasOwnProperty.call(t,"model")){let e;!0===Object.prototype.hasOwnProperty.call(t,"binding")&&(e=new t.binding({...i.properties,...t.properties}),!0===Object.prototype.hasOwnProperty.call(t,"identifier")&&(i.identifier[t.identifier]=e)),i.run(t.model,{parentNode:a,binding:e})}else{const s=n.createNode(e,t,i);a.appendChild(s)}return!0===Object.prototype.hasOwnProperty.call(t,"identifier")&&(i.identifier[t.identifier]=a),a}}var r=n;class a{constructor(e,t=s,i={}){this._definition=e,this._binding=t,this._properties=i}get definition(){return this._definition}get binding(){return this._binding}get properties(){return this._properties}}class d extends e{treeFilter(e){const{geneatree:t}=this.properties,i=t.trees.find(e);t.trees.list.filter((e=>!1===i.includes(e))).forEach((e=>e.emit("tabHide"))),i.forEach((e=>e.emit("tabShow"))),t.emit("treeFiltered",{trees:i,query:e}),1===i.length&&i[0]!==t.trees.selected?t.emit("treeSelect",i[0]):null!==t.trees.selected&&1!==i.length&&t.emit("treeUnselect",t.trees.selected)}treeFilterReset(){const{geneatree:e}=this.properties;this.identifier.input.value="",e.trees.forEach((e=>e.emit("tabShow")))}}var o=e=>({tagName:"div",className:"tree",tabIndex:0,children:[{tagName:"div",textContent:"🌲"},{tagName:"div",identifier:"name",style:"overflow: hidden",textContent:e.meta.name,title:e.meta.name},{tagName:"button",identifier:"editButton",className:"edit-icon",title:"Editer",textContent:"📝"}]});class l extends e{select(){this.root.classList.add("active"),this.properties.geneatree.emit("osdSet",{text:`Tree ${this.properties.tree.meta.name} selected`,type:"valid"})}unselect(){this.root.classList.remove("active")}update(){this.identifier.name.textContent=this.properties.tree.meta.name,this.identifier.name.title=this.properties.tree.meta.name}remove(){this.root.remove()}tabHide(){this.root.style.display="none"}tabShow(){this.root.style.display=""}}let c=class extends s{constructor(e){super(e,new l(e.tree))}onCreated(){const{geneatree:e,tree:t}=this.properties;this.root.addEventListener("focus",(()=>{e.trees.selected!==t&&e.trees.emit("select",t)})),this.identifier.editButton.addEventListener("click",(()=>e.router.emit("browse",{path:"/tree",properties:{tree:t}})))}};class h extends e{listAdd(e){const{geneatree:t}=this.properties;t.trees.list.length>1?this.run(o(e),{method:r.METHOD.PREPEND,parentNode:this.root,binding:new c({geneatree:t,tree:e})}):this.run(o(e),{parentNode:this.root,binding:new c({geneatree:t,tree:e})})}}var p={tagName:"div",id:"trees",children:[{tagName:"div",className:"logo",textContent:"geneatree"},{tagName:"div",identifier:"filterAdd",style:"display: grid; border-bottom: 1px solid #0000002b;",children:[{model:{tagName:"div",children:[{tagName:"input",className:"filter",identifier:"input",placeholder:"Filtrer trees"}]},binding:class extends s{constructor(e){super(e,new d(e.geneatree))}onCreated(){const{geneatree:e}=this.properties;this.identifier.input.addEventListener("input",(t=>{e.trees.list.length>=1&&e.emit("treeFilter",t.target.value)}))}}}]},{model:{tagName:"div",style:"overflow-y: auto; overflow-x: hidden;"},binding:class extends s{constructor(e){super(e,new h(e.geneatree.trees))}}}]};class u extends i{static TYPE={INFO:"info",WARNING:"warning",ERROR:"error",DEBUG:"debug"};constructor(e,t,i){super(),this._message=e,this._data=t,this._type=i,this._date=new Date}get message(){return this._message}get data(){return this._data}get type(){return this._type}get date(){return this._date}}class m extends e{add(e){const{geneatree:t}=this.properties;t.emit("log",{type:u.TYPE.DEBUG,message:"[ui] [tree] add",data:e});const i=t.trees.add(e[0].meta);"online"===e[0].type?i.networkId=e[0]._id:"offline"===e[0].type&&(i.offlineId=e[0].id);for(const[t,s]of e[1].entries()){const n=i.addIndividual({...s.meta,decujus:0===t});"online"===e[0].type?n.networkId=s._id:"offline"===e[0].type&&(n.offlineId=s.id),s.x&&(n.cellX=s.x),s.y&&(n.cellY=s.y),s.notes&&s.notes.forEach((t=>{const i=n.addNote(t.title,t.content,t.author,new Date(t.date));"online"===e[0].type?i.networkId=t._id:"offline"===e[0].type&&(i.offlineId=t.id)}))}t.trees.emit("listAdd",i),t.trees.emit("added",i)}update(e){const{geneatree:t}=this.properties;t.emit("log",{type:u.TYPE.DEBUG,message:"[ui] [tree] update",data:e});for(const t in e.form)e.tree.meta[t]=e.form[t];e.tree.emit("update"),t.trees.emit("updated",e)}remove(e){const{geneatree:t}=this.properties;t.emit("log",{type:u.TYPE.DEBUG,message:"[ui] [tree] remove",data:e}),t.trees.remove(e),e.emit("remove"),t.trees.emit("removed",e),t.router.emit("browse",{path:"/"})}select(e){const{geneatree:t}=this.properties;t.emit("log",{type:u.TYPE.DEBUG,message:"[ui] [tree] select",data:e}),null!==t.trees.selected&&t.trees.emit("unselect",t.trees.selected),t.trees.selected=e,e.emit("select"),t.trees.list.filter((t=>t!==e)).forEach((e=>e.emit("unselect"))),this.root.style.display="",t.trees.emit("selected",e),t.router.emit("browse",{path:"/viewer",properties:{tree:e}})}unselect(e){const{geneatree:t}=this.properties;t.emit("log",{type:u.TYPE.DEBUG,message:"[ui] [tree] unselect",data:e}),t.trees.selected.individuals.forEach((e=>e.emit("nodeRemove"))),t.trees.selected.selectedIndividual=null,t.trees.selected=null,e.emit("unselect"),e.individuals.forEach((e=>e.emit("nodeRemove"))),t.trees.emit("unselected",e)}toggle(e){const{geneatree:t}=this.properties;t.emit("log",{type:u.TYPE.DEBUG,message:"[ui] [tree] toggle",data:e}),!0===e.toggle?this.root.style.display="grid":this.root.style.display="none",t.trees.toggled=e.toggle}}var g=e=>({tagName:"button",identifier:"viewer",textContent:e.title});let f=class extends s{constructor(e){super(e)}onCreated(){const{path:e,geneatree:t}=this.properties;this.listen(t.router,"browse",(t=>{t.path===e?(t.osd&&this.properties.geneatree.emit("osdSet",{text:`Navigated to ${this.properties.title}`,type:"info"}),this.root.classList.add("active")):this.root.classList.remove("active")})),this.root.addEventListener("click",(()=>t.router.emit("browse",{path:e,osd:!0})))}};class v extends s{onCreated(){const{duration:e=3500}=this.properties;setTimeout((async()=>{let e=1;for(let t=0;t<10;t++)await new Promise((i=>{setTimeout((()=>{e-=.1,this.root.style.opacity=e,i()}),5*t)}));this.remove()}),e)}}var N={tagName:"div",id:"geneatree",children:[{model:p,binding:class extends s{constructor(e){super(e,new m(e.geneatree.trees))}onCreated(){this.properties}}},{tagName:"div",id:"router",identifier:"router",children:[{tagName:"button",title:"Afficher ou masquer la liste des trees",identifier:"treesToggle",id:"trees-toggle",textContent:"☰"},{model:{tagName:"nav",id:"navigation",children:[{tagName:"div",className:"items",identifier:"items"}]},identifier:"navigation",binding:class extends s{constructor(e){super(e)}browse(e){this.properties.geneatree.router.emit("browse",{path:e})}onCreated(){this.properties,this.run(g({title:"🏠 Home"}),{parentNode:this.identifier.items,binding:new f({title:"🏠 Home",path:"/"})}),this.run(g({title:"⚙️ Settings"}),{parentNode:this.identifier.items,binding:new f({title:"⚙️ Settings",path:"/settings"})}),this.run(g({title:"🪵 Logs"}),{parentNode:this.identifier.items,binding:new f({title:"🪵 Logs",path:"/logs"})}),this.run(g({title:"ℹ️ About"}),{parentNode:this.identifier.items,binding:new f({title:"ℹ️ About",path:"/about"})})}}}]},{model:{tagName:"div",id:"osd"},binding:class extends s{constructor(e){super(e)}onCreated(){const{geneatree:e}=this.properties;this.listen(e,"osdSet",(t=>{e.emit("log",{type:u.TYPE.DEBUG,message:"[ui] osdSet",data:t}),e.settings.osd&&this.run((e=>({tagName:"div",className:`message ${e.type}`,textContent:e.text}))(t),{method:r.METHOD.PREPEND,binding:new v({duration:t.duration})})}))}}}]},y={tagName:"div",className:"router",identifier:"view"};let w=class{static TYPE={PATH:"PATH",PARAMETER:"PARAMETER",SEPARATOR:"SEPARATOR"};constructor(e,t,i){this._type=e,this._buffer=t,this._bufferIndex=i}get type(){return this._type}get buffer(){return this._buffer}get bufferIndex(){return this._bufferIndex}};class b{static SEPARATOR="/";static PARAMETER_PREFIX="{";static PARAMETER_SUFFIX="}";static tokenize(e){const t=[],i=[...e];let s="";for(const[e,n]of i.entries()){s+=n;const r=e-s.length+1;if(s[0]===b.PARAMETER_PREFIX&&n===b.PARAMETER_SUFFIX){if(1===s.length)continue;t.push(new w(w.TYPE.PARAMETER,s,r)),s=""}else if(s[0]===b.PARAMETER_PREFIX){if(1===s.length)continue;n===b.SEPARATOR?(t.push(new w(w.TYPE.PATH,s.slice(-1),r)),t.push(new w(w.TYPE.SEPARATOR,n,r-s.length)),s=""):e===i.length-1&&t.push(new w(w.TYPE.PATH,s,r))}else if(n===b.SEPARATOR)t.push(new w(w.TYPE.SEPARATOR,s,r)),s="";else{const e=t[t.length-1];e&&e.type===w.TYPE.PATH?t[t.length-1]=new w(w.TYPE.PATH,e.buffer+s,e.bufferIndex):t.push(new w(w.TYPE.PATH,s,r)),s=""}}return t}}class x{constructor({match:e,model:t,middleware:i,layout:s}={}){this._match=e,this._model=t,this._middleware=i,this._layout=s}get match(){return this._match}get model(){return this._model}get middleware(){return this._middleware}get layout(){return this._layout}}class E{constructor(e,t={}){this._route=e,this._parameters=t}get route(){return this._route}get parameters(){return this._parameters}}var _=e=>({tagName:"div",textContent:`No route was found for path "${e.router.path}"`});class I extends i{static TYPE={VIRTUAL:"VIRTUAL",PATHNAME:"PATHNAME",HASH:"HASH"};constructor({routes:e,type:t=I.TYPE.VIRTUAL,errorRoute:i,initialPath:s="/",defaultLayout:n,basePath:r=""}={}){super(),this._routes=e,this._type=t,this._errorRoute=i||new x({model:new a(_)}),this._initialPath=s,this._view=null,this._path=null,this._defaultLayout=n,this._basePath=r}match(e){const t=b.tokenize(e);"/"===t[t.length-1]?.buffer&&t.pop();for(const e of this.routes){const i=[],s=b.tokenize(e.match);if("/"===s[s.length-1]?.buffer&&s.pop(),s.length===t.length){for(const[e,n]of t.entries())(s[e].buffer===n.buffer||s[e].type===w.TYPE.SEPARATOR||s[e].type===w.TYPE.PARAMETER&&n.type===w.TYPE.PATH)&&i.push(s[e]);if(i.length===t.length){const i={};for(const[e,n]of t.entries())s[e].type===w.TYPE.PARAMETER&&n.type===w.TYPE.PATH&&(i[s[e].buffer.slice(1,-1)]=decodeURIComponent(n.buffer));return new E(e,i)}}}return null}get routes(){return this._routes}get type(){return this._type}get errorRoute(){return this._errorRoute}get initialPath(){return this._initialPath}get view(){return this._view}get path(){return this._path}get defaultLayout(){return this._defaultLayout}get basePath(){return this._basePath}}class C extends i{constructor(e={}){super(),this._parameters=e}get parameters(){return this._parameters}get binding(){return this._binding}set binding(e){this._binding=e}}class S{constructor(e,t={}){this._path=e,this._properties=t}get path(){return this._path}get properties(){return this._properties}}class A extends e{navigate(e){let t=e.path;this.properties.router.type===I.TYPE.HASH&&(t=`#${e.path}`),this.root.ownerDocument.defaultView.history.pushState({},null,`${this.properties.router.basePath}${t}`),this.properties.router.emit("browse",e)}browse(e){const t=this.properties.router.match(e.path);if(t){if(t.route.middleware&&t.route.middleware(this.properties))return;this.properties.router.emit("routeSet",{match:t,link:e})}else this.properties.router.emit("routeSet",{match:new E(this.properties.router.errorRoute),link:new S(e.path,{path:e.path})})}routeSet(e){const{match:t,link:i}=e;null!==this.properties.router.view&&(this.layoutBinding?(this.layoutBinding.remove(),this._layoutBinding=null):this.properties.router.view.binding.remove()),this.properties.router._path=i.path,this.properties.router._view=new C(t.parameters),this.properties.router.view.binding=new t.route.model.binding({...this.properties,...t.route.model.properties,...i.properties});let s=t.route.model.definition({...this.properties,...t.route.model.properties,...i.properties}),n=this;t.route.layout?(n=new t.route.layout.binding(t.route.layout.properties),this.run(t.route.layout.definition,{binding:n})):this.properties.router.defaultLayout&&(n=new this.properties.router.defaultLayout.binding(this.properties.router.defaultLayout.properties),this.run(this.properties.router.defaultLayout.definition,{binding:n})),n!==this&&(this._layoutBinding=n),n.run(s,{parentNode:n.identifier.view,binding:this.properties.router.view.binding})}}class T extends s{constructor(e){super(e,new A(e.router))}onCreated(){const{router:e}=this.properties;if(this.root.ownerDocument.defaultView.addEventListener("popstate",(()=>{if(e.type===I.TYPE.HASH){let t=this.root.ownerDocument.location.hash.slice(1);""===t?e.emit("navigate",new S("/")):e.emit("browse",new S(t))}else e.type===I.TYPE.PATHNAME&&e.emit("browse",new S(this.root.ownerDocument.location.pathname.slice(e.basePath.length)))})),null!==e.initialPath)if(e.type===I.TYPE.VIRTUAL)e.emit("browse",new S(e.initialPath));else{let t;e.type===I.TYPE.PATHNAME&&"/"!==this.root.ownerDocument.location.pathname.slice(e.basePath.length)?t=this.root.ownerDocument.location.pathname.slice(e.basePath.length):e.type===I.TYPE.HASH&&""!==this.root.ownerDocument.location.hash.slice(1)&&(t=this.root.ownerDocument.location.hash.slice(1)),t?e.emit("browse",new S(t)):e.emit("navigate",new S(e.initialPath))}}get path(){return this._path}get view(){return this._view}get layoutBinding(){return this._layoutBinding}}class R extends e{settingsSaved(){const e=`theme-${this.properties.geneatree.settings.theme}`;this.root.classList.contains(e)||(this.root.classList.remove(...P.map((e=>`theme-${e}`))),this.root.classList.add(e))}}const P=["white","pattern","dark"],L=["geneatree","GEDCOM","PNG"],k=["json"];class O extends s{constructor(e){super(e,new R(e.geneatree))}onCreated(){const{geneatree:e}=this.properties;this.root.classList.add(`theme-${e.settings.theme}`),this.identifier.treesToggle.addEventListener("click",(()=>e.trees.emit("toggle",{toggle:!e.trees.toggled}))),this.listen(e.trees,"toggle",(e=>{!0===e.toggle?this.identifier.router.style.gridColumn="":this.identifier.router.style.gridColumn="span 2"})),this.listen(e.router,"browse",(t=>{"/viewer"===t.path?this.identifier.router.classList.add("viewer"):(e.trees.selected&&e.trees.emit("unselect",e.trees.selected),this.identifier.router.classList.remove("viewer"))})),this.listen(e.explorer,"dragStarted",(()=>{this.root.style.userSelect="none"})),this.listen(e.explorer,"dragEnded",(()=>{this.root.style.userSelect=""})),this.run(y,{method:r.METHOD.INSERT_BEFORE,parentNode:this.identifier.navigation.root,binding:new T({router:e.router})})}}const D="SOCKET_STATE_CONNECTING",B="SOCKET_STATE_CONNECTED";function M(e){const{geneatree:t}=e;t.emit("osdSet",{text:"Connecting to remote persistence layer...",type:"info"}),t.emit("log",{type:u.TYPE.INFO,message:"Connecting to remote persistence layer..."}),t.emit("log",{type:u.TYPE.DEBUG,message:"[persistence:socket] Connecting..."}),t.socketState=D;const i=new WebSocket(window.SOCKET_URL),s=[],n={...e,socket:i,listeners:s};return(e=>{const{geneatree:t,socket:i,listeners:s}=e;s.push({query:"treeAdded",callback:e=>{const s=t.trees.list.find((t=>t.id===e.id));s.networkId=e.networkId,1===i.readyState&&i.send(JSON.stringify({query:"individualAdd",data:{id:s.individuals[0].id,tree:s.networkId,meta:s.individuals[0].meta,cellX:s.individuals[0].cellX,cellY:s.individuals[0].cellY}}))}}),t.trees.listen("added",(e=>{1===i.readyState&&-1===e.networkId&&-1===e.offlineId&&i.send(JSON.stringify({query:"treeAdd",data:{meta:e.meta,id:e.id}}))})),t.trees.listen("updated",(e=>{1===i.readyState&&i.send(JSON.stringify({query:"treeUpdate",data:{networkId:e.tree.networkId,form:e.form}}))})),t.trees.listen("removed",(e=>{1===i.readyState&&i.send(JSON.stringify({query:"treeRemove",data:{networkId:e.networkId}}))}))})(n),(e=>{const{geneatree:t,socket:i,listeners:s}=e;s.push({query:"individualAdded",callback:e=>{t.trees.list.find((t=>t.networkId===e.tree)).individuals.find((t=>t.id===e.id)).networkId=e.networkId}}),t.individuals.listen("added",(e=>{1===i.readyState&&-1===e.networkId&&-1===e.offlineId&&i.send(JSON.stringify({query:"individualAdd",data:{id:e.id,tree:e.tree.networkId,meta:e.meta,cellX:e.cellX,cellY:e.cellY}}))})),t.individuals.listen("updated",(e=>{1===i.readyState&&-1!==e.networkId&&i.send(JSON.stringify({query:"individualUpdate",data:{networkId:e.individual.networkId,form:e.form,tree:e.individual.tree.networkId}}))})),t.individuals.listen("removed",(e=>{1===i.readyState&&-1!==e.networkId&&i.send(JSON.stringify({query:"individualRemove",data:{networkId:e.networkId,tree:e.tree.networkId}}))}))})(n),(e=>{const{geneatree:t,socket:i,listeners:s}=e;s.push({query:"individualNotesAdded",callback:e=>{t.trees.list.find((t=>t.individuals.find((t=>t.networkId===e.individual)))).individuals.find((t=>t.networkId===e.individual)).notes.find((t=>t.id===e.id)).networkId=e.networkId}}),t.individuals.listen("notesAdded",(e=>{1===i.readyState&&-1===e.networkId&&-1===e.offlineId&&i.send(JSON.stringify({query:"individualNotesAdd",data:{id:e.id,individual:e.individual.networkId,title:e.title,content:e.content,author:e.author,date:e.date}}))})),t.individuals.listen("notesUpdated",(e=>{1===i.readyState&&-1!==e.networkId&&i.send(JSON.stringify({query:"individualNotesUpdate",data:{networkId:e.note.networkId,form:e.form}}))})),t.individuals.listen("notesRemoved",(e=>{1===i.readyState&&-1!==e.networkId&&i.send(JSON.stringify({query:"individualNotesRemove",data:{networkId:e.networkId}}))}))})(n),s.push({query:"load",callback:e=>{t.emit("osdSet",{text:"Connected to remote persistence layer",type:"valid"});const i=s.findIndex((e=>"initialized"===e.query));s.splice(i,1);const n=e.trees.map((t=>(t.individuals=e.individuals.filter((e=>e.tree.toString()===t._id.toString())),t.individuals=t.individuals.map((t=>(t.notes=e.notes.filter((e=>e.individual.toString()===t._id.toString())),t))),t)));for(const e of n)e.individuals[0].networkId=e.individuals[0]._id,t.trees.emit("add",[{type:"online",_id:e._id,meta:e.meta},e.individuals]);t.emit("socketTLoaded")}}),i.addEventListener("message",(e=>{const{query:i,data:n}=JSON.parse(e.data);t.emit("log",{type:u.TYPE.DEBUG,message:`[persistence:socket] Received query: ${i}`,data:n});const r=s.filter((e=>e.query===i));r.length>=1?r.forEach((e=>e.callback(n))):t.emit("log",{type:u.TYPE.DEBUG,message:`[persistence:socket] Unrecognized query: ${i}`})})),i.addEventListener("open",(()=>{t.socketState=B,t.emit("log",{type:u.TYPE.INFO,message:"Connected to remote persistence layer"}),t.emit("log",{type:u.TYPE.DEBUG,message:"[persistence:socket] Connected"})})),i.addEventListener("error",(e=>{t.emit("log",{type:u.TYPE.DEBUG,message:"[persistence:socket] An error occured",data:e}),t.socketState===B?(t.emit("log",{type:u.TYPE.ERROR,message:"Disconnected from remote"}),t.emit("osdSet",{text:"Disconnected from remote",type:"info"})):t.socketState===D&&(t.emit("log",{type:u.TYPE.ERROR,message:"Failed to connect to remote persistence layer"}),t.emit("osdSet",{text:"Failed to connect to remote persistence layer",type:"error"}))})),i.addEventListener("close",(()=>{t.socketState===B&&(t.emit("log",{type:u.TYPE.INFO,message:"Disconnected from remote"}),t.emit("log",{type:u.TYPE.DEBUG,message:"[persistence:socket] Disconnected"}),t.emit("osdSet",{text:"Connection to the server was terminated",type:"info"})),t.socketState="SOCKET_STATE_DISCONNECTED"})),i}var U=e=>({tagName:"div",id:"view-about",style:"display: grid; grid-gap: 10px",children:[{tagName:"div",className:"title",children:[{tagName:"h3",identifier:"title",style:"text-align: center; padding-top: 10px",textContent:"geneatree v0.0.8"}]},{tagName:"div",className:"releases",children:[{tagName:"div",className:"release",style:"background-color: rgba(128, 128, 128, 0.26);padding: 20px;border-bottom: 2px solid #6868688f;border-radius: 2px;",children:[{tagName:"h4",textContent:"v0.0.1"},{tagName:"ul",children:[{tagName:"li",textContent:"Initial release"}]}]}]}]}),Y=e=>({tagName:"div",id:"view-settings"}),q={tagName:"div",className:"steps",children:[{tagName:"div",className:"indicators",identifier:"indicators"},{tagName:"div",className:"steps",identifier:"steps"}]},F={tagName:"div",className:"step"},G=e=>({tagName:"div",className:"indicator",textContent:e.name});class j extends e{set(){this.root.classList.add("active")}unset(){this.root.classList.remove("active")}}class H extends s{constructor(e){super(e,new j(e.step))}onCreated(){const{step:e,steps:t}=this.properties;this.run(e.model,{binding:new e.binding(e.properties)})}}class $ extends i{static STATE={INITIAL:"INITIAL",DRAFT:"DRAFT",COMPLETED:"COMPLETED"};constructor(e,t,i,s={}){super(),this._name=e,this._model=t,this._binding=i,this._properties=s,this._state=$.STATE.INITIAL,this._active=!1,this._data=null}get name(){return this._name}get model(){return this._model}get binding(){return this._binding}get properties(){return this._properties}get state(){return this._state}set state(e){this._state=e}get active(){return this._active}set active(e){this._active=e}get data(){return this._data}set data(e){this._data=e}}let X=class extends s{constructor(e){super(e)}onCreated(){const{step:e,steps:t}=this.properties;this.listen(e,"reset",(()=>{this.root.classList.remove("completed"),this.root.classList.remove("active"),this.root.classList.remove("draft")})),this.listen(e,"completed",(()=>{this.root.classList.add("completed"),this.root.classList.remove("draft")})),this.listen(e,"set",(()=>{this.root.classList.add("active"),e.state!==$.STATE.COMPLETED&&this.root.classList.add("draft")})),this.listen(e,"unset",(()=>{this.root.classList.remove("active")})),this.root.addEventListener("click",(()=>{e.state!==$.STATE.INITIAL&&t.emit("stepSet",e.name)}))}};class V extends e{reset(){const{steps:e}=this.properties;for(const t of e.steps)e.emit("stepReset",t.name);e.emit("stepSet",e.steps[0].name)}stepReset(e){const{steps:t}=this.properties,i=t.getStepByName(e);t.step===i&&t.emit("stepUnset",i.name),i.state=$.STATE.INITIAL,i.data=null,i.emit("reset")}stepSet(e){const{steps:t}=this.properties;t.step&&t.emit("stepUnset",t.step.name);const i=t.getStepByName(e);t.step=i,i.active=!0,t.step.state=$.STATE.DRAFT,i.emit("set"),t.emit("stepChanged",i)}stepUnset(e){const{steps:t}=this.properties,i=t.getStepByName(e);i.active=!1,i.emit("unset")}stepPrevious(){const{steps:e}=this.properties,t=e.getPreviousStep();t&&e.emit("stepSet",t.name)}stepNext(e){const{steps:t}=this.properties;t.step.data=e,t.step.state=$.STATE.COMPLETED,t.step.emit("completed");const i=t.getNextStep();i?t.emit("stepSet",i.name):t.emit("done")}}class W extends s{constructor(e){super(e,new V(e.steps))}onCreated(){const{steps:e}=this.properties;for(const t of e.steps)this.run(G(t),{parentNode:this.identifier.indicators,binding:new X({step:t})}),this.run(F,{parentNode:this.identifier.steps,binding:new H({step:t})})}}class z extends i{constructor(e){super(),this._steps=e,this._step=null}getStepByName(e){return this.steps.find((t=>t.name===e))}getPreviousStep(){if(null!==this.step){const e=this.steps.indexOf(this.step);if(e>=1)return this.steps[e-1]}return null}getNextStep(){if(null===this.step)return this.steps[0];{const e=this.steps.indexOf(this.step);if(e<this.steps.length-1)return this.steps[e+1]}return null}get steps(){return this._steps}get step(){return this._step}set step(e){this._step=e}}var J=e=>({tagName:"form",className:"form",children:[e,{tagName:"div",className:"form-footer",children:[{tagName:"input",type:"reset"},{tagName:"input",type:"submit"}]}]});class K extends e{focus(){this.identifier[this.keys[0]].focus()}load(e){for(const t in e)if(t in this.identifier)if("INPUT"===this.identifier[t].tagName&&"checkbox"===this.identifier[t].type)this.identifier[t].checked=e[t]||!1;else if("INPUT"===this.identifier[t].tagName&&"radio"===this.identifier[t].type)[...this.root.querySelectorAll(`input[name=${this.identifier[t].name}]`)].find((i=>i.value==e[t])).checked=!0;else if("INPUT"===this.identifier[t].tagName&&"date"===this.identifier[t].type&&e[t]instanceof Date)this.identifier[t].valueAsDate=e[t];else if("SELECT"===this.identifier[t].tagName){let i;i="string"!=typeof e[t]?`${e[t]}`:e[t];for(const e of this.identifier[t].options)if(e.value===i){e.selected=!0;break}}else this.identifier[t].value=e[t]}clear(){for(const e in this.identifier)"INPUT"!==this.identifier[e].tagName||"checkbox"!==this.identifier[e].type&&"radio"!==this.identifier[e].type?"SELECT"===this.identifier[e].tagName?this.identifier[e].selectedIndex=0:(this.identifier[e].tagName,this.identifier[e].value=""):this.identifier[e].checked=!1}submit(){const{form:e}=this.properties,t={};for(const e of this.keys)if("INPUT"===this.identifier[e].tagName&&"checkbox"===this.identifier[e].type)t[e]=this.identifier[e].checked;else if("INPUT"===this.identifier[e].tagName&&"radio"===this.identifier[e].type){const i=this.root.querySelector(`input[name=${this.identifier[e].name}]:checked`);t[e]=i?i.value:null}else"INPUT"===this.identifier[e].tagName&&"file"===this.identifier[e].type?t[e]=this.identifier[e].files:t[e]=this.identifier[e].value;for(const e in t)if("false"===t[e])t[e]=!1;else if("true"===t[e])t[e]=!0;else{const i=parseFloat(t[e]);isNaN(i)||(t[e]=i)}e.emit("submitted",t)}}class Z extends s{constructor(e){super(e,new K(e.form))}onCreated(){const{form:e}=this.properties;this.keys=Object.keys(this.identifier),this.root.addEventListener("submit",(t=>{t.preventDefault(),e.emit("submit")}))}}class Q extends i{constructor(e){super(),this._initialData=e,this._data={}}get initialData(){return this._initialData}get data(){return this._data}}var ee=e=>({tagName:"div",style:"display: contents",children:[{tagName:"h3",className:"title",textContent:e.title},{tagName:"div",children:[{tagName:"label",textContent:"Name:",children:[{tagName:"div",children:[{tagName:"input",required:!0,className:"width-100",identifier:"name"}]}]}]}]}),te=J(ee({title:"Tree"}));class ie extends Z{constructor(e){super({...e,form:new Q})}onCreated(){super.onCreated(),this.listen(this.properties.step,"set",(e=>{this.properties.form.emit("focus")})),this.listen(this.properties.form,"submitted",(e=>this.properties.steps.emit("stepNext",e)))}}var se=e=>({tagName:"div",style:"display: contents",children:[{tagName:"h3",className:"title",textContent:e.title},{tagName:"div",children:[{tagName:"label",textContent:"Birth name:",children:[{tagName:"div",children:[{identifier:"birthName",className:"width-100",tagName:"input"}]}]}]},{tagName:"div",children:[{tagName:"label",textContent:"First name:",children:[{tagName:"div",children:[{identifier:"firstName",className:"width-100",tagName:"input"}]}]}]},{tagName:"div",children:[{tagName:"label",textContent:"Last name:",children:[{tagName:"div",children:[{identifier:"lastName",className:"width-100",tagName:"input"}]}]}]},{tagName:"div",children:[{tagName:"label",textContent:"Gender:",children:[{tagName:"div",children:[{tagName:"select",className:"width-100",identifier:"gender",children:[{tagName:"option",textContent:"Inconnu",value:"unknown"},{tagName:"option",value:"man",style:"background-color: lightblue",textContent:"Homme"},{tagName:"option",value:"woman",style:"background-color: pink",textContent:"Femme"},{tagName:"option",value:"other",textContent:"Autre"}]}]}]}]},{tagName:"div",children:[{tagName:"label",textContent:"Birth date:",children:[{tagName:"div",children:[{tagName:"input",identifier:"birthDate",className:"width-100",type:"date"}]}]}]},{tagName:"div",children:[{tagName:"label",textContent:"Birth place:",children:[{tagName:"div",children:[{identifier:"birthPlace",className:"width-100",tagName:"input"}]}]}]},{tagName:"div",children:[{tagName:"label",textContent:"Death date",children:[{tagName:"div",children:[{tagName:"input",identifier:"deathDate",className:"width-100",type:"date"}]}]}]},{tagName:"div",children:[{tagName:"label",textContent:"Death place:",children:[{tagName:"div",children:[{identifier:"deathPlace",className:"width-100",tagName:"input"}]}]}]},{tagName:"div",children:[{tagName:"label",textContent:"Address:",children:[{tagName:"div",children:[{identifier:"address",className:"width-100",tagName:"input"}]}]}]},{tagName:"div",children:[{tagName:"label",textContent:"Work:",children:[{tagName:"div",children:[{identifier:"work",className:"width-100",tagName:"input"}]}]}]}]}),ne=J(se({title:"Decujus"}));class re extends Z{constructor(e){super({...e,form:new Q})}onCreated(){super.onCreated(),this.listen(this.properties.step,"set",(e=>{this.properties.form.emit("focus")})),this.listen(this.properties.form,"submitted",(e=>this.properties.steps.emit("stepNext",e)))}}class ae extends s{onCreated(){const{geneatree:e}=this.properties,t=new z([new $("Tree",te,ie),new $("Decujus",ne,re)]);this.listen(t,"done",(()=>{tree=e.trees.list[e.trees.list.length-1],e.trees.emit("add",[{meta:t.getStepByName("Tree").data},[{meta:t.getStepByName("Decujus").data}]]),e.trees.emit("select",tree),e.router.emit("browse",{path:"/"}),e.emit("osdSet",{text:`Tree ${tree.meta.name} created`,type:"valid"})})),this.run(q,{binding:new W({steps:t})}),t.emit("stepSet","Tree")}}var de=e=>({tagName:"div",id:"view-add-tree"}),oe=e=>({tagName:"div",id:"view-new-tree",children:[{tagName:"h3",className:"title",identifier:"title",textContent:"Add tree"},{tagName:"div",style:"display: grid; grid-gap: 5px",children:[{tagName:"button",identifier:"createButton",tabIndex:1,textContent:"Create a new tree"},{tagName:"button",identifier:"importButton",tabIndex:2,textContent:"Import existing tree"}]}]});class le extends s{onCreated(){const{geneatree:e}=this.properties;this.identifier.createButton.addEventListener("click",(()=>{e.router.emit("browse",{path:"/tree/add"})})),this.identifier.importButton.addEventListener("click",(()=>{e.router.emit("browse",{path:"/tree/import"})}))}}class ce{static NAME_LEVEL="level";static NAME_SEPARATOR="separator";static NAME_IDENTIFIER="identifier";static NAME_REFERENCE="reference";static NAME_INFORMATION="information";static NAME_LINE_FEED="line feed";constructor(e,t,i){this._name=e,this._buffer=t,this._index=i}get name(){return this._name}get buffer(){return this._buffer}get index(){return this._index}}const he="CURSOR_INITIAL",pe="CURSOR_LEVEL",ue="CURSOR_TOKEN_SEPARATOR",me="CURSOR_IDENTIFIER",ge="CURSOR_REFERENCE",fe="CURSOR_INFORMATION",ve="CURSOR_LINE_FEED",Ne=" ",ye=["\r","\n","\r\n","\n\r"],we=[..."0123456789"];class be{constructor(e){this._name=e,this._value=null,this._parentRecord=null,this._records=[]}appendChild(e){e._parentRecord=this,this._records.push(e)}get name(){return this._name}get value(){return this._value}set value(e){this._value=e}get records(){return this._records}get parentRecord(){return this._parentRecord}}function xe(e){const t=function(e){const t=[...e],i=[];let s=he,n=null;const r=[];let a="",d=null;for(const[e,o]of t.entries()){a+=o,null!==n&&(s=n);let l=null;if(e+1<=t.length-1&&(l=t[e+1]),null===l)n=null;else if(l!==Ne||s===fe||s===ue&&r.find((e=>e.name===ce.NAME_IDENTIFIER)))if(ye.includes(l))n=ve;else if(s===he||s===ue&&!r.find((e=>e.name===ce.NAME_LEVEL)))n=pe;else if(s===ue){let i="";for(const s of t.slice(e+1)){if(s===Ne||ye.includes(s))break;i+=s}n="@"===i.slice(0,1)&&"@"===i.slice(-1)?ge:r.find((e=>e.name===ce.NAME_IDENTIFIER))?fe:me}else s===me||s===ge?l===Ne&&(n=ue):s===ve&&(n=pe);else n=ue;if((s===he||s===pe)&&a.trim().length>=1&&n===ue){let i="";for(const s of t.slice(e+1)){if(ye.includes(s))break;s!==Ne&&(i+=s)}[...a.trimStart()].filter((e=>we.includes(e))).length===a.trimStart().length&&i.length>=1?d=new ce(ce.NAME_LEVEL,a.trimStart(),e-a.trimStart().length+1):a=""}else s===ue&&a===Ne?r.length>=1&&(0===i.length||i[i.length-1].name!==ce.NAME_SEPARATOR)&&r.length<5&&null!==l&&!ye.includes(l)?d=new ce(ce.NAME_SEPARATOR,o,e):a="":s===me&&n!==me?r.length>=2&&r.length<5?d=new ce(ce.NAME_IDENTIFIER,a.trim(),e-a.length+1):a="":s===ge&&n!==ge?r.length>=2&&r.length<5&&"@"===a.slice(0,1)&&"@"===a.slice(-1)?d=new ce(ce.NAME_REFERENCE,a.trim(),e-a.length+1):a="":s!==fe||n===fe&&null!==l?s===ve&&(!ye.includes(a)||0!==i.length&&i[i.length-1].name===ce.NAME_LINE_FEED?a="":d=new ce(ce.NAME_LINE_FEED,a,e)):r.length>=3&&r.length<5?d=new ce(ce.NAME_INFORMATION,a,e-a.length+1):a="";null!==d&&(i.push(d),r.push(d),d=null,a=""),s===ve&&r.splice(0,r.length)}return i}(e),i=[],s=[];for(const[e,n]of t.entries())"separator"!==n.name&&"line feed"!==n.name&&s.push(n),"line feed"!==n.name&&e!==t.length-1||(i.push([...s]),s.splice(0,s.length));return i}var Ee=J({tagName:"div",style:"display: contents",children:[{tagName:"h3",textContent:"Import a file",className:"title"},{tagName:"div",children:[{tagName:"label",textContent:"Format:",children:[{tagName:"div",children:[{tagName:"select",style:"width: 100%",identifier:"format",required:!0,children:["geneatree","GEDCOM"].map((e=>({tagName:"option",textContent:e,value:e})))}]}]}]},{tagName:"div",children:[{tagName:"label",textContent:"File:",children:[{tagName:"div",children:[{tagName:"input",required:!0,accept:".GED",type:"file",style:"width: 100%",identifier:"file"}]}]}]}]});class _e extends Z{constructor(e){super({...e,form:new Q})}onCreated(){super.onCreated(),this.listen(this.properties.step,"set",(e=>{this.properties.form.emit("focus")})),this.listen(this.properties.form,"submitted",(e=>this.properties.steps.emit("stepNext",e))),this.identifier.format.addEventListener("change",(e=>{"GEDCOM"===e.target.value?this.identifier.file.accept=".GED":"geneatree"===e.target.value&&(this.identifier.file.accept=".json")}))}}var Ie=J(ee({title:"Tree"}));class Ce extends Z{constructor(e){super({...e,form:new Q})}onCreated(){super.onCreated(),this.listen(this.properties.step,"set",(e=>{this.properties.form.emit("focus")})),this.listen(this.properties.form,"submitted",(e=>this.properties.steps.emit("stepNext",e)))}}class Se extends s{onCreated(){this.properties;const e=new z([new $("Fichier",Ee,_e),new $("Tree",Ie,Ce)]);this.listen(e,"done",(()=>{console.log(e.getStepByName("Fichier").data),console.log(function(e){const t=xe(e),i=[],s=[];for(const e of t){const t=parseInt(e[0].buffer),i=new be(e[1].buffer);3===e.length&&(i.value=e[2].buffer),s.push({level:t,record:i})}for(const[e,t]of s.entries())if(0===t.level)i.push(t.record);else{const i=s.slice(0,e);i.reverse();const n=i.find((e=>e.level===t.level-1));n&&n.record.appendChild(t.record)}return i}(e.getStepByName("Fichier").data))})),this.run(q,{binding:new W({steps:e})}),e.emit("stepSet","Fichier")}}var Ae=e=>({tagName:"div",id:"view-import-tree"}),Te={tagName:"div",className:"tabs",children:[{tagName:"div",className:"indicators",identifier:"indicators"},{tagName:"div",className:"tabs",identifier:"tabs"}]},Re=e=>({tagName:"div",className:"indicator",textContent:e.name}),Pe={tagName:"div",className:"tab"};class Le extends s{constructor(e){super(e)}onCreated(){const{tab:e,tabs:t}=this.properties;this.listen(e,"set",(()=>{this.root.classList.add("active")})),this.listen(e,"unset",(()=>{this.root.classList.remove("active")})),this.root.addEventListener("click",(()=>{t.emit("tabSet",e.name)}))}}class ke extends e{set(){this.root.classList.add("active")}unset(){this.root.classList.remove("active")}}class Oe extends s{constructor(e){super(e,new ke(e.tab))}onCreated(){const{tab:e}=this.properties;this.run(e.model,{binding:new e.binding(e.properties)})}}class De extends i{constructor(e,t,i,s={}){super(),this._name=e,this._model=t,this._binding=i,this._properties=s,this._active=!1}get name(){return this._name}get model(){return this._model}get binding(){return this._binding}get properties(){return this._properties}get active(){return this._active}set active(e){this._active=e}}class Be extends e{tabSet(e){const{tabs:t}=this.properties;t.tab&&t.emit("tabUnset",t.tab.name);const i=t.getTabByName(e);t.tab=i,i.active=!0,i.emit("set"),t.emit("tabChanged",i)}tabUnset(e){const{tabs:t}=this.properties,i=t.getTabByName(e);i.active=!1,t.tab=null,i.emit("unset")}}class Me extends s{constructor(e){super(e,new Be(e.tabs))}onCreated(){const{tabs:e}=this.properties;for(const t of e.tabs)this.run(Re(t),{parentNode:this.identifier.indicators,binding:new Le({tab:t})}),this.run(Pe,{parentNode:this.identifier.tabs,binding:new Oe({tab:t})})}}class Ue extends i{constructor(e){super(),this._tabs=e,this._tab=null}getTabByName(e){return this.tabs.find((t=>t.name===e))}get tabs(){return this._tabs}get tab(){return this._tab}set tab(e){this._tab=e}}var Ye=J(ee({title:"Modifier un arbre"})),qe={tagName:"div",style:"display: grid; grid-gap: 20px",children:[{tagName:"div",className:"title",style:"display: grid;grid-template-columns: auto 1fr;grid-auto-columns: max-content;",children:[{tagName:"h3",identifier:"title",textContent:"Actions"}]},{tagName:"div",identifier:"body"}]},Fe={tagName:"div",className:"tab-individuals",style:"display: grid; grid-gap: 20px",children:[{tagName:"h3",className:"title",identifier:"title",textContent:"Liste des individus"},{tagName:"div",style:"display: grid; grid-gap: 20px;",children:[{tagName:"input",identifier:"searchInput",placeholder:"Filtrer les individus"},{tagName:"div",style:"display: none; text-align: center;",identifier:"placeholder",textContent:"Aucun résultats."},{tagName:"div",className:"grid-gap",style:"display: none;",identifier:"list"}]}]};class Ge extends Z{constructor(e){super({...e,form:new Q})}onCreated(){const{geneatree:e,tree:t}=this.properties;super.onCreated(),this.listen(this.properties.tab,"set",(e=>{this.properties.form.emit("load",this.properties.tree.meta),this.properties.form.emit("focus")})),this.listen(this.properties.form,"submitted",(i=>{e.trees.emit("update",{tree:t,form:i}),e.emit("osdSet",{text:"Tree updated",type:"valid"})}))}}var je=e=>({tagName:"div",style:"display: grid; grid-gap: 5px; background-color: #b29e9e; padding: 10px;",children:[{tagName:"button",identifier:"export",textContent:"Exporter"},{tagName:"button",className:"button-danger",identifier:"delete",textContent:"Supprimer"}]});class He extends s{onCreated(){const{geneatree:e,router:t,tree:i}=this.properties;this.identifier.export.addEventListener("click",(()=>{t.emit("browse",{path:"/export"})})),this.identifier.delete.addEventListener("click",(()=>{e.trees.emit("remove",i),e.emit("osdSet",{text:`Tree ${i.meta.name} removed`,type:"valid"})}))}}var $e=e=>J({tagName:"div",style:"display: contents",children:[{tagName:"label",textContent:"Format",children:[{tagName:"div",children:[{tagName:"select",style:"width: 100%",identifier:"format",children:L.map((e=>({tagName:"option",textContent:e})))}]}]}]});class Xe extends Z{constructor(e){super({...e,form:new Q})}onCreated(){super.onCreated(),this.properties,this.listen(this.properties.form,"submitted",(e=>{console.log(e)}))}}class Ve extends s{onCreated(){const{geneatree:e,tab:t}=this.properties,i=new I({routes:[new x({match:"/",model:new a(je,He)}),new x({match:"/export",model:new a($e,Xe)})]});this.listen(t,"set",(()=>{i.emit("browse",{path:"/"})})),this.run(y,{binding:new T({router:i}),parentNode:this.identifier.body})}}class We extends e{previous(){const{paginator:e}=this.properties;e.emit("offsetSet",e.getPreviousOffset())}next(){const{paginator:e}=this.properties;e.emit("offsetSet",e.getNextOffset())}}var ze={tagName:"div",className:"paginator",children:[{tagName:"div",className:"pagination-content",identifier:"content"},{model:{tagName:"div",className:"pagination-controls",children:[{tagName:"button",className:"pagination-previous",textContent:"←",disabled:!0,identifier:"previous"},{tagName:"div",className:"pagination-indicator",children:[{tagName:"input",type:"number",min:1,value:1,identifier:"jump",className:"pagination-jump"},{tagName:"span",identifier:"totalPages"}]},{tagName:"button",className:"pagination-next",textContent:"→",disabled:!0,identifier:"next"}]},binding:class extends s{constructor(e){super(e,new We(e.paginator.controls))}onCreated(){const{paginator:e}=this.properties;this.listen(e,"itemsChanged",(()=>{e.getMaximumOffset();const t=e.getMaximumPage();this.identifier.totalPages.textContent=`/ ${t}`})),this.listen(e,"offsetChanged",(()=>{const t=e.getMaximumOffset();0===e.offset?this.identifier.previous.disabled=!0:e.offset>0&&(this.identifier.previous.disabled=!1),e.offset===t?this.identifier.next.disabled=!0:t>0&&(this.identifier.next.disabled=!1);const i=e.getCurrentPage();this.identifier.jump.value!==i&&(this.identifier.jump.value=i)})),this.identifier.previous.addEventListener("click",(()=>e.controls.emit("previous"))),this.identifier.next.addEventListener("click",(()=>e.controls.emit("next"))),this.identifier.jump.addEventListener("input",(t=>{const i=e.getMaximumPage();t.target.value<=0?this.identifier.jump.value=1:t.target.value>i&&(this.identifier.jump.value=i);const s=e.getOffsetByPage(parseInt(this.identifier.jump.value));e.emit("offsetSet",s)}))}},identifier:"controls"}]};class Je extends i{}class Ke extends e{itemsSet(e){const{paginator:t}=this.properties;t._items=e.slice(),t.emit("offsetReset"),t.emit("itemsChanged")}offsetSet(e){const{paginator:t}=this.properties;null!==t.page&&t.page.emit("clear"),e<t.limit?e=0:e>t.items.length-1?e=t.getMaximumOffset():e%t.limit!=0&&(e=t.getNearestOffset(e)),t.offset=e;const i=new Je;for(const e of t.getCurrentItems())this.run(e.model(e.properties),{parentNode:this.identifier.content,binding:new e.binding({...e.properties,item:e,page:i})});t.page=i,t.emit("offsetChanged",e)}offsetReset(){const{paginator:e}=this.properties;e.emit("offsetSet",0)}}class Ze extends s{constructor(e){super(e,new Ke(e.paginator))}}class Qe extends s{constructor(e){super(e)}onCreated(){const{page:e}=this.properties;this.listen(e,"clear",(()=>{this.remove()}))}}class et extends i{constructor(e){super(),this._items=[],this._limit=e,this._offset=0,this._page=null,this._controls=new i}getCurrentItems(){return this.items.slice(this.offset,Math.min(this.items.length,this.offset+this.limit))}getNextItems(){const e=this.getNextOffset();return this.items.slice(e,Math.min(this.items.length,e+this.limit))}getPreviousItems(){const e=this.getPreviousOffset();return this.items.slice(e,Math.min(this.items.length,e+this.limit))}getItemsByOffset(e){return this.items.slice(e,Math.min(this.items.length,e+this.limit))}getMaximumOffset(){const e=Math.max(0,this.items.length-this.limit);return this.getNearestOffset(e)}getMaximumPage(){return Math.ceil(this.items.length/this.limit)}getCurrentPage(){return Math.floor((this.offset+this.limit)/this.limit)}getPageByOffset(e){return Math.ceil((e+this.limit)/this.limit)}getOffsetByPage(e){return e*this.limit-this.limit}getPreviousOffset(){return Math.max(0,this.offset-this.limit)}getNextOffset(){const e=this.getMaximumOffset();return Math.min(e,this.offset+this.limit)}getNearestOffset(e){return this.limit*Math.ceil(e/this.limit)}get controls(){return this._controls}get items(){return this._items}get limit(){return this._limit}get offset(){return this._offset}set offset(e){this._offset=e}get page(){return this._page}set page(e){this._page=e}}var tt=e=>({tagName:"div",className:`individual ${e.individual.meta.gender} ${e.individual.meta.decujus?"decujus":""}`,style:"display: grid",title:"Selectionner cet individu",children:[{tagName:"h4",textContent:e.individual.meta.birthName},{tagName:"div",children:[{tagName:"div",textContent:[e.individual.meta.firstName,e.individual.meta.lastName].join(" ")}]}]});let it=class extends Qe{onCreated(){super.onCreated(this.properties),this.properties}};class st extends s{onCreated(){this.paginator=new et(3),this.identifier.searchInput.addEventListener("input",(()=>this.render())),this.run(ze,{parentNode:this.identifier.list,binding:new Ze({paginator:this.paginator,maxShownPages:3})}),this.render()}render(){const e=this.properties.tree.findIndividuals({query:this.identifier.searchInput.value});0===e.length?(this.identifier.placeholder.style.display="",this.identifier.list.style.display="none"):(this.identifier.placeholder.style.display="none",this.identifier.list.style.display="grid",this.paginator.emit("itemsSet",e.map((e=>({model:tt,binding:it,properties:{individual:e}})))))}}class nt extends s{onCreated(){this.properties,this.individualForm=new Q;const e=new Ue([new De("Editer",Ye,Ge),new De("Individus",Fe,st),new De("Actions",qe,Ve)]);this.run(Te,{binding:new Me({tabs:e})}),e.emit("tabSet","Editer")}}var rt=e=>({tagName:"div",id:"view-tree"}),at=e=>({tagName:"div",id:"view-logs",children:[{tagName:"div",style:"padding-top: 10px",identifier:"router"}]}),dt={tagName:"div",id:"tree-viewer-explorer"};var ot={tagName:"div"};class lt extends s{onCreated(){this.properties}}var ct={tagName:"div",title:"Cliquer pour naviguer",className:"map",children:[{model:{tagName:"div",className:"individuals"},binding:class extends s{constructor(e){super(e)}onCreated(){const{geneatree:e}=this.properties;this.listen(e,"treeViewerMinimapCoordinatesUpdated",(e=>{this.root.style.left=e.cursorX+"px",this.root.style.top=e.cursorY+"px"})),this.run(ot,{parentNode:this.root,binding:new lt({})})}}},{model:{tagName:"div",identifier:"cursor",className:"cursor"},binding:class extends s{constructor(e){super(e)}onCreated(){const{geneatree:e}=this.properties;this.listen(e,"treeViewerCoordinatesUpdated",(t=>{const i=t.x/this.root.parentNode.parentNode.parentNode.offsetWidth*100,s=t.y/this.root.parentNode.parentNode.parentNode.offsetHeight*100,n=1*i,r=.5*s;this.root.style.left=n+"px",this.root.style.top=r+"px",e.emit("treeViewerMinimapCoordinatesUpdated",{xPercent:i,yPercent:s,cursorY:r,cursorX:n})}))}}}]};var ht={tagName:"div",id:"tree-viewer-minimap",children:[{model:ct,binding:class extends s{constructor(e){super(e)}getViewerPosition(e,t){const i=this.root.getBoundingClientRect(),s=(e-i.x)/100*100,n=(t-i.y)/50*100;return{x:this.root.parentNode.parentNode.offsetWidth/100*s,y:this.root.parentNode.parentNode.offsetHeight/100*n}}onCreated(){const{geneatree:e}=this.properties;let t=!1;this.root.addEventListener("click",(t=>{const i=this.getViewerPosition(t.clientX,t.clientY);e.explorer.emit("dragUpdate",{x:i.x,y:i.y})})),this.root.addEventListener("mousedown",(()=>{this.root.style.cursor="grabbing",t=!0})),this.root.addEventListener("mouseup",(()=>{this.root.style.cursor="",t=!1})),this.root.addEventListener("mousemove",(i=>{if(t){const t=this.getViewerPosition(i.clientX,i.clientY);e.explorer.emit("dragUpdate",{x:t.x,y:t.y})}}))}}},{model:{tagName:"div",className:"information",children:[{tagName:"div",identifier:"scale"},{tagName:"div",identifier:"coordinates"}]},binding:class extends s{constructor(e){super(e)}onCreated(){const{geneatree:e}=this.properties;this.listen(e,"treeViewerCoordinatesUpdated",(e=>{this.identifier.coordinates.textContent=`${parseInt(e.x)}, ${parseInt(e.y)}`})),this.listen(e,"treeViewerScaleUpdated",(e=>{this.identifier.scale.textContent=`x${parseFloat(e).toFixed(2)}`}))}}}]};class pt extends e{select(){this.root.classList.add("selected")}unselect(){this.root.classList.remove("selected")}update(){for(const e in individual.meta)"gender"===e?(this.identifier.self.classList.remove("unknown","man","woman","other"),this.identifier.self.classList.add(individual.meta[e])):e in this.identifier&&(this.identifier[e].textContent=individual.meta[e]);this.identifier.name.textContent=[individual.meta.firstName,individual.meta.lastName].join(" "),this.identifier.birth.textContent=(individual.meta.birthDate||individual.meta.birthPlace)&&`° ${individual.meta.birthDate||"???"} (${individual.meta.birthPlace||"???"}`,this.identifier.death.textContent=(individual.meta.deathDate||individual.meta.deathPlace)&&`+ ${individual.meta.deathDate||"???"} (${individual.meta.deathPlace||"???"}`}remove(){this.properties.tree.selectedIndividual===individual&&this.properties.tree.individuals.filter((e=>e!==individual)).forEach((e=>e.emit("nodeShow"))),this.root.remove()}nodeRemove(){this.root.remove()}nodeShow(){this.root.style.visibility=""}nodeHide(){this.root.style.visibility="hidden"}nodeFocus(){this.identifier.self.focus()}nodeAnimate(){let e=100;this.root.style.filter=`sepia(${e}%)`;for(let t=0;t<40;t++)setTimeout((()=>{e-=2.5,this.root.style.filter=`sepia(${e}%)`}),50*t)}}let ut=class extends s{constructor(e){super(e,new pt(e.individual))}onCreated(){const{geneatree:e,individual:t,tree:i}=this.properties;this.identifier.self.addEventListener("click",(()=>{i.selectedIndividual===t?e.router.emit("browse",{path:"/tree/individual",properties:{individual:t}}):e.individuals.emit("select",t)})),this.identifier.addParent.addEventListener("click",(()=>e.router.emit("browse",{path:"/tree/add-parent",properties:{tree:i,individual:i.selectedIndividual}}))),this.identifier.addSpouse.addEventListener("click",(()=>e.router.emit("browse",{path:"/tree/add-spouse",properties:{tree:i,individual:i.selectedIndividual}}))),this.identifier.addChild.addEventListener("click",(()=>e.router.emit("browse",{path:"/tree/add-child",properties:{tree:i,individual:i.selectedIndividual}})))}async onRendered(){const{geneatree:e,individual:t,tree:i}=this.properties;this.listen(t,"nodeCenter",(()=>{const t=this.root.getBoundingClientRect(),s=Math.abs(i.viewer.x-t.x),n=Math.abs(i.viewer.y-t.y);e.emit("treeViewerFocus",{x:s,y:n})}))}};var mt={tagName:"div",id:"tree-viewer-individuals",style:"position: absolute",children:[{tagName:"div",identifier:"focusOne",tabIndex:0},{model:{tagName:"div"},binding:class extends s{onCreated(){const{tree:e}=this.properties;for(const i of e.individuals)this.run({tagName:"div",className:"individual",children:[{tagName:"div",identifier:"self",style:"width: 160px; height: 80px;",className:`self ${(t=i).meta.gender} ${t.meta.decujus?"decujus":""}`,tabIndex:0,children:[{identifier:"birthName",tagName:"h3",style:"font-variant: all-small-caps;",textContent:t.meta.birthName},{tagName:"div",className:"name",identifier:"name",textContent:[t.meta.firstName,t.meta.lastName].join(" ")},{tagName:"div",identifier:"birth",className:"birth",textContent:(t.meta.birthDate||t.meta.birthPlace)&&`° ${t.meta.birthDate||"???"} (${t.meta.birthPlace||"???"})`},{tagName:"div",identifier:"death",className:"death",textContent:(t.meta.deathDate||t.meta.deathPlace)&&`+ ${t.meta.deathDate||"???"} (${t.meta.deathPlace||"???"})`}]},{tagName:"div",identifier:"addParent",className:"placeholder",style:" width: 160px; height: 80px; grid-row: 1;",textContent:"Add father"},{tagName:"div",identifier:"addSpouse",className:"placeholder",style:" width: 160px; height: 80px;",textContent:"Add spouse"},{tagName:"div",identifier:"addChild",className:"placeholder",style:" width: 160px; height: 80px;",textContent:"Add child"}]},{binding:new ut({individual:i})});var t;e.individuals[0].emit("nodeCenter")}}},{tagName:"div",identifier:"focusTwo",tabIndex:0}]};class gt extends s{constructor(e){super(e)}}class ft extends e{dragStart(e){const{geneatree:t,tree:i}=this.properties;t.emit("log",{type:u.TYPE.DEBUG,message:"[ui] [viewer] [explorer] drag start"}),i.viewer.dragging.clientX=e.clientX,i.viewer.dragging.clientY=e.clientY,i.viewer.dragging.started=!0}dragUpdate(e){const{geneatree:t}=this.properties;t.emit("log",{type:u.TYPE.DEBUG,message:"[ui] [viewer] [explorer] drag update"}),t.explorer.emit("coordinatesSet",{x:e.x,y:e.y})}dragEnd(){const{geneatree:e,tree:t}=this.properties;e.emit("log",{type:u.TYPE.DEBUG,message:"[ui] [viewer] [explorer] drag end"}),t.viewer.dragging.clientX=null,t.viewer.dragging.clientY=null,t.viewer.dragging.moved=!1,t.viewer.dragging.started=!1}dragReset(){const{geneatree:e,tree:t}=this.properties;e.emit("log",{type:u.TYPE.DEBUG,message:"[ui] [viewer] [explorer] drag reset"}),t.viewer.dragging.clientX=null,t.viewer.dragging.clientY=null,t.viewer.dragging.moved=!1,t.viewer.dragging.started=!1,e.explorer.emit("coordinatesSet",{x:this.root.parentNode.offsetWidth/2,y:this.root.parentNode.offsetHeight/2})}dragToggle(e){const{tree:t}=this.properties;t.viewer.dragging.toggled=e}coordinatesSet(e){const{geneatree:t,tree:i}=this.properties;t.emit("log",{type:u.TYPE.DEBUG,message:"[ui] [viewer] [explorer] coordinatesSet"}),null!==i&&(i.viewer.x=e.x,i.viewer.y=e.y)}zoom(e){const{geneatree:t}=this.properties;t.emit("log",{type:u.TYPE.DEBUG,message:"[ui] [viewer] [explorer] zoom"}),t.explorer.emit("scale set",e)}scaleSet(e){const{geneatree:t,tree:i}=this.properties;t.emit("log",{type:u.TYPE.DEBUG,message:"[ui] [viewer] [explorer] scale set"}),i.viewer.scale=e}scaleReset(){const{geneatree:e}=this.properties;e.emit("log",{type:u.TYPE.DEBUG,message:"[ui] [viewer] [explorer] scale reset"}),e.explorer.emit("scale set",1)}focus(e){const{geneatree:t}=this.properties;t.emit("log",{type:u.TYPE.DEBUG,message:"[ui] [viewer] [explorer] focus"});const i=this.root.getBoundingClientRect();let s=e.x-i.x,n=e.y-i.y;const r=this.root.parentNode.offsetWidth/2-s,a=this.root.parentNode.offsetHeight/2-n;t.explorer.emit("coordinatesSet",{x:r,y:a})}resized(e){const{geneatree:t,tree:i}=this.properties;i.viewer.x=e.width/2,i.viewer.y=e.height/2,t.explorer.emit("coordinatesSet",{x:i.viewer.x,y:i.viewer.y})}boot(){const{geneatree:e,tree:t}=this.properties;e.explorer.emit("coordinatesSet",{x:t.viewer.x,y:t.viewer.y}),e.explorer.emit("scaleSet",t.viewer.scale),e.explorer.emit("booted")}}class vt extends s{constructor(e){super(e,new ft(e.geneatree.explorer))}onCreated(){const{geneatree:e,tree:t}=this.properties;this.root.addEventListener("mousemove",(i=>{if(t.viewer.dragging.started){const{clientX:s,clientY:n}=i,r=Math.abs(s-t.viewer.dragging.clientX),a=Math.abs(n-t.viewer.dragging.clientY);let d=parseInt(t.viewer.x)||0,o=parseInt(t.viewer.y)||0;s>t.viewer.dragging.clientX?d+=r:s<t.viewer.dragging.clientX&&(d-=r),n>t.viewer.dragging.clientY?o+=a:n<t.viewer.dragging.clientY&&(o-=a),t.viewer.dragging.clientX=i.clientX,t.viewer.dragging.clientY=i.clientY,t.viewer.dragging.moved=!0,e.explorer.emit("dragUpdate",{x:d,y:o})}})),this.root.addEventListener("resize",(()=>{t.individuals.length>=1&&e.explorer.emit("dragReset")})),this.root.addEventListener("mouseup",(i=>{null!==t&&(1===i.button?(e.explorer.emit("dragReset"),e.explorer.emit("scaleReset")):0!==i.button||t.viewer.dragging.moved||null===t.selectedIndividual||i.target!==this.root||e.individuals.emit("unselect",t.selectedIndividual)),t.viewer.dragging.started&&e.explorer.emit("dragEnd")})),this.root.addEventListener("mousedown",(i=>{0===i.button&&t.individuals.length>=1&&(i.target.contains(this.root)||i.target.contains(this.root))&&t.viewer.dragging.toggled&&e.explorer.emit("dragStart",{clientX:i.clientX,clientY:i.clientY})})),this.root.addEventListener("wheel",(i=>{const s=Math.sign(i.deltaY);if(t.individuals.length>=1){let i=t.viewer.scale+-.05*s;i=Math.min(Math.max(.125,i),4),e.explorer.emit("zoom",i)}}))}}class Nt extends e{select(e){this.properties.geneatree.emit("log",{type:u.TYPE.DEBUG,message:"[ui] individualSelect",data:e}),null!==this.properties.tree.selectedIndividual&&this.properties.geneatree.individuals.emit("unselect",this.properties.tree.selectedIndividual),this.properties.tree.selectedIndividual=e,e.emit("select"),this.properties.tree.individuals.filter((t=>t!==e)).forEach((e=>e.emit("nodeHide"))),this.properties.geneatree.explorer.emit("dragToggle",!1),this.properties.geneatree.individuals.emit("selected",e)}unselect(e){this.properties.geneatree.emit("log",{type:u.TYPE.DEBUG,message:"[ui] unselect",data:e}),e.tree.selectedIndividual=null,e.emit("unselect"),e.tree.individuals.filter((t=>t!==e)).forEach((e=>e.emit("nodeShow"))),this.properties.geneatree.explorer.emit("dragToggle",!0),this.properties.geneatree.individuals.emit("unselected",e)}update(e){this.properties.geneatree.emit("log",{type:u.TYPE.DEBUG,message:"[ui] individualUpdate",data:e}),e.individual.update(e.form),e.individual.emit("update"),this.properties.geneatree.individuals.emit("updated",e)}remove(e){this.properties.geneatree.emit("log",{type:u.TYPE.DEBUG,message:"[ui] individualRemove",data:e}),e.tree.removeIndividual(e),e.emit("remove"),0===e.tree.individuals.length&&(this.root.style.cursor="",this.properties.geneatree.explorer.emit("dragReset")),this.properties.geneatree.individuals.emit("removed",e)}notesAdd(e){console.log(e),this.properties.geneatree.emit("log",{type:u.TYPE.DEBUG,message:"[ui] individualNotesAdd",data:e});const{title:t,content:i,author:s}=e.form,n=e.individual.addNote(t,i,s,new Date);this.properties.geneatree.individuals.emit("notesAdded",n)}notesUpdate(e){this.properties.geneatree.emit("log",{type:u.TYPE.DEBUG,message:"[ui] individualNotesUpdate",data:e}),e.note.update(e.form),e.note.emit("update"),this.properties.geneatree.individuals.emit("notesUpdated",e)}notesRemove(e){this.properties.geneatree.emit("log",{type:u.TYPE.DEBUG,message:"[ui] individualNotesRemove ",data:e}),e.individual.removeNote(e),e.emit("remove"),this.properties.geneatree.individuals.emit("notesRemoved",e)}}class yt extends s{constructor(e){super(e,new Nt(e.geneatree.individuals))}onCreated(){const{geneatree:e,tree:t}=this.properties;this.listen(e.explorer,"booted",(e=>{t.individuals[0].emit("nodeAnimate")})),this.listen(e.explorer,"coordinatesSet",(e=>{this.root.style.left=e.x+"px",this.root.style.top=e.y+"px"})),this.listen(e.explorer,"scaleSet",(e=>{this.root.style.transform=`scale(${e})`})),this.identifier.focusOne.addEventListener("focus",(()=>{null!==t&&t.individuals.length>=1&&t.individuals[t.individuals.length-1].emit("nodeFocus")})),this.identifier.focusTwo.addEventListener("focus",(()=>{null!==t&&t.individuals.length>=1&&t.individuals[0].emit("nodeFocus")}))}}var wt=e=>({tagName:"div",style:"height: 100%",id:"tree-viewer",children:[{model:dt,binding:vt},{model:mt,binding:yt},...[e.geneatree.settings.minimap&&{model:ht,binding:gt}].filter(Boolean)]}),bt=e=>({tagName:"div",id:"tree-viewer-placeholder",children:[{tagName:"div",className:"body",children:[{tagName:"div",style:"display: grid; grid-gap: 5px",children:[{tagName:"p",style:"text-align: center; color: white; padding: 15px 0;",innerHTML:"Welcome to <b>geneatree</b>",children:[{tagName:"p",style:"text-align: center; color: white; padding: 15px 0px;",innerHTML:"Select an existing tree via the sidebar"},{tagName:"p",textContent:"OR"}]},{tagName:"button",identifier:"createButton",tabIndex:1,textContent:"Create a new tree"},{tagName:"button",identifier:"importButton",tabIndex:2,textContent:"Import existing tree"}]}]}]});class xt extends s{}var Et={tagName:"div",style:"display: grid; grid-gap: 5px; background-color: #b29e9e; padding: 10px;",children:[{tagName:"button",type:"button",className:"button-danger",identifier:"deleteOfflineData",textContent:"🗑️ Vider la base de donnée locale"}]};const _t=["offline","minimap","osd"];class It extends s{onCreated(){const{geneatree:e}=this.properties;this.identifier.deleteOfflineData.addEventListener("click",(()=>{e.emit("persistenceIndexeddbClear")}))}}class Ct extends Z{constructor(e){super({...e,form:new Q})}onCreated(){super.onCreated();const{geneatree:e}=this.properties;this.listen(this.properties.form,"submitted",(t=>{e.emit("settingsSet",t),e.emit("osdSet",{text:"Settings updated",type:"valid"})})),this.properties.form.emit("load",e.settings)}}class St extends s{onCreated(){this.properties;const e=new Ue([new De("General",J({tagName:"div",style:"display: contents",children:[...Object.keys(Pi.SETTINGS).filter((e=>_t.includes(e))).map((e=>({tagName:"label",textContent:`${e}:`,children:[{tagName:"div",children:[{tagName:"select",style:"width: 100%",identifier:e,children:[{tagName:"option",value:!0,textContent:"Activée"},{tagName:"option",value:!1,textContent:"Désactivée"}]}]}]}))),{tagName:"label",textContent:"theme:",children:[{tagName:"div",children:[{tagName:"select",style:"width: 100%",identifier:"theme",children:P.map((e=>({tagName:"option",value:e,textContent:e})))}]}]}]}),Ct),new De("Actions",Et,It)]);this.run(Te,{binding:new Me({tabs:e}),parentNode:this.root}),e.emit("tabSet","General")}}var At=J(se({title:"Enfant"}));class Tt extends Z{constructor(e){super({...e,form:new Q})}onCreated(){super.onCreated(),this.listen(this.properties.step,"set",(e=>{this.properties.form.emit("focus")})),this.listen(this.properties.form,"submitted",(e=>this.properties.steps.emit("stepNext",e)))}}var Rt=J({tagName:"div",style:"display: contents",children:[{tagName:"h3",textContent:"Relationship",className:"title"},{tagName:"div",children:[{tagName:"label",children:[{tagName:"input",identifier:"recognized",type:"checkbox",checked:!0},{tagName:"span",textContent:"Cet enfant est reconnu"}]}]},{tagName:"div",children:[{tagName:"label",identifier:"check_adoption",children:[{tagName:"input",identifier:"adopted",type:"checkbox"},{tagName:"span",textContent:"Cet enfant est adopté"}]}]},{tagName:"div",style:"display: none",identifier:"radios_adopted",children:[{tagName:"label",children:[{tagName:"input",type:"radio",identifier:"adopted_simple",name:"adoption",checked:!0},{tagName:"span",textContent:"Adoption simple"}]},{tagName:"label",children:[{tagName:"input",type:"radio",identifier:"adopted_full",name:"adoption"},{tagName:"span",textContent:"Adoption plénière"}]}]}]});class Pt extends Z{constructor(e){super({...e,form:new Q})}onCreated(){super.onCreated(),this.listen(this.properties.step,"set",(e=>{this.properties.form.emit("focus")})),this.listen(this.properties.form,"submitted",(e=>this.properties.steps.emit("stepNext",e))),this.identifier.adopted.addEventListener("change",(e=>{e.target.checked?this.identifier.radios_adopted.style.display="block":this.identifier.radios_adopted.style.display="none"}))}}class Lt extends i{constructor(e){super(),this._id=e,this._networkId=-1,this._offlineId=-1}get id(){return this._id}get networkId(){return this._networkId}set networkId(e){this._networkId=e}get offlineId(){return this._offlineId}set offlineId(e){this._offlineId=e}}class kt extends Lt{static TYPES={BIOLOGICAL:"BIOLOGICAL",MARRIAGE:"MARRIAGE",PACS:"PACS",CONCUBINAGE:"CONCUBINAGE",DIVORCE:"DIVORCE",VEUVAGE:"VEUVAGE"};constructor(e,t,i,s){super(e),this._type=t,this._relationshipIndividual1=i,this._relationshipIndividual2=s,this._meta={startDate:null,endDate:null,place:""}}get type(){return this._type}get relationshipIndividual1(){return this._relationshipIndividual1}get relationshipIndividual2(){return this._relationshipIndividual2}get meta(){return this._meta}}class Ot extends Lt{static ROLES={PARENT:"PARENT",CHILD:"CHILD",SPOUSE:"SPOUSE"};constructor(e,t){super(-1),this._individual=e,this._role=t}get individual(){return this._individual}get role(){return this._role}}class Dt extends s{onCreated(){const{geneatree:e,individual:t,tree:i}=this.properties,s=new z([new $("Individu",At,Tt),new $("Relationship",Rt,Pt)]);this.listen(s,"done",(()=>{const n=i.addIndividual(s.getStepByName("Individu").data),r=new Ot(t,Ot.ROLES.PARENT),a=new Ot(n,Ot.ROLES.CHILD),d=i.addRelationship(kt.TYPES.BIOLOGICAL,r,a);d.meta.recognised=s.getStepByName("Relationship").data.recognised,s.getStepByName("Relationship").data.adopted&&(d.meta.adoptedType=s.getStepByName("Relationship").data.adopted_simple?"simple":"full"),e.trees.emit("relationshipAdded",d)})),this.run(q,{binding:new W({steps:s})}),s.emit("stepSet","Individu")}}var Bt=e=>({tagName:"div",id:"view-add-child"}),Mt=J(se({title:"Parent"}));class Ut extends Z{constructor(e){super({...e,form:new Q})}onCreated(){super.onCreated(),this.listen(this.properties.step,"set",(e=>{this.properties.form.emit("focus")})),this.listen(this.properties.form,"submitted",(e=>this.properties.steps.emit("stepNext",e)))}}var Yt=J({tagName:"div",style:"display: contents",children:[{tagName:"h3",textContent:"Relationship",className:"title"},{tagName:"div",children:[{tagName:"label",children:[{tagName:"input",identifier:"recognised",type:"checkbox",checked:!0},{tagName:"span",textContent:"Cet enfant reconnu"}]}]},{tagName:"div",children:[{tagName:"label",identifier:"check_adoption",children:[{tagName:"input",identifier:"adopted",type:"checkbox"},{tagName:"span",textContent:"Cet enfant adopté"}]}]},{tagName:"div",style:"display: none; grid-template-columns: auto auto; grid-gap: var(--SIZE_MEDIUM);",identifier:"radios_adopted",children:[{tagName:"label",children:[{tagName:"input",type:"radio",identifier:"adopted_simple",name:"adoption",checked:!0},{tagName:"span",textContent:"Adoption simple"}]},{tagName:"label",children:[{tagName:"input",type:"radio",identifier:"adopted_full",name:"adoption"},{tagName:"span",textContent:"Adoption plénière"}]}]}]});class qt extends Z{constructor(e){super({...e,form:new Q})}onCreated(){super.onCreated(),this.listen(this.properties.step,"set",(e=>{this.properties.form.emit("focus")})),this.listen(this.properties.form,"submitted",(e=>this.properties.steps.emit("stepNext",e))),this.identifier.adopted.addEventListener("change",(e=>{e.target.checked?this.identifier.radios_adopted.style.display="grid":this.identifier.radios_adopted.style.display="none"}))}}class Ft extends s{onCreated(){const{geneatree:e,individual:t,tree:i}=this.properties,s=new z([new $("Individu",Mt,Ut),new $("Relationship",Yt,qt)]);this.listen(s,"done",(()=>{const n=i.addIndividual(s.getStepByName("Individu").data),r=new Ot(t,Ot.ROLES.SPOUSE),a=new Ot(n,Ot.ROLES.SPOUSE),d=i.addRelationship(kt.TYPES.MARRIAGE,r,a);d.meta.startDate=s.getStepByName("Relationship").data.relationDate,d.meta.place=s.getStepByName("Relationship").data.relationPlace,e.trees.emit("relationshipAdded",d)})),this.run(q,{binding:new W({steps:s})}),s.emit("stepSet","Individu")}}var Gt=e=>({tagName:"div",id:"view-add-child"});class jt extends s{onCreated(){const{geneatree:e,individual:t,tree:i}=this.properties,s=new z([new $("Individu",Mt,Ut),new $("Relationship",Yt,qt)]);this.listen(s,"done",(()=>{const n=i.addIndividual(s.getStepByName("Individu").data),r=new Ot(t,Ot.ROLES.CHILD),a=new Ot(n,Ot.ROLES.PARENT),d=i.addRelationship(kt.TYPES.BIOLOGICAL,r,a);d.meta.recognised=s.getStepByName("Relationship").data.recognised,s.getStepByName("Relationship").data.adopted&&(d.meta.adoptedType=s.getStepByName("Relationship").data.adopted_simple?"simple":"full"),e.trees.emit("relationshipAdded",d)})),this.run(q,{binding:new W({steps:s})}),s.emit("stepSet","Individu")}}var Ht=e=>({tagName:"div",id:"view-add-parent"}),$t=J(se({title:"Modifier un individu"})),Xt={tagName:"div",className:"tab-notes",style:"display: grid; grid-gap: 20px",children:[{tagName:"h3",identifier:"title",textContent:"Liste des notes"},{tagName:"div",identifier:"body",style:"display: contents"}]},Vt={tagName:"div",className:"tab-relationships",style:"display: grid; grid-gap: 20px",children:[{tagName:"h3",identifier:"title",textContent:"Relationships"},{tagName:"div",identifier:"body"}]};class Wt extends Z{constructor(e){super({...e,form:new Q})}onCreated(){const{geneatree:e,individual:t}=this.properties;super.onCreated(),this.listen(this.properties.tab,"set",(e=>{this.properties.form.emit("load",this.properties.individual.meta),this.properties.form.emit("focus")})),this.listen(this.properties.form,"submitted",(i=>{t.update(i),e.individuals.emit("updated",{individual:t,form:i}),e.emit("osdSet",{text:"Individual updated",type:"valid"}),e.router.emit("browse",{path:"/viewer",properties:{tree:t.tree}})}))}}var zt=e=>({tagName:"div",children:[{tagName:"div",style:"display: grid; grid-gap: 20px;",children:[{tagName:"input",identifier:"searchInput",placeholder:"Filter notes"},{tagName:"div",style:"display: none",identifier:"placeholder",textContent:"No notes were found."},{tagName:"div",className:"grid-gap",style:"display: none",identifier:"list"},{tagName:"button",identifier:"addNote",className:"button4",textContent:"Add note"}]}]}),Jt=e=>({tagName:"div",className:"note",children:[{tagName:"h3",identifier:"title",textContent:e.note.title},{tagName:"div",identifier:"content",textContent:e.note.content},{tagName:"div",identifier:"author",textContent:`${e.note.author}`},{tagName:"div",textContent:` ${e.note.date.toLocaleDateString("fr-FR",{weekday:"long",year:"numeric",month:"long",day:"numeric"})}`},{tagName:"div",className:"actions",children:[{tagName:"button",textContent:"Editer",className:"button4",identifier:"edit"},{tagName:"button",textContent:"X",className:"button-danger",identifier:"remove"}]}]});class Kt extends Qe{onCreated(){super.onCreated(this.properties);const{geneatree:e,individual:t,note:i,page:s,router:n}=this.properties;this.identifier.edit.addEventListener("click",(()=>n.emit("browse",{path:"/edit",properties:{note:i}}))),this.identifier.remove.addEventListener("click",(()=>{t.removeNote(i),i.emit("remove"),this.properties.geneatree.individuals.emit("notesRemoved",i),e.emit("osdSet",{text:"Note removed",type:"valid"})}))}}class Zt extends s{onCreated(){this.paginator=new et(3),this.identifier.searchInput.addEventListener("input",(()=>this.render())),this.identifier.addNote.addEventListener("click",(()=>{this.properties.router.emit("browse",{path:"/add"})})),this.listen(this.properties.geneatree.individuals,"notesRemoved",(()=>this.render())),this.run(ze,{parentNode:this.identifier.list,binding:new Ze({paginator:this.paginator,maxShownPages:3})}),this.render()}render(){const e=this.properties.individual.findNotes(this.identifier.searchInput.value);0===e.length?(this.identifier.placeholder.style.display="",this.identifier.list.style.display="none"):(this.identifier.placeholder.style.display="none",this.identifier.list.style.display="grid",this.paginator.emit("itemsSet",e.map((e=>({model:Jt,binding:Kt,properties:{note:e}})))))}}var Qt=e=>J({tagName:"div",style:"display: contents",children:[{tagName:"div",children:[{tagName:"label",textContent:"Title:",children:[{tagName:"div",children:[{tagName:"input",className:"width-100",identifier:"title"}]}]}]},{tagName:"div",children:[{tagName:"label",textContent:"Content:",children:[{tagName:"div",children:[{tagName:"textarea",className:"width-100",identifier:"content"}]}]}]},{tagName:"div",children:[{tagName:"label",textContent:"Auteur:",children:[{tagName:"div",children:[{tagName:"input",className:"width-100",identifier:"author"}]}]}]}]});class ei extends Z{constructor(e){super({...e,form:new Q})}onCreated(){super.onCreated();const{geneatree:e,form:t,router:i,individual:s}=this.properties;this.listen(t,"submitted",(t=>{const n=s.addNote(t.title,t.content,t.author,new Date);e.individuals.emit("notesAdded",n),i.emit("browse",{path:"/"}),e.emit("osdSet",{text:"Note added",type:"valid"})}))}}var ti=e=>J({tagName:"div",style:"display: contents",children:[{tagName:"div",children:[{tagName:"label",textContent:"Title:",children:[{tagName:"div",children:[{tagName:"input",className:"width-100",identifier:"title",value:e.note.title}]}]}]},{tagName:"div",children:[{tagName:"label",textContent:"Content:",children:[{tagName:"div",children:[{tagName:"textarea",className:"width-100",identifier:"content",value:e.note.content}]}]}]},{tagName:"div",children:[{tagName:"label",textContent:"Auteur:",children:[{tagName:"div",children:[{tagName:"input",className:"width-100",identifier:"author",value:e.note.author}]}]}]}]});class ii extends Z{constructor(e){super({...e,form:new Q})}onCreated(){super.onCreated();const{geneatree:e,form:t,router:i}=this.properties;this.listen(t,"submitted",(t=>{this.properties.note.update(t),e.individuals.emit("notesUpdated",{note:this.properties.note,form:t}),i.emit("browse",{path:"/"}),e.emit("osdSet",{text:"Note updated",type:"valid"})}))}}class si extends s{onCreated(){const{geneatree:e,tab:t}=this.properties,i=new I({routes:[new x({match:"/",model:new a(zt,Zt)}),new x({match:"/add",model:new a(Qt,ei)}),new x({match:"/edit",model:new a(ti,ii)})]});this.listen(t,"set",(()=>{i.emit("browse",{path:"/"})})),this.run(y,{binding:new T({router:i}),parentNode:this.identifier.body})}}class ni extends s{onCreated(){const{geneatree:e,tab:t,individual:i}=this.properties,s=new Q;this.listen(s,"submitted",(e=>{console.log(e)})),this.listen(e.individuals,"selected",(e=>{this.identifier.delete.disabled=e.meta.decujus})),this.identifier.delete.addEventListener("click",(()=>e.individuals.emit("remove",i)))}}var ri=e=>({tagName:"div",identifier:"view-list",children:[{tagName:"div",style:"display: grid; grid-gap: 20px;",children:[{tagName:"input",identifier:"searchInput",placeholder:"Filter relationships"},{tagName:"div",style:"display: none",identifier:"placeholder",textContent:"No relationships were found."},{tagName:"div",className:"grid-gap",style:"display: none",identifier:"list"}]}]});class ai extends s{onCreated(){this.paginator=new et(3),this.identifier.searchInput.addEventListener("input",(()=>this.render())),this.listen(this.properties.geneatree.individuals,"relationshipsRemoved",(()=>this.render())),this.run(ze,{parentNode:this.identifier.list,binding:new Ze({paginator:this.paginator,maxShownPages:3})}),this.render()}render(){this.identifier.placeholder.style.display=""}}class di extends s{onCreated(){const{geneatree:e,tab:t}=this.properties,i=new I({routes:[new x({match:"/",model:new a(ri,ai)})]});this.listen(t,"set",(()=>{i.emit("browse",{path:"/"})})),this.run(y,{binding:new T({router:i}),parentNode:this.identifier.body})}}class oi extends s{remove(){this.properties.individual.tree.selectedIndividual=null,super.remove()}onCreated(){const{geneatree:e}=this.properties,t=new Ue([new De("Editer",$t,Wt),new De("Notes",Xt,si),new De("Relations",Vt,di),new De("Actions",(i=this.properties.individual,{tagName:"div",className:"tab-actions",style:"display: grid; grid-gap: 20px",children:[{tagName:"div",className:"title",style:"display: grid; grid-template-columns: auto 1fr; grid-auto-columns: max-content;",children:[{tagName:"h3",identifier:"title",textContent:"Actions"}]},{tagName:"div",style:"display: grid; grid-gap: 5px; background-color: #b29e9e; padding: 10px;",children:[{tagName:"button",className:"button-danger",identifier:"delete",disabled:i.meta.decujus,textContent:"Supprimer"}]}]}),ni)]);var i;this.listen(e.individuals,"removed",(t=>{e.individuals.emit("unselect",t)})),this.run(Te,{binding:new Me({tabs:t})}),t.emit("tabSet","Editer")}}var li=e=>({tagName:"div",id:"view-individual"}),ci=e=>({tagName:"div",identifier:"view-list",children:[{tagName:"div",style:"display: grid; grid-gap: 10px;",children:[{tagName:"input",identifier:"searchInput",placeholder:"Filtrer les logs"},{tagName:"div",style:"display: grid;grid-template-columns: 1fr auto auto; grid-gap: 10px; padding: 10px 0;",children:[{tagName:"div",style:"justify-content: center;display: grid;grid-auto-flow: column; grid-gap: 15px;",identifier:"types",children:[...Object.keys(u.TYPE).map((e=>({tagName:"label",children:[{tagName:"input",type:"checkbox",identifier:`type-${u.TYPE[e].toLowerCase()}`,name:"type",checked:u.TYPE[e]!==u.TYPE.DEBUG},{tagName:"span",textContent:u.TYPE[e]}]})))]},{tagName:"button",identifier:"clearButton",className:"button-danger",textContent:"Vider"},{tagName:"button",identifier:"exportButton",className:"button4",textContent:"Exporter"}]}]},{tagName:"div",style:"display: none",identifier:"placeholder",textContent:"Aucun log n'a pu être trouvé."},{tagName:"div",className:"grid-gap",style:"display: none",identifier:"list"}]}),hi=e=>J({tagName:"div",style:"display: contents",children:[{tagName:"label",textContent:"Depuis",children:[{tagName:"div",children:[{tagName:"input",type:"date",style:"width: 100%",identifier:"from"}]}]},{tagName:"label",textContent:"Jusqu'a",children:[{tagName:"div",children:[{tagName:"input",type:"date",style:"width: 100%",identifier:"to"}]}]},{tagName:"label",textContent:"Format",children:[{tagName:"div",children:[{tagName:"select",style:"width: 100%",identifier:"format",children:k.map((e=>({tagName:"option",textContent:e})))}]}]}]}),pi=e=>({tagName:"div",className:"log",children:[{tagName:"span",style:"text-decoration: underline",textContent:e.log.type},{tagName:"span",title:e.log.date,textContent:`${e.log.date.toLocaleTimeString("fr-FR")}:${e.log.date.getMilliseconds()} ${e.log.date.toLocaleDateString("fr-FR",{day:"numeric",month:"numeric"})}`},{tagName:"span",style:"word-break: break-all;",textContent:e.log.message}]});class ui extends Qe{onCreated(){super.onCreated(this.properties),this.properties}}let mi=class extends s{render(e){if(e.length>=1){this.identifier.list.style.display="",this.identifier.placeholder.style.display="none";const t=e.slice().sort(((e,t)=>e.date-t.date));t.reverse();const i=t.map((e=>({properties:{log:e},model:pi,binding:ui})));this.paginator.emit("itemsSet",i)}else this.identifier.list.style.display="none",this.identifier.placeholder.style.display=""}onCreated(){const{geneatree:e,router:t}=this.properties,i={};this.paginator=new et(8),this.identifier.exportButton.addEventListener("click",(()=>{t.emit("browse",{path:"/export"})})),this.identifier.clearButton.addEventListener("click",(()=>{e.emit("logs clear");const t=e.findLogs({query:event.target.value,types:i});this.render(t)})),this.identifier.searchInput.addEventListener("input",(t=>{const s=e.findLogs({query:t.target.value,types:i});this.render(s)})),this.identifier.types.addEventListener("change",(()=>{for(const e of Object.keys(u.TYPE))i[u.TYPE[e]]=this.identifier[`type-${u.TYPE[e].toLowerCase()}`].checked;const t=e.findLogs({query:this.identifier.searchInput.value,types:i});this.render(t)})),this.run(ze,{parentNode:this.identifier.list,binding:new Ze({paginator:this.paginator,maxShownPages:5})});for(const e of Object.keys(u.TYPE))i[u.TYPE[e]]=this.identifier[`type-${u.TYPE[e].toLowerCase()}`].checked;const s=e.findLogs({query:this.identifier.searchInput.value,types:i});this.render(s)}};class gi extends Z{constructor(e){super({...e,form:new Q})}onCreated(){super.onCreated();const{geneatree:e}=this.properties;this.listen(this.properties.form,"submitted",(t=>{const i=e.logs.map((e=>({message:e.message,data:e.data,type:e.type,date:e.date}))),s=new Blob([JSON.stringify(i)],{type:"application/json"}),n=new FileReader,r=document.createElement("a"),a=new Date;r.download=`geneatree-logs-${a.getDate()}-${a.getMonth()+1}-${a.getFullYear()}-${a.getHours()}-${a.getMinutes()}-${a.getSeconds()}.json`,n.onload=function(e){r.href=e.target.result,r.click()},n.onerror=t=>{e.emit("log",{message:"Failed to read logs Blob",type:u.TYPE.ERROR,data:t})},n.readAsDataURL(s)}))}}class fi extends s{onCreated(){this.properties;const e=new I({routes:[new x({match:"/",model:new a(ci,mi)}),new x({match:"/export",model:new a(hi,gi)})]});this.run(y,{binding:new T({router:e}),parentNode:this.identifier.router})}}class vi extends s{async onRendered(){const e=new ResizeObserver((()=>{const{width:e,height:s}=this.root.getBoundingClientRect();t.viewer.width=e,t.viewer.height=s,i.explorer.emit("resized",{width:e,height:s})}));e.observe(this.root);const{tree:t,geneatree:i}=this.properties,{width:s,height:n}=this.root.getBoundingClientRect();this.properties.tree.viewer.width=s,this.properties.tree.viewer.height=n,0!==t.viewer.x&&0!==t.viewer.y||(t.viewer.x=t.viewer.width/2,t.viewer.y=t.viewer.height/2),i.explorer.emit("boot")}}class Ni extends s{constructor(e){super(e)}onCreated(){const{geneatree:e}=this.properties;this.identifier.createButton.addEventListener("click",(()=>{e.router.emit("browse",{path:"/tree/add"})})),this.identifier.importButton.addEventListener("click",(()=>{e.router.emit("browse",{path:"/tree/import"})}))}}class yi extends i{constructor(){super()}}class wi{static AXIS={VERTICAL:"AXIS_VERTICAL",HORIZONTAL:"AXIS_HORIZONTAL",DIAGONAL_LEFT:"AXIS_DIAGONAL_LEFT",DIAGONAL_RIGHT:"AXIS_DIAGONAL_RIGHT"};static DIRECTION={FORWARD:"DIRECTION_FORWARD",BACKWARD:"DIRECTION_BACKWARD"};constructor(e,t){this._axis=e,this._direction=t}get axis(){return this._axis}get direction(){return this._direction}}class bi{constructor(e,t){this._x=e,this._y=t,this._row=null,this._neighbors=[],this._data=null}getRelativePosition(e){return this.x===e.x&&this.y-1===e.y?new wi(wi.AXIS.VERTICAL,wi.DIRECTION.BACKWARD):this.x===e.x&&this.y+1===e.y?new wi(wi.AXIS.VERTICAL,wi.DIRECTION.FORWARD):this.x-1===e.x&&this.y===e.y?new wi(wi.AXIS.HORIZONTAL,wi.DIRECTION.BACKWARD):this.x+1===e.x&&this.y===e.y?new wi(wi.AXIS.HORIZONTAL,wi.DIRECTION.FORWARD):this.x-1===e.x&&this.y-1===e.y?new wi(wi.AXIS.DIAGONAL_RIGHT,wi.DIRECTION.BACKWARD):this.x+1===e.x&&this.y+1===e.y?new wi(wi.AXIS.DIAGONAL_RIGHT,wi.DIRECTION.FORWARD):this.x-1===e.x&&this.y+1===e.y?new wi(wi.AXIS.DIAGONAL_LEFT,wi.DIRECTION.BACKWARD):this.x+1===e.x&&this.y-1===e.y?new wi(wi.AXIS.DIAGONAL_LEFT,wi.DIRECTION.FORWARD):null}getAxisCells(e,t=[],i=[]){return 0===i.length&&i.push(this),t.push(this),this.neighbors.filter((i=>i.relativePosition.axis===e&&!1===t.includes(i.cell))).forEach((s=>{i.push(s.cell),i.concat(s.cell.getAxisCells(e,t,i))})),i.sort(((e,t)=>e.y<t.y?-1:e.y>t.y?1:e.x<t.x?-1:e.x>t.x?1:0)),i}getNeighborByCell(e){return this.neighbors.find((t=>t.cell===e))}get x(){return this._x}get y(){return this._y}get neighbors(){return this._neighbors}get row(){return this._row}get data(){return this._data}set data(e){this._data=e}}class xi{constructor(e,t){this._cell=e,this._relativePosition=t}get cell(){return this._cell}get relativePosition(){return this._relativePosition}}class Ei{constructor(e){this._x=e,this._cells={}}get x(){return this._x}get cells(){return this._cells}}class _i{constructor(){this._rows={}}addCell(e,t){const i=new bi(e,t);for(const e of this.getCells()){const t=i.getRelativePosition(e);if(t){const s=new xi(e,t);i.neighbors.push(s);const n=e.getRelativePosition(i),r=new xi(i,n);e.neighbors.push(r)}}return this.rows[i.x]||(this.rows[i.x]=new Ei(i.x)),i._row=this.rows[i.x],this.rows[i.x].cells[i.y]=i,i}build(e){for(let t=0;t<e;t++)for(let i=0;i<e;i++)this.addCell(t,i)}getCell(e,t){return this.rows[e].cells[t]}getCells(){return Object.values(this.rows).map((e=>Object.values(e.cells))).flat()}get rows(){return this._rows}}class Ii extends i{constructor(){super(),this._list=[],this._grid=new _i}get list(){return this._list}}class Ci extends Lt{constructor(e,t,i,s,n,r){super(e),this._individual=t,this._title=i,this._content=s,this._author=n,this._date=r}update(e){for(const t in e)this[t]=e[t]}get individual(){return this._individual}get title(){return this._title}set title(e){this._title=e}get content(){return this._content}set content(e){this._content=e}get author(){return this._author}set author(e){this._author=e}get date(){return this._date}set date(e){this._date=e}}class Si extends Lt{constructor(e,t,i){super(e),this._tree=t,this._meta={address:"",birthDate:"",birthName:"",birthPlace:"",cellPhone:"",deathDate:"",deathPlace:"",decujus:!1,firstName:"",gender:"unknown",heir:!1,homePhone:"",lastName:"",mail:"",quota_denominator:"",quota_numerator:"",seisin:!1,...i},this._cell=null,this._notes=[],this._nextNoteId=0}addNote(e,t,i,s){const n=new Ci(this._nextNoteId++,this,e,t,i,s);return this.notes.push(n),n}removeNote(e){this.notes.splice(this.notes.indexOf(e),1)}findNotes(e){const t=e.toLowerCase();return this.notes.filter((e=>e.title.toLowerCase().includes(t)||e.author.toLowerCase().includes(t)||e.content.toLowerCase().includes(t)||new Intl.DateTimeFormat("fr-FR").format(e.date).includes(t)))}update(e){for(const t in e)this.meta[t]=e[t]}get tree(){return this._tree}get notes(){return this._notes}get meta(){return this._meta}get cell(){return this._cell}set cell(e){this._cell=e}}class Ai extends i{constructor(){super(),this._width=0,this._height=0,this._x=0,this._y=0,this._scale=1,this._dragging={clientX:0,toggled:!0,clientY:0,moved:!1,started:!1}}get width(){return this._width}set width(e){this._width=e}get height(){return this._height}set height(e){this._height=e}get x(){return this._x}set x(e){this._x=e}get y(){return this._y}set y(e){this._y=e}get scale(){return this._scale}set scale(e){this._scale=e}get dragging(){return this._dragging}}class Ti extends Lt{constructor(e,t){super(e),this._meta=t,this._individuals=[],this._relationships=[],this._viewer=new Ai,this._selectedIndividual=null,this._nextIndividualId=0,this._nextRelationshipId=0}addIndividual(e){const t=new Si(this._nextIndividualId++,this,e);return this.individuals.push(t),t}removeIndividual(e){e===this.selectedIndividual&&(this.selectedIndividual=null),this.individuals.splice(this.individuals.indexOf(e),1)}findIndividuals(e){const t=e.query.toLowerCase();return this.individuals.filter((i=>(i.meta.birthName.toLowerCase().includes(t)||i.meta.firstName.toLowerCase().concat(i.meta.lastName.toLowerCase()).includes(t)||i.meta.firstName.toLowerCase().includes(t)||i.meta.lastName.toLowerCase().includes(t))&&(!e.alive||""===i.meta.deathDate)))}addRelationship(e,t,i){const s=new kt(this._nextRelationshipId++,e,t,i);return this.relationships.push(s),s}findRelationships(e){return this.relationships.filter((t=>t.relationshipIndividual1.individual===e.individual||t.relationshipIndividual2.individual===e.individual))}get meta(){return this._meta}get individuals(){return this._individuals}get relationships(){return this._relationships}get viewer(){return this._viewer}get selectedIndividual(){return this._selectedIndividual}set selectedIndividual(e){this._selectedIndividual=e}}class Ri extends i{constructor(){super(),this._list=[],this._selected=null,this._toggled=!0,this._nextTreeId=0}add(e){const t=new Ti(this._nextTreeId++,e);return this.list.push(t),t}remove(e){e===this.selected&&(this.selected=null,e.selectedIndividual=null),this.list.splice(this.list.indexOf(e),1)}find(e){const t=e.toLowerCase(),i=this.list.filter((e=>Object.values(e.meta).map((e=>e.toLowerCase())).filter((e=>e.includes(t))).length>=1)),s=this.list.map((t=>({tree:t,results:t.findIndividuals({query:e,alive:!0})}))).filter((e=>e.results.length>=1)).map((e=>e.tree));return i.concat(s).filter(((e,t,i)=>i.indexOf(e)===t))}get list(){return this._list}get selected(){return this._selected}set selected(e){this._selected=e}get toggled(){return this._toggled}set toggled(e){this._toggled=e}}class Pi extends i{static SETTINGS={offline:!1,minimap:!0,osd:!0,theme:"white"};constructor(){super(),this._logs=[],this._socketState="SOCKET_STATE_INITIAL",this._settings={...Pi.SETTINGS},this._explorer=new yi,this._individuals=new Ii,this._trees=new Ri,this._router=new I({routes:[new x({match:"/",model:new a(bt,Ni)}),new x({match:"/viewer",model:new a(wt,vi)}),new x({match:"/logs",model:new a(at,fi)}),new x({match:"/about",model:new a(U,xt)}),new x({match:"/settings",model:new a(Y,St)}),new x({match:"/tree/new",model:new a(oe,le)}),new x({match:"/tree/add",model:new a(de,ae)}),new x({match:"/tree/import",model:new a(Ae,Se)}),new x({match:"/tree",model:new a(rt,nt)}),new x({match:"/tree/add-child",model:new a(Bt,Dt)}),new x({match:"/tree/add-parent",model:new a(Ht,jt)}),new x({match:"/tree/add-spouse",model:new a(Gt,Ft)}),new x({match:"/tree/individual",model:new a(li,oi)})]})}log(e,t,i){const s=new u(e,t,i);return this._logs.push(s),s}findLogs(e){const t=e.query.toLowerCase();return this._logs.filter((i=>i.message.toLowerCase().includes(t)&&(null===e.type&&i.type!==u.TYPE.DEBUG||!0===e.types[i.type])))}get logs(){return this._logs}get trees(){return this._trees}get settings(){return this._settings}set settings(e){this._settings=e}get socketState(){return this._socketState}set socketState(e){this._socketState=e}get grid(){return this._grid}get explorer(){return this._explorer}get individuals(){return this._individuals}get router(){return this._router}}const Li=function(e,t){const i=e.postMessage;if(e.postMessage=function(e,t){return i.call(this,{data:e},t)},e instanceof t)e.addEventListener=e.on,e.removeEventListener=e.off;else{const t={addEventListener:e.addEventListener},i=function(s,n,r){e.addEventListener=t.addEventListener;const a=e.on(s,n);return e.addEventListener=i,a};e.addEventListener=i}return e},ki=new Function("req",'return req("worker_threads").Worker;'),Oi=new Function("req",'return req("events").EventEmitter;');var Di=Object.freeze({__proto__:null,factory:function(e){return function(){const t=new(ki(require))(e,{eval:!0});return t.on("error",(function(e){throw e})),Li(t,Oi(require))}},transform:function(e){return`const nodeWorkerPolyfill = ${Li.toString()};\nglobal.self = nodeWorkerPolyfill(require("worker_threads").parentPort, require("events").EventEmitter);\n`+e}});const Bi=function(e){return e.on=e.addEventListener,e.off=e.removeEventListener,e};var Mi=Object.freeze({__proto__:null,factory:function(e){return function(){const t=function(e){try{return URL.createObjectURL(new Blob([e],{type:"application/javascript"}))}catch(t){const i=new BlobBuilder;return i.append(e),URL.createObjectURL(i.getBlob())}}(e),i=Bi(new Worker(t));i.objURL=t;const s=i.terminate;return i.on=i.addEventListener,i.off=i.removeEventListener,i.terminate=function(){return URL.revokeObjectURL(t),s.call(this)},i}},transform:function(e){return`var browserWorkerPolyFill = ${Bi.toString()};\nbrowserWorkerPolyFill(self);\n`+e}});class Ui{constructor(){this.listeners_=[],this.onmessage=null,this.remote_=null}addEventListener(e,t){"message"===e&&this.listeners_.push(t)}removeEventListener(e,t){if("message"!==e)return;const i=this.listeners_.indexOf(t);-1!==i&&this.listeners_.splice(i,1)}dispatchEvent(e){e&&"message"===e.type&&(this.onmessage&&this.onmessage(e),this.listeners_.forEach((function(t){t(e)})))}postMessage(e){this.remote_&&this.remote_.recv_(e)}recv_(e){const t={data:e};this.onmessage&&this.onmessage(t),this.listeners_.forEach((function(e){e(t)}))}terminate(){this.remote_&&(this.remote_.remote_=null,this.remote_.terminate(),this.remote_=null),this.onmessage=null,this.listeners_.length=0}}Ui.prototype.on=Ui.prototype.addEventListener,Ui.prototype.off=Ui.prototype.removeEventListener;var Yi=Object.freeze({__proto__:null,factory:function(e){return function(){const t=new Ui,i=new Ui;return t.type_="window api",t.remote_=i,i.remote_=t,i.type_="web worker",e(i),t}},transform:function(e){return e}});const qi=function(){try{if(void 0!==require("worker_threads"))return!0}catch(e){return!1}}(),Fi=function(){try{if(void 0!==(window&&window.Worker))return!0}catch(e){return!1}}();let Gi=Yi;qi?Gi=Di:Fi&&(Gi=Mi);const ji=Gi.transform;var Hi=(0,Gi.factory)(ji(function(){const e=[];self.addEventListener("message",(t=>{const{query:i,data:s}=t.data;self.postMessage({query:"log",data:{type:"debug",message:`[persistence:indexeddb-remote] Received query: ${i}`,data:s}});const n=e.filter((e=>e.query===i));n.length>=1?n.forEach((e=>e.callback(s))):self.postMessage({query:"log",data:{type:"debug",message:`[persistence:indexeddb-remote] Unrecognized query: ${i}`}})})),e.push({query:"load",callback:t=>{const i=e.findIndex((e=>"load"===e.query));e.splice(i,1);const s=indexedDB.open(t.databaseName,t.databaseVersion);s.addEventListener("success",(async()=>{const t=s.result;t.addEventListener("versionchange",(e=>{self.postMessage({query:"log",data:{type:"debug",message:"[persistence:indexeddb-remote] database version changed: closing database.."}}),t.close()})),t.addEventListener("close",(e=>{self.postMessage({query:"log",data:{type:"debug",message:"[persistence:indexeddb-remote] connection closed"}})})),(e=>{const{listeners:t,database:i}=e;t.push({query:"clear",callback:()=>{const e=indexedDB.deleteDatabase(i.name);e.addEventListener("success",(e=>{self.postMessage({query:"clearSuccess"})})),e.addEventListener("error",(e=>{self.postMessage({query:"clearError"})}))}})})({worker:self,listeners:e,database:t}),(e=>{const{listeners:t,database:i}=e;t.push({query:"treeAdd",callback:e=>{const{id:t,...s}=e;i.transaction(["trees"],"readwrite").objectStore("trees").add(s).addEventListener("success",(e=>{self.postMessage({query:"treeAdded",data:{id:t,offlineId:e.target.result}})}))}}),t.push({query:"treeUpdate",callback:e=>{i.transaction(["trees"],"readwrite").objectStore("trees").put(e)}}),t.push({query:"treeRemove",callback:e=>{i.transaction(["trees"],"readwrite").objectStore("trees").delete(e.offlineId)}})})({worker:self,listeners:e,database:t}),(e=>{const{listeners:t,database:i}=e;t.push({query:"individualAdd",callback:e=>{const{id:t,...s}=e;i.transaction(["individuals"],"readwrite").objectStore("individuals").add(s).addEventListener("success",(i=>{self.postMessage({query:"individualAdded",data:{id:t,offlineId:i.target.result,tree:e.tree}})}))}}),t.push({query:"individualUpdate",callback:e=>{i.transaction(["individuals"],"readwrite").objectStore("individuals").put(e)}}),t.push({query:"individualRemove",callback:e=>{i.transaction(["individuals"],"readwrite").objectStore("individuals").delete(e.offlineId)}})})({worker:self,listeners:e,database:t}),(e=>{const{listeners:t,database:i}=e;t.push({query:"individualNotesAdd",callback:e=>{i.transaction(["notes"],"readwrite").objectStore("notes").add({individual:e.individual,title:e.title,content:e.content,author:e.author,date:e.date}).addEventListener("success",(t=>{self.postMessage({query:"individualNotesAdded",data:{id:e.id,offlineId:t.target.result,individual:e.individual}})}))}}),t.push({query:"individualNotesUpdate",callback:e=>{i.transaction(["notes"],"readwrite").objectStore("notes").put(e)}}),t.push({query:"individualNotesRemove",callback:e=>{i.transaction(["notes"],"readwrite").objectStore("notes").delete(e.offlineId)}})})({worker:self,listeners:e,database:t}),(e=>{const{listeners:t,database:i}=e;t.push({query:"relationshipAdd",callback:e=>{i.transaction(["relationships"],"readwrite").objectStore("relationships").add({type:e.type,relationshipIndividual1:e.relationshipIndividual1,relationshipIndividual2:e.relationshipIndividual2,meta:e.meta}).addEventListener("success",(t=>{self.postMessage({query:"relationshipAdded",data:{id:e.id,offlineId:t.target.result,relationship:e}})}))}})})({worker:self,listeners:e,database:t});const i=t.transaction(["trees","individuals","notes","relationships"],"readwrite"),n=new Promise(((e,t)=>{const s={},n=Object.values(i.objectStoreNames);for(const[r,a]of n.entries()){const d=i.objectStore(a).getAll();d.addEventListener("success",(t=>{s[t.target.source.name]=t.target.result,r===n.length-1&&e(s)})),d.addEventListener("error",(e=>{t("[persistence:indexeddb-remote] error while retrieving store results",e)}))}})),r=await n;self.postMessage({query:"log",data:{type:"debug",message:"[persistence:indexeddb-remote] stores data retrieved..."}}),self.postMessage({query:"load",data:r})})),s.addEventListener("upgradeneeded",(e=>{self.postMessage({query:"log",data:{type:"debug",message:"[persistence:indexeddb-remote] upgradeneeded"}});const t=e.target.result;t.objectStoreNames.contains("trees")||t.createObjectStore("trees",{autoIncrement:!0,keyPath:"id"}),t.objectStoreNames.contains("individuals")||t.createObjectStore("individuals",{autoIncrement:!0,keyPath:"id"}),t.objectStoreNames.contains("notes")||t.createObjectStore("notes",{autoIncrement:!0,keyPath:"id"}),t.objectStoreNames.contains("relationships")||t.createObjectStore("relationships",{autoIncrement:!0,keyPath:"id"})})),s.addEventListener("error",(e=>{self.postMessage({query:"log",data:{type:"debug",message:"[persistence:indexeddb-remote] An error occured while trying to open the database."}})}))}}),self.postMessage({query:"log",data:{type:"debug",message:"[persistence:indexeddb-remote] Loaded"}})}.toString().replace(/^function.+?{/,"").slice(0,-1))),$i=e=>{const{geneatree:t}=e,i=new Hi;t.emit("osdSet",{text:"Connecting to local persistence layer...",type:"info"}),t.emit("log",{type:u.TYPE.DEBUG,message:"[persistence:indexeddb-local] Module Loaded"});const s=[],n={...e,worker:i,listeners:s};let r=!1;s.push({query:"log",callback:e=>{t.emit("log",e)}}),s.push({query:"load",callback:e=>{const i=s.findIndex((e=>"load"===e.query));s.splice(i,1),r=!0,(e=>{const{geneatree:t,worker:i,listeners:s}=e;t.listen("persistenceIndexeddbClear",(e=>{i.postMessage({query:"clear"})})),s.push({query:"clearSuccess",callback:e=>{t.emit("reboot",{text:"IndexedDB cleared",type:"info"})}}),s.push({query:"clearError",callback:e=>{t.emit("osdSet",{text:"Could not clear IndexedDB",type:"info"})}})})(n),(e=>{const{geneatree:t,worker:i,listeners:s}=e;s.push({query:"treeAdded",callback:e=>{const s=t.trees.list.find((t=>t.id===e.id));s.offlineId=e.offlineId,i.postMessage({query:"individualAdd",data:{id:s.individuals[0].id,tree:s.offlineId,meta:s.individuals[0].meta,cellX:s.individuals[0].cellX,cellY:s.individuals[0].cellY}})}}),t.trees.listen("added",(e=>{-1===e.offlineId&&-1===e.networkId&&i.postMessage({query:"treeAdd",data:{meta:e.meta,id:e.id}})})),t.trees.listen("updated",(e=>{-1!==e.offlineId&&i.postMessage({query:"treeUpdate",data:{id:e.tree.offlineId,meta:e.form}})})),t.trees.listen("removed",(e=>{-1!==e.offlineId&&i.postMessage({query:"treeRemove",data:{offlineId:e.offlineId}})}))})(n),(e=>{const{geneatree:t,worker:i,listeners:s}=e;s.push({query:"individualAdded",callback:e=>{t.trees.list.find((t=>t.offlineId===e.tree)).individuals.find((t=>t.id===e.id)).offlineId=e.offlineId}}),t.individuals.listen("added",(e=>{-1===e.offlineId&&-1===e.networkId&&i.postMessage({query:"individualAdd",data:{id:e.id,tree:e.tree.offlineId,meta:e.meta,cellX:e.cellX,cellY:e.cellY}})})),t.individuals.listen("updated",(e=>{-1!==e.offlineId&&i.postMessage({query:"individualUpdate",data:{id:e.individual.offlineId,tree:e.individual.tree.offlineId,meta:e.form,x:e.individual.cellX,y:e.individual.cellY}})})),t.individuals.listen("removed",(e=>{-1!==e.offlineId&&i.postMessage({query:"individualRemove",data:{offlineId:e.offlineId,tree:e.tree.offlineId}})}))})(n),(e=>{const{geneatree:t,worker:i,listeners:s}=e;s.push({query:"individualNotesAdded",callback:e=>{t.trees.list.find((t=>t.individuals.find((t=>t.offlineId===e.individual)))).individuals.find((t=>t.offlineId===e.individual)).notes.find((t=>t.id===e.id)).offlineId=e.offlineId}}),t.individuals.listen("notesAdded",(e=>{-1===e.offlineId&&-1===e.networkId&&i.postMessage({query:"individualNotesAdd",data:{id:e.id,individual:e.individual.offlineId,title:e.title,content:e.content,author:e.author,date:e.date}})})),t.individuals.listen("notesUpdated",(e=>{-1!==e.offlineId&&i.postMessage({query:"individualNotesUpdate",data:{id:e.note.offlineId,...e.form,individual:e.note.individual.offlineId,date:e.note.date}})})),t.individuals.listen("notesRemoved",(e=>{-1!==e.offlineId&&i.postMessage({query:"individualNotesRemove",data:{offlineId:e.offlineId}})}))})(n),(e=>{const{geneatree:t,worker:i,listeners:s}=e;s.push({query:"relationshipAdded",callback:e=>{t.trees.list.find((t=>t.relationships.find((t=>t.offlineId===e.relationship)))).relationships.find((t=>t.offlineId===e.relationship)).offlineId=e.offlineId}}),t.trees.listen("relationshipAdded",(e=>{-1===e.offlineId&&-1===e.networkId&&(console.log({id:e.id,type:e.type,relationshipIndividual1:e.relationshipIndividual1,relationshipIndividual2:e.relationshipIndividual2,meta:e.meta}),i.postMessage({query:"relationshipAdd",data:{id:e.id,type:e.type,relationshipIndividual1:{role:e.relationshipIndividual1.role,individual:e.relationshipIndividual1.individual.offlineId},relationshipIndividual2:{role:e.relationshipIndividual2.role,individual:e.relationshipIndividual2.individual.offlineId},meta:e.meta}}))}))})(n),t.emit("osdSet",{text:"Connected to local persistence layer",type:"valid"}),t.emit("log",{type:u.TYPE.DEBUG,message:"[persistence:indexeddb-local] data retrieved..."});const a=e.trees.map((t=>(t.individuals=e.individuals.filter((e=>e.tree.toString()===t.id.toString())),t.individuals=t.individuals.map((t=>(t.notes=e.notes.filter((e=>e.individual.toString()===t.id.toString())),t))),t)));for(const e of a)e.individuals[0].offlineId=e.individuals[0].id,t.trees.emit("add",[{id:e.id,type:"offline",meta:e.meta},e.individuals]);t.emit("indexedbdbLoaded")}}),i.addEventListener("message",(e=>{const{query:i,data:n}=e.data;t.emit("log",{type:u.TYPE.DEBUG,message:`[persistence:indexeddb-local] Received query: ${i}`,data:n});const r=s.filter((e=>e.query===i));r.length>=1?r.forEach((e=>e.callback(n))):t.emit("log",{type:u.TYPE.DEBUG,message:`[persistence:indexeddb-local] Unrecognized query: ${i}`})})),i.addEventListener("error",(e=>{t.emit("log",{type:u.TYPE.DEBUG,message:"[persistence:indexeddb-local] An error occured",event:e}),r||t.emit("osdSet",{type:"error",text:"[persistence:indexeddb-local] Unable to retrieve local data"})})),i.postMessage({query:"load",data:{databaseName:window.INDEXEDDB_DATABASE_NAME,databaseVersion:window.INDEXEDDB_DATABASE_VERSION}}),t.emit("log",{type:u.TYPE.DEBUG,message:"[persistence:indexeddb-local] waiting for remote to load..."})};function Xi(e){const t=new Pi,i=new O({geneatree:t});t.listen("log",(e=>{const{message:i=null,type:s=u.TYPE.INFO}=e,n=t.log(i,e.data,s);t.emit("log added",n)})),t.listen("logs clear",(()=>{const e=t.logs.slice();for(const i of e)t.emit("log remove",i)})),t.listen("log remove",(e=>{t.logs.splice(t.logs.indexOf(e)),t.emit("log removed",e)})),t.listen("reboot",(e=>{i.remove(),Xi(e)})),t.emit("log",{message:"Application started"}),r.run(N,{binding:i,parentNode:document.body}),e&&t.emit("osdSet",e),(e=>{const{geneatree:t}=e;t.emit("log",{type:u.TYPE.DEBUG,message:"[persistence:localStorage] Module loaded"}),null!==localStorage.getItem("settings")&&(t.settings=JSON.parse(localStorage.getItem("settings"))),t.listen("settingsSet",(e=>{t.emit("log",{type:u.TYPE.DEBUG,message:"[ui] settingsSet",data:e}),t.settings={...t.settings,...e},localStorage.setItem("settings",JSON.stringify(t.settings)),t.emit("settingsSaved")}))})({geneatree:t}),(e=>{const{geneatree:t}=e;let i=null;t.emit("log",{type:u.TYPE.DEBUG,message:"[persistence:socket] Loaded"});let s=t.settings.offline;s?(t.emit("log",{type:u.TYPE.INFO,message:"Offline mode enabled"}),t.emit("log",{type:u.TYPE.DEBUG,message:"[persistence:socket] Offline mode: Skipping socket"})):i=M(e),t.listen("settingsSaved",(()=>{s&&!t.settings.offline?(t.emit("log",{type:u.TYPE.INFO,message:"Offline mode set to disabled"}),t.emit("log",{type:u.TYPE.DEBUG,message:"[persistence:socket] Offline mode disabled: Connecting..."}),i=M(e)):!s&&t.settings.offline&&(t.emit("log",{type:u.TYPE.INFO,message:"Offline mode set to enabled"}),t.socketState!==B&&t.socketState!==D||(t.emit("log",{type:u.TYPE.DEBUG,message:"[persistence:socket] Offline mode enabled: Closing socket..."}),i.close(1e3))),s=t.settings.offline}))})({geneatree:t}),$i({geneatree:t})}window.addEventListener("load",(function(){Xi()}))}();
